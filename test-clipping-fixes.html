<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Teste Corre√ß√£o Clipping</title>
    <style>
        body {
            background: #0e0f1a;
            color: #e9e9f1;
            font-family: 'Courier New', monospace;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .section {
            background: #1a1b2e;
            border: 1px solid #2a2b3e;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-results {
            background: #0d1421;
            border: 1px solid #1f2b40;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
        }
        .pass {
            color: #51cf66;
            background: #1a3f2a;
            border-left: 4px solid #51cf66;
        }
        .fail {
            color: #ff6b6b;
            background: #3f1a1a;
            border-left: 4px solid #ff6b6b;
        }
        .warning {
            color: #ffd43b;
            background: #3f3a1a;
            border-left: 4px solid #ffd43b;
        }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #357abd;
        }
        .metric-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric-card {
            background: #262738;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #4a90e2;
        }
        .metric-card.problem {
            border-left-color: #ff6b6b;
            background: #3a2626;
        }
        .metric-card.ok {
            border-left-color: #51cf66;
            background: #263a26;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Teste de Corre√ß√£o do Sistema de Clipping</h1>
        <p>Verificando se as corre√ß√µes aplicadas est√£o funcionando corretamente</p>

        <div class="section">
            <h3>üß™ Testes Automatizados</h3>
            <button id="runTests">Executar Testes</button>
            <div id="testResults"></div>
        </div>

        <div class="section">
            <h3>üìä An√°lise em Tempo Real</h3>
            <div id="realTimeResults"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="audio-analyzer.js"></script>
    <script src="audio-analyzer-integration.js"></script>

    <script>
        let analyzer;
        
        async function initAnalyzer() {
            try {
                if (typeof AudioAnalyzer !== 'undefined') {
                    analyzer = new AudioAnalyzer();
                    console.log('‚úÖ AudioAnalyzer inicializado');
                    return true;
                } else {
                    console.error('‚ùå AudioAnalyzer n√£o dispon√≠vel');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erro ao inicializar analyzer:', error);
                return false;
            }
        }

        function createTestAudio(amplitude, frequency = 440, duration = 1) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const sampleRate = 48000;
            const buffer = audioContext.createBuffer(2, sampleRate * duration, sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = buffer.getChannelData(channel);
                for (let i = 0; i < channelData.length; i++) {
                    const t = i / sampleRate;
                    const sample = Math.sin(2 * Math.PI * frequency * t) * amplitude;
                    channelData[i] = Math.max(-1, Math.min(1, sample)); // Hard clipping
                }
            }
            
            return buffer;
        }

        async function runTestCase(testName, audioBuffer, expectedResult) {
            const startTime = performance.now();
            
            try {
                const analysis = await analyzer.analyzeAudioBufferDirect(audioBuffer, testName);
                const endTime = performance.now();
                
                const td = analysis.technicalData;
                const problems = analysis.problems || [];
                
                const hasClippingProblem = problems.some(p => p.type === 'clipping');
                const clipSamples = td.clippingSamples || 0;
                const clipPct = td.clippingPct || 0;
                const peak = td.peak;
                const truePeak = td.truePeakDbtp;
                
                const result = {
                    testName,
                    duration: (endTime - startTime).toFixed(1) + 'ms',
                    passed: hasClippingProblem === expectedResult.shouldDetectClipping,
                    analysis: {
                        peak: peak?.toFixed(3),
                        truePeak: truePeak?.toFixed(3),
                        clipSamples,
                        clipPct: clipPct?.toFixed(4),
                        hasClippingProblem
                    },
                    expectedResult,
                    problems: problems.map(p => `${p.type}: ${p.message}`)
                };
                
                return result;
                
            } catch (error) {
                return {
                    testName,
                    duration: 'ERROR',
                    passed: false,
                    error: error.message,
                    expectedResult
                };
            }
        }

        async function runAllTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<p>üîÑ Executando testes...</p>';
            
            if (!await initAnalyzer()) {
                resultsDiv.innerHTML = '<div class="test-results fail">‚ùå N√£o foi poss√≠vel inicializar o AudioAnalyzer</div>';
                return;
            }

            const tests = [
                {
                    name: '1. √Åudio Normal (sem clipping)',
                    audio: createTestAudio(0.5), // 50% amplitude
                    expected: { shouldDetectClipping: false }
                },
                {
                    name: '2. √Åudio Quase Clipping (-0.5dB)',
                    audio: createTestAudio(0.95), // 95% amplitude ‚âà -0.4dB
                    expected: { shouldDetectClipping: false }
                },
                {
                    name: '3. √Åudio com Clipping Leve (99%)',
                    audio: createTestAudio(0.99), // 99% amplitude ‚âà -0.08dB
                    expected: { shouldDetectClipping: true }
                },
                {
                    name: '4. √Åudio com Clipping Forte (120%)',
                    audio: createTestAudio(1.2), // 120% amplitude - vai clipar
                    expected: { shouldDetectClipping: true }
                },
                {
                    name: '5. √Åudio com Clipping Extremo (150%)',
                    audio: createTestAudio(1.5), // 150% amplitude - vai clipar muito
                    expected: { shouldDetectClipping: true }
                }
            ];

            let passedTests = 0;
            let totalTests = tests.length;
            let results = [];

            for (const test of tests) {
                const result = await runTestCase(test.name, test.audio, test.expected);
                results.push(result);
                if (result.passed) passedTests++;
            }

            // Exibir resultados
            let html = `<h4>üìä Resultados dos Testes (${passedTests}/${totalTests} aprovados)</h4>`;
            
            results.forEach(result => {
                const statusClass = result.passed ? 'pass' : 'fail';
                const statusIcon = result.passed ? '‚úÖ' : '‚ùå';
                
                html += `
                    <div class="test-results ${statusClass}">
                        <strong>${statusIcon} ${result.testName}</strong> (${result.duration})
                        <br>
                        <strong>An√°lise:</strong> Peak: ${result.analysis?.peak}dB, TruePeak: ${result.analysis?.truePeak}dBTP, 
                        Clipping: ${result.analysis?.clipSamples} samples (${result.analysis?.clipPct}%)
                        <br>
                        <strong>Detec√ß√£o:</strong> ${result.analysis?.hasClippingProblem ? 'CLIPPING DETECTADO' : 'Nenhum clipping detectado'}
                        <br>
                        <strong>Esperado:</strong> ${result.expectedResult.shouldDetectClipping ? 'Deveria detectar clipping' : 'N√£o deveria detectar clipping'}
                        ${result.analysis?.problems?.length ? '<br><strong>Problemas:</strong> ' + result.analysis.problems.join(', ') : ''}
                        ${result.error ? '<br><strong>Erro:</strong> ' + result.error : ''}
                    </div>
                `;
            });

            // Resumo final
            const overallStatus = passedTests === totalTests ? 'pass' : 'fail';
            const overallIcon = passedTests === totalTests ? 'üéâ' : '‚ö†Ô∏è';
            
            html += `
                <div class="test-results ${overallStatus}">
                    <strong>${overallIcon} Resumo Final:</strong> ${passedTests}/${totalTests} testes aprovados
                    ${passedTests === totalTests ? 
                        '<br>‚úÖ Sistema de detec√ß√£o de clipping funcionando corretamente!' : 
                        '<br>‚ùå Alguns testes falharam. Verifique a implementa√ß√£o.'}
                </div>
            `;

            resultsDiv.innerHTML = html;
            
            // Atualizar an√°lise em tempo real
            updateRealTimeAnalysis(results);
        }

        function updateRealTimeAnalysis(results) {
            const realTimeDiv = document.getElementById('realTimeResults');
            
            let html = '<h4>üìà An√°lise Comparativa</h4>';
            html += '<div class="metric-display">';
            
            results.forEach(result => {
                const isOk = result.passed;
                const cardClass = isOk ? 'ok' : 'problem';
                
                html += `
                    <div class="metric-card ${cardClass}">
                        <h5>${result.testName}</h5>
                        <p><strong>Peak:</strong> ${result.analysis?.peak}dB</p>
                        <p><strong>TruePeak:</strong> ${result.analysis?.truePeak}dBTP</p>
                        <p><strong>Clipping:</strong> ${result.analysis?.clipSamples} samples</p>
                        <p><strong>Status:</strong> ${isOk ? '‚úÖ OK' : '‚ùå FALHA'}</p>
                    </div>
                `;
            });
            
            html += '</div>';
            realTimeDiv.innerHTML = html;
        }

        // Event listeners
        document.getElementById('runTests').addEventListener('click', runAllTests);

        // Auto-executar testes na inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>
