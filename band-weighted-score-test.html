<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 Band Weighted Score V2 - Testes e Validação</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0,0,0,0.3);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        h1 {
            text-align: center;
            color: #00ff88;
            text-shadow: 0 0 20px rgba(0,255,136,0.5);
            margin-bottom: 30px;
        }
        
        .section {
            background: rgba(0,0,0,0.4);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .test-passed {
            background: rgba(0,255,0,0.2);
            border: 1px solid #00ff00;
        }
        
        .test-failed {
            background: rgba(255,0,0,0.2);
            border: 1px solid #ff0000;
        }
        
        .button {
            background: linear-gradient(45deg, #00ff88, #00cc66);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,255,136,0.3);
        }
        
        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .status.enabled {
            background: rgba(0,255,0,0.2);
            border: 2px solid #00ff00;
        }
        
        .status.disabled {
            background: rgba(255,255,0,0.2);
            border: 2px solid #ffff00;
            color: #000;
        }
        
        .score-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .score-box {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .score-number {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .green { color: #00ff00; }
        .yellow { color: #ffff00; }
        .orange { color: #ffa500; }
        .red { color: #ff0000; }
        
        .log-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
            margin: 15px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #00ff88;
        }
        
        .band-visualization {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .band-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 2px solid;
        }
        
        .band-green { border-color: #00ff00; }
        .band-yellow { border-color: #ffff00; }
        .band-orange { border-color: #ffa500; }
        .band-red { border-color: #ff0000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 Band Weighted Score V2</h1>
        <p style="text-align: center; color: #ccc; margin-bottom: 30px;">
            Sistema Inteligente de Correção de Score baseado em Bandas Espectrais
        </p>
        
        <!-- Status do Sistema -->
        <div class="section">
            <h3>🔧 Status do Sistema</h3>
            <div id="system-status" class="status disabled">
                ⏳ Verificando disponibilidade...
            </div>
            <div style="text-align: center;">
                <button class="button" onclick="enableSystem()">✅ Ativar Sistema</button>
                <button class="button" onclick="disableSystem()">🔕 Desativar Sistema</button>
                <button class="button" onclick="checkSystemStatus()">🔄 Verificar Status</button>
            </div>
        </div>
        
        <!-- Testes Automáticos -->
        <div class="section">
            <h3>🧪 Testes Automáticos</h3>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="button" onclick="runAllTests()">🧪 Executar Todos os Testes</button>
                <button class="button" onclick="runQuickTest()">⚡ Teste Rápido</button>
                <button class="button" onclick="clearTestResults()">🧹 Limpar Resultados</button>
            </div>
            <div id="test-results">
                <!-- Resultados dos testes aparecerão aqui -->
            </div>
        </div>
        
        <!-- Simulação Interativa -->
        <div class="section">
            <h3>🎮 Simulação Interativa</h3>
            <div style="margin-bottom: 20px;">
                <label>🎯 Cenário de Teste:</label>
                <select id="test-scenario" style="margin-left: 10px; padding: 5px;">
                    <option value="all-green">🟢 Todas as Bandas Verdes</option>
                    <option value="mixed">🌈 Bandas Mistas</option>
                    <option value="mostly-red">🔴 Principalmente Vermelhas</option>
                    <option value="with-na">⚪ Com Valores N/A</option>
                    <option value="custom">⚙️ Personalizado</option>
                </select>
                <button class="button" onclick="runSimulation()">▶️ Executar Simulação</button>
            </div>
            
            <div id="simulation-results">
                <!-- Resultados da simulação aparecerão aqui -->
            </div>
        </div>
        
        <!-- Estatísticas -->
        <div class="section">
            <h3>📊 Estatísticas de Uso</h3>
            <div class="stats-grid" id="stats-grid">
                <!-- Estatísticas aparecerão aqui -->
            </div>
            <div style="text-align: center;">
                <button class="button" onclick="refreshStats()">🔄 Atualizar</button>
                <button class="button" onclick="clearStats()">🧹 Limpar</button>
            </div>
        </div>
        
        <!-- Console de Debug -->
        <div class="section">
            <h3>🔍 Console de Debug</h3>
            <div style="text-align: center; margin-bottom: 15px;">
                <button class="button" onclick="clearLog()">🧹 Limpar Console</button>
                <button class="button" onclick="downloadLog()">💾 Baixar Log</button>
            </div>
            <div id="debug-console" class="log-output">
                🟢 Console iniciado - aguardando eventos...<br>
            </div>
        </div>
    </div>
    
    <!-- Script Principal -->
    <script src="public/band-weighted-score-v2.js"></script>
    
    <script>
        // 🔧 Utilidades de Interface
        let logBuffer = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                warn: '#ffff00', 
                error: '#ff0000',
                success: '#00ff88'
            };
            
            const logEntry = `<span style="color: #666">[${timestamp}]</span> <span style="color: ${colors[type]}">${message}</span><br>`;
            logBuffer.push(logEntry);
            
            const console = document.getElementById('debug-console');
            console.innerHTML += logEntry;
            console.scrollTop = console.scrollHeight;
            
            // Limitar tamanho do buffer
            if (logBuffer.length > 100) {
                logBuffer = logBuffer.slice(-50);
                refreshConsole();
            }
        }
        
        function clearLog() {
            logBuffer = [];
            document.getElementById('debug-console').innerHTML = '🟢 Console limpo<br>';
        }
        
        function refreshConsole() {
            document.getElementById('debug-console').innerHTML = logBuffer.join('');
        }
        
        function downloadLog() {
            const logText = logBuffer.map(entry => entry.replace(/<[^>]*>/g, '')).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `band-weighted-score-log-${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            
            URL.revokeObjectURL(url);
            log('📁 Log baixado com sucesso', 'success');
        }
        
        // 🔧 Funções de Controle do Sistema
        function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            
            if (typeof window.BAND_WEIGHTED_SCORE_V2_API !== 'undefined') {
                const isEnabled = window.BAND_WEIGHTED_SCORE_V2;
                statusDiv.className = isEnabled ? 'status enabled' : 'status disabled';
                statusDiv.innerHTML = isEnabled ? 
                    '✅ Sistema ATIVO - Correções sendo aplicadas' : 
                    '🔕 Sistema DESABILITADO - Usando métodos originais';
                
                log(`Sistema ${isEnabled ? 'ATIVO' : 'DESABILITADO'}`, isEnabled ? 'success' : 'warn');
            } else {
                statusDiv.className = 'status disabled';
                statusDiv.innerHTML = '❌ Sistema NÃO CARREGADO - Verifique se o script foi carregado corretamente';
                log('❌ API não disponível', 'error');
            }
        }
        
        function enableSystem() {
            if (window.BAND_WEIGHTED_SCORE_V2_API) {
                window.BAND_WEIGHTED_SCORE_V2_API.enable();
                checkSystemStatus();
                log('✅ Sistema habilitado via API', 'success');
            } else {
                log('❌ API não disponível para habilitar', 'error');
            }
        }
        
        function disableSystem() {
            if (window.BAND_WEIGHTED_SCORE_V2_API) {
                window.BAND_WEIGHTED_SCORE_V2_API.disable();
                checkSystemStatus();
                log('🔕 Sistema desabilitado via API', 'warn');
            } else {
                log('❌ API não disponível para desabilitar', 'error');
            }
        }
        
        // 🧪 Funções de Teste
        function runAllTests() {
            if (!window.BAND_WEIGHTED_SCORE_V2_API) {
                log('❌ API não disponível para testes', 'error');
                return;
            }
            
            log('🧪 Iniciando todos os testes...', 'info');
            
            const results = window.BAND_WEIGHTED_SCORE_V2_API.runTests();
            displayTestResults(results);
            
            log(`✅ Testes concluídos: ${results.passed}/${results.total}`, 'success');
        }
        
        function runQuickTest() {
            if (!window.BAND_WEIGHTED_SCORE_V2_API) {
                log('❌ API não disponível para teste rápido', 'error');
                return;
            }
            
            log('⚡ Executando teste rápido...', 'info');
            
            // Teste simples com bandas mistas
            const mockData = {
                bandEnergies: {
                    sub: { rms_db: -15.0 },
                    low: { rms_db: -10.0 },
                    mid: { rms_db: -5.0 },
                    high: { rms_db: -8.0 }
                }
            };
            
            const mockRef = {
                bands: {
                    sub: { target_db: -15.0, tol_db: 2.0 },
                    low: { target_db: -12.0, tol_db: 2.0 },
                    mid: { target_db: -10.0, tol_db: 2.0 },
                    high: { target_db: -8.0, tol_db: 2.0 }
                }
            };
            
            const result = window.BAND_WEIGHTED_SCORE_V2_API.testScore(mockData, mockRef);
            displaySimulationResult(result, 'Teste Rápido');
            
            log(`⚡ Teste rápido concluído: Score ${result?.score}%`, 'success');
        }
        
        function clearTestResults() {
            document.getElementById('test-results').innerHTML = '';
            log('🧹 Resultados de teste limpos', 'info');
        }
        
        function displayTestResults(results) {
            const container = document.getElementById('test-results');
            
            let html = `<div style="margin-bottom: 20px;">
                <strong>📊 Resumo: ${results.passed}/${results.total} testes passaram</strong>
            </div>`;
            
            results.tests.forEach(test => {
                const statusClass = test.passed ? 'test-passed' : 'test-failed';
                const icon = test.passed ? '✅' : '❌';
                
                html += `<div class="test-result ${statusClass}">
                    <strong>${icon} ${test.name}</strong><br>
                    ${test.description}
                    ${test.error ? `<br><span style="color: #ff6666;">Erro: ${test.error}</span>` : ''}
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        // 🎮 Funções de Simulação
        function runSimulation() {
            if (!window.BAND_WEIGHTED_SCORE_V2_API) {
                log('❌ API não disponível para simulação', 'error');
                return;
            }
            
            const scenario = document.getElementById('test-scenario').value;
            log(`🎮 Executando simulação: ${scenario}`, 'info');
            
            const { mockData, mockRef, description } = generateScenario(scenario);
            const result = window.BAND_WEIGHTED_SCORE_V2_API.testScore(mockData, mockRef);
            
            displaySimulationResult(result, description);
            log(`🎮 Simulação concluída: ${description}`, 'success');
        }
        
        function generateScenario(scenario) {
            const scenarios = {
                'all-green': {
                    description: '🟢 Todas as Bandas Verdes',
                    mockData: {
                        bandEnergies: {
                            sub: { rms_db: -15.0 },
                            low: { rms_db: -12.0 },
                            mid: { rms_db: -10.0 },
                            high: { rms_db: -8.0 }
                        }
                    },
                    mockRef: {
                        bands: {
                            sub: { target_db: -15.0, tol_db: 2.0 },
                            low: { target_db: -12.0, tol_db: 2.0 },
                            mid: { target_db: -10.0, tol_db: 2.0 },
                            high: { target_db: -8.0, tol_db: 2.0 }
                        }
                    }
                },
                'mixed': {
                    description: '🌈 Bandas Mistas',
                    mockData: {
                        bandEnergies: {
                            sub: { rms_db: -15.0 },  // verde
                            low: { rms_db: -10.0 },  // amarelo
                            mid: { rms_db: -5.0 },   // vermelho
                            high: { rms_db: -8.0 }   // verde
                        }
                    },
                    mockRef: {
                        bands: {
                            sub: { target_db: -15.0, tol_db: 2.0 },
                            low: { target_db: -12.0, tol_db: 2.0 },
                            mid: { target_db: -10.0, tol_db: 2.0 },
                            high: { target_db: -8.0, tol_db: 2.0 }
                        }
                    }
                },
                'mostly-red': {
                    description: '🔴 Principalmente Vermelhas',
                    mockData: {
                        bandEnergies: {
                            sub: { rms_db: -8.0 },   // vermelho
                            low: { rms_db: -5.0 },   // vermelho
                            mid: { rms_db: -3.0 },   // vermelho
                            high: { rms_db: -8.0 }   // verde
                        }
                    },
                    mockRef: {
                        bands: {
                            sub: { target_db: -15.0, tol_db: 2.0 },
                            low: { target_db: -12.0, tol_db: 2.0 },
                            mid: { target_db: -10.0, tol_db: 2.0 },
                            high: { target_db: -8.0, tol_db: 2.0 }
                        }
                    }
                },
                'with-na': {
                    description: '⚪ Com Valores N/A',
                    mockData: {
                        bandEnergies: {
                            sub: { rms_db: -15.0 },  // verde
                            low: { rms_db: null },   // N/A
                            mid: { rms_db: undefined }, // N/A
                            high: { rms_db: -8.0 }   // verde
                        }
                    },
                    mockRef: {
                        bands: {
                            sub: { target_db: -15.0, tol_db: 2.0 },
                            low: { target_db: -12.0, tol_db: 2.0 },
                            mid: { target_db: -10.0, tol_db: 2.0 },
                            high: { target_db: -8.0, tol_db: 2.0 }
                        }
                    }
                }
            };
            
            return scenarios[scenario] || scenarios['mixed'];
        }
        
        function displaySimulationResult(result, description) {
            if (!result) {
                log('❌ Resultado inválido da simulação', 'error');
                return;
            }
            
            const container = document.getElementById('simulation-results');
            
            const scoreColor = result.score >= 80 ? 'green' : 
                              result.score >= 60 ? 'yellow' : 
                              result.score >= 40 ? 'orange' : 'red';
            
            let html = `
            <div style="background: rgba(0,0,0,0.4); padding: 20px; border-radius: 10px; margin: 15px 0;">
                <h4>${description}</h4>
                
                <div class="score-comparison">
                    <div class="score-box">
                        <div>Score Final</div>
                        <div class="score-number ${scoreColor}">${result.score}%</div>
                        <div>Método: ${result.method}</div>
                    </div>
                    
                    <div class="score-box">
                        <div>Distribuição de Bandas</div>
                        <div style="margin: 10px 0;">
                            🟢 ${result.details?.greenBands || 0} verdes<br>
                            🟡 ${result.details?.yellowBands || 0} amarelas<br>  
                            🔴 ${result.details?.redBands || 0} vermelhas<br>
                            ⚪ ${result.details?.naExcluded || 0} N/A excluídos
                        </div>
                    </div>
                </div>
            `;
            
            if (result.details?.bandResults) {
                html += `<div class="band-visualization">`;
                result.details.bandResults.forEach(band => {
                    const colorClass = `band-${band.status}`;
                    html += `
                    <div class="band-item ${colorClass}">
                        <div><strong>${band.name.toUpperCase()}</strong></div>
                        <div>${band.score.toFixed(1)}%</div>
                        <div style="font-size: 0.8em;">±${band.deviation?.toFixed(1)}dB</div>
                    </div>`;
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }
        
        // 📊 Funções de Estatísticas
        function refreshStats() {
            if (!window.BAND_WEIGHTED_SCORE_V2_API) {
                log('❌ API não disponível para estatísticas', 'error');
                return;
            }
            
            const stats = window.BAND_WEIGHTED_SCORE_V2_API.getStats();
            displayStats(stats);
            log('📊 Estatísticas atualizadas', 'info');
        }
        
        function clearStats() {
            if (!window.BAND_WEIGHTED_SCORE_V2_API) {
                log('❌ API não disponível para limpar estatísticas', 'error');
                return;
            }
            
            window.BAND_WEIGHTED_SCORE_V2_API.clearStats();
            refreshStats();
            log('🧹 Estatísticas limpas', 'info');
        }
        
        function displayStats(stats) {
            const container = document.getElementById('stats-grid');
            
            const statCards = [
                { label: 'Total de Correções', value: stats.totalCorrections, icon: '🎯' },
                { label: 'Bandas Processadas', value: stats.bandsProcessed, icon: '🎵' },
                { label: 'N/A Excluídos', value: stats.naValuesExcluded, icon: '⚪' },
                { label: 'Última Correção', value: stats.lastCorrection ? new Date(stats.lastCorrection).toLocaleTimeString() : 'Nunca', icon: '⏰' }
            ];
            
            let html = '';
            statCards.forEach(card => {
                html += `
                <div class="stat-card">
                    <div style="font-size: 1.2em; margin-bottom: 5px;">${card.icon}</div>
                    <div class="stat-number">${card.value}</div>
                    <div style="font-size: 0.9em; opacity: 0.8;">${card.label}</div>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        // 🚀 Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 Página de testes carregada', 'success');
            
            // Aguardar carregamento do sistema
            setTimeout(() => {
                checkSystemStatus();
                refreshStats();
            }, 1000);
            
            // Atualização automática do status
            setInterval(checkSystemStatus, 5000);
        });
        
        // 🔧 Interceptar logs do console para exibir na interface
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            
            // Capturar logs do sistema BAND_WEIGHTED_SCORE_V2
            const message = args.join(' ');
            if (message.includes('BAND_WEIGHTED_SCORE_V2')) {
                log(message, 'info');
            }
        };
    </script>
</body>
</html>
