<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Teste de Seguran√ßa - Tratamento N/A</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            margin: 20px;
            background: #0a0a0a;
            color: #00ff00;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #00ff00;
        }

        .section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #00ff00;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .test-card {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .test-passed {
            border-left: 4px solid #00ff00;
            background: #0a2a0a;
        }

        .test-failed {
            border-left: 4px solid #ff0000;
            background: #2a0a0a;
        }

        .button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            font-size: 14px;
        }

        .button:hover {
            background: #00cc00;
        }

        .button.danger {
            background: #ff4444;
            color: white;
        }

        .button.danger:hover {
            background: #cc0000;
        }

        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-active {
            background: #ff4444;
            color: white;
        }

        .status-inactive {
            background: #444;
            color: #ccc;
        }

        .status-safe {
            background: #00ff00;
            color: #000;
        }

        .warning-box {
            background: #ffaa00;
            color: #000;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: bold;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
        }

        .na-neutral {
            color: #888 !important;
            font-style: italic;
        }

        .status-good { color: #00ff00; }
        .status-warning { color: #ffaa00; }
        .status-bad { color: #ff4444; }

        .code-sample {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .highlight {
            background: #ffff00;
            color: #000;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Sistema de Seguran√ßa - Tratamento N/A</h1>
            <p>Valida√ß√£o completa e implementa√ß√£o segura da corre√ß√£o de N/A</p>
            <div id="flagStatus">
                <strong>Feature Flag:</strong>
                <span id="flagIndicator" class="status-indicator status-inactive">DESATIVADA</span>
            </div>
        </div>

        <div class="section">
            <h2>üö¶ Controles de Seguran√ßa</h2>
            <div style="text-align: center;">
                <button class="button" onclick="runAllTests()">üß™ Executar Testes Completos</button>
                <button class="button" onclick="toggleFlag()">üö© Alternar Feature Flag</button>
                <button class="button" onclick="generateReport()">üìã Gerar Relat√≥rio</button>
                <button class="button danger" onclick="emergencyRollback()">üÜò Rollback Emergencial</button>
            </div>
            
            <div class="warning-box" id="warningBox" style="display: none;">
                ‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> Feature flag ativada! Monitorar comportamento cuidadosamente.
            </div>
        </div>

        <div class="section">
            <h2>üìä Status dos Testes</h2>
            <div id="testResults" class="test-grid">
                <!-- Testes ser√£o carregados aqui -->
            </div>
        </div>

        <div class="section">
            <h2>üéØ Demonstra√ß√£o Interativa</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h4>Teste 1: Lista Mista</h4>
                    <div class="metric-value" id="test1Result">‚Äî</div>
                    <div>Entrada: [80, NaN, 90]</div>
                    <div>Esperado: 85</div>
                </div>
                <div class="metric-card">
                    <h4>Teste 2: Todos N/A</h4>
                    <div class="metric-value na-neutral" id="test2Result">‚Äî</div>
                    <div>Entrada: [NaN, null, undefined]</div>
                    <div>Esperado: null ‚Üí "‚Äî"</div>
                </div>
                <div class="metric-card">
                    <h4>Teste 3: Score Final</h4>
                    <div class="metric-value" id="test3Result">‚Äî</div>
                    <div>2 v√°lidos + 1 N/A</div>
                    <div>M√©dia s√≥ dos v√°lidos</div>
                </div>
                <div class="metric-card">
                    <h4>Teste 4: UI Coer√™ncia</h4>
                    <div class="metric-value na-neutral" id="test4Result">‚Äî</div>
                    <div>Classe CSS neutra</div>
                    <div>Sem cor de problema</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üõ†Ô∏è Demonstra√ß√£o de Casos</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>Entrada de Teste:</h4>
                    <label>Dynamics:</label>
                    <input type="number" id="dynamicsInput" value="80" step="0.1">
                    <br><br>
                    <label>Technical:</label>
                    <input type="text" id="technicalInput" value="NaN" placeholder="NaN para N/A">
                    <br><br>
                    <label>Loudness:</label>
                    <input type="number" id="loudnessInput" value="90" step="0.1">
                    <br><br>
                    <label>Frequency:</label>
                    <input type="number" id="frequencyInput" value="85" step="0.1">
                    <br><br>
                    <button class="button" onclick="testCustomInput()">üß™ Testar</button>
                </div>
                <div>
                    <h4>Resultado:</h4>
                    <div id="customTestResult" class="console-output">
                        Clique em "Testar" para ver o resultado
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìù Log do Console</h2>
            <div id="consoleLog" class="console-output">
                Console inicializando...
            </div>
            <button class="button" onclick="clearConsole()">üßπ Limpar Console</button>
        </div>

        <div class="section">
            <h2>üìö Documenta√ß√£o R√°pida</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>üîß Comportamento Novo (Flag ON):</h4>
                    <ul>
                        <li>N/A <strong>exclu√≠do</strong> de numerador e denominador</li>
                        <li>Categoria toda N/A ‚Üí retorna null ‚Üí UI mostra "‚Äî"</li>
                        <li>Score final = m√©dia s√≥ dos subscores v√°lidos</li>
                        <li>Classes CSS neutras para N/A</li>
                    </ul>
                </div>
                <div>
                    <h4>üîÑ Comportamento Legado (Flag OFF):</h4>
                    <ul>
                        <li>N/A pode ser tratado como 50 (neutro)</li>
                        <li>Manter compatibilidade com c√≥digo existente</li>
                        <li>Rollback r√°pido se necess√°rio</li>
                        <li>Nenhuma quebra de interface</li>
                    </ul>
                </div>
            </div>

            <div class="code-sample">
                <strong>Exemplo de uso:</strong><br>
                // Ativar feature flag<br>
                window.enableNAExclusion(true);<br><br>
                // Testar lista com N/A<br>
                const result = window.naHandler.calculateMeanExcludingNA([80, NaN, 90]);<br>
                console.log(result); // 85 (m√©dia s√≥ dos v√°lidos)<br><br>
                // Formatar para UI<br>
                const display = window.naHandler.formatForUI(NaN);<br>
                console.log(display); // "‚Äî"
            </div>
        </div>
    </div>

    <script src="na-handler-safe.js"></script>
    <script>
        let consoleOutput = [];
        let originalConsoleLog = console.log;
        let originalConsoleWarn = console.warn;
        let originalConsoleError = console.error;

        // Interceptar console para mostrar na p√°gina
        function interceptConsole() {
            console.log = function(...args) {
                const message = args.join(' ');
                consoleOutput.push(`[LOG] ${message}`);
                updateConsoleDisplay();
                originalConsoleLog.apply(console, args);
            };

            console.warn = function(...args) {
                const message = args.join(' ');
                consoleOutput.push(`[WARN] ${message}`);
                updateConsoleDisplay();
                originalConsoleWarn.apply(console, args);
            };

            console.error = function(...args) {
                const message = args.join(' ');
                consoleOutput.push(`[ERROR] ${message}`);
                updateConsoleDisplay();
                originalConsoleError.apply(console, args);
            };
        }

        function updateConsoleDisplay() {
            const consoleLog = document.getElementById('consoleLog');
            consoleLog.textContent = consoleOutput.slice(-50).join('\n'); // √öltimas 50 linhas
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function clearConsole() {
            consoleOutput = [];
            updateConsoleDisplay();
        }

        function updateFlagStatus() {
            const indicator = document.getElementById('flagIndicator');
            const warningBox = document.getElementById('warningBox');
            
            if (window.naHandler && window.naHandler.flagEnabled) {
                indicator.textContent = 'ATIVADA';
                indicator.className = 'status-indicator status-active';
                warningBox.style.display = 'block';
            } else {
                indicator.textContent = 'DESATIVADA';
                indicator.className = 'status-indicator status-inactive';
                warningBox.style.display = 'none';
            }
        }

        function toggleFlag() {
            if (window.naHandler) {
                const newState = !window.naHandler.flagEnabled;
                window.enableNAExclusion(newState);
                updateFlagStatus();
                
                if (newState) {
                    console.log('üö© Feature flag ATIVADA - Monitorando comportamento...');
                } else {
                    console.log('üö© Feature flag DESATIVADA - Retornando ao comportamento legado');
                }
            }
        }

        function runAllTests() {
            if (!window.naHandler) {
                console.error('‚ùå NAHandlerSafe n√£o carregado!');
                return;
            }

            console.log('\nüöÄ INICIANDO BATERIA COMPLETA DE TESTES...');
            
            const results = window.testNAHandling();
            displayTestResults(results);
            updateDemoMetrics();
        }

        function displayTestResults(results) {
            const container = document.getElementById('testResults');
            container.innerHTML = '';

            results.tests.forEach(test => {
                const card = document.createElement('div');
                card.className = `test-card ${test.passed ? 'test-passed' : 'test-failed'}`;
                
                card.innerHTML = `
                    <h4>${test.passed ? '‚úÖ' : '‚ùå'} ${test.name}</h4>
                    <div><strong>Resultado:</strong> ${JSON.stringify(test.result)}</div>
                    <div><strong>Esperado:</strong> ${JSON.stringify(test.expected)}</div>
                    <div><strong>Status:</strong> ${test.passed ? 'PASSOU' : 'FALHOU'}</div>
                `;
                
                container.appendChild(card);
            });

            // Card de resumo
            const summaryCard = document.createElement('div');
            summaryCard.className = `test-card ${results.safeToActivate ? 'test-passed' : 'test-failed'}`;
            summaryCard.innerHTML = `
                <h4>üìä Resumo Geral</h4>
                <div><strong>Testes:</strong> ${results.passed}/${results.total}</div>
                <div><strong>Seguro:</strong> ${results.safeToActivate ? 'SIM' : 'N√ÉO'}</div>
                <div><strong>Status:</strong> ${results.safeToActivate ? 'APROVADO' : 'REJEI√á√ÉO'}</div>
            `;
            container.appendChild(summaryCard);
        }

        function updateDemoMetrics() {
            if (!window.naHandler) return;

            // Teste 1: Lista mista
            window.naHandler.setFlag(true);
            const test1 = window.naHandler.calculateMeanExcludingNA([80, NaN, 90]);
            document.getElementById('test1Result').textContent = test1 ? test1.toFixed(1) : '‚Äî';

            // Teste 2: Todos N/A
            const test2 = window.naHandler.calculateCategorySubscore([NaN, null, undefined]);
            document.getElementById('test2Result').textContent = window.naHandler.formatForUI(test2);

            // Teste 3: Score final
            const subscores = { dynamics: 80, technical: 90, loudness: null, frequency: 85 };
            const test3 = window.naHandler.calculateFinalScore(subscores);
            document.getElementById('test3Result').textContent = test3 ? test3.toFixed(1) : '‚Äî';

            // Teste 4: UI
            document.getElementById('test4Result').textContent = window.naHandler.formatForUI(NaN);
        }

        function testCustomInput() {
            if (!window.naHandler) {
                document.getElementById('customTestResult').textContent = '‚ùå NAHandlerSafe n√£o carregado!';
                return;
            }

            const dynamics = parseFloat(document.getElementById('dynamicsInput').value) || null;
            const technical = document.getElementById('technicalInput').value === 'NaN' ? NaN : 
                             parseFloat(document.getElementById('technicalInput').value) || null;
            const loudness = parseFloat(document.getElementById('loudnessInput').value) || null;
            const frequency = parseFloat(document.getElementById('frequencyInput').value) || null;

            const subscores = { dynamics, technical, loudness, frequency };

            const flagState = window.naHandler.flagEnabled;
            
            // Testar com flag atual
            const finalScore = window.naHandler.calculateFinalScore(subscores);
            
            const result = `
üîß TESTE PERSONALIZADO
====================

üìä Entrada:
‚Ä¢ Dynamics: ${dynamics === null ? 'N/A' : dynamics}
‚Ä¢ Technical: ${isNaN(technical) ? 'N/A (NaN)' : technical}
‚Ä¢ Loudness: ${loudness === null ? 'N/A' : loudness}
‚Ä¢ Frequency: ${frequency === null ? 'N/A' : frequency}

üö© Feature Flag: ${flagState ? 'ATIVADA' : 'DESATIVADA'}

üìà Resultado:
‚Ä¢ Score Final: ${window.naHandler.formatForUI(finalScore)}
‚Ä¢ Valor Raw: ${finalScore}

üé® UI Display:
‚Ä¢ Dynamics: "${window.naHandler.formatForUI(dynamics)}"
‚Ä¢ Technical: "${window.naHandler.formatForUI(technical)}"
‚Ä¢ Loudness: "${window.naHandler.formatForUI(loudness)}"
‚Ä¢ Frequency: "${window.naHandler.formatForUI(frequency)}"

üéØ Interpreta√ß√£o:
${finalScore === null ? 
  '‚Üí Todos os subscores s√£o N/A ‚Üí Score final N/A' : 
  `‚Üí M√©dia dos subscores v√°lidos: ${finalScore.toFixed(2)}`}
            `;

            document.getElementById('customTestResult').textContent = result;
        }

        function generateReport() {
            if (!window.naHandler) {
                console.error('‚ùå NAHandlerSafe n√£o carregado!');
                return;
            }

            console.log('\nüìã GERANDO RELAT√ìRIO COMPLETO DE SEGURAN√áA...');
            const report = window.generateNASafetyReport();
            
            console.log('\nüíæ Relat√≥rio salvo - dados dispon√≠veis em:', report);
        }

        function emergencyRollback() {
            if (confirm('üÜò ROLLBACK EMERGENCIAL: Desativar feature flag e retornar ao comportamento legado?')) {
                window.enableNAExclusion(false);
                updateFlagStatus();
                console.log('üÜò ROLLBACK EXECUTADO - Sistema retornando ao comportamento legado');
                console.log('üìä Recomenda√ß√£o: Executar testes de regress√£o para validar estabilidade');
            }
        }

        // Inicializa√ß√£o
        window.addEventListener('load', function() {
            interceptConsole();
            updateFlagStatus();
            
            console.log('üõ°Ô∏è Sistema de Seguran√ßa inicializado');
            console.log('üìù Ready para valida√ß√£o completa do tratamento N/A');
            
            // Auto-executar testes iniciais
            setTimeout(() => {
                if (window.naHandler) {
                    runAllTests();
                }
            }, 1000);
        });
    </script>
</body>
</html>
