<!DOCTYPE html>
<html>
<head>
    <title>üö® TESTE PHASE 3: Cache Invalidation</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #00ff00; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border: 1px solid #333; }
        .success { background: #004400; border-color: #00ff00; }
        .error { background: #440000; border-color: #ff0000; color: #ff6666; }
        .info { background: #000044; border-color: #0066ff; color: #6666ff; }
        .warning { background: #444400; border-color: #ffff00; color: #ffff66; }
        pre { background: #333; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üö® TESTE PHASE 3: Cache Invalidation</h1>
    <div id="status">üîÑ Iniciando testes...</div>
    
    <script src="public/audio-analyzer.js"></script>
    <script>
        let statusDiv = document.getElementById('status');
        let logHTML = '';
        
        function log(msg, type = 'info') {
            console.log(msg);
            logHTML += `<div class="status ${type}">${msg}</div>`;
            statusDiv.innerHTML = logHTML;
        }
        
        function logJSON(obj, title) {
            logHTML += `<div class="status info"><strong>${title}:</strong><pre>${JSON.stringify(obj, null, 2)}</pre></div>`;
            statusDiv.innerHTML = logHTML;
        }
        
        async function runPhase3Test() {
            try {
                log('üîÑ Verificando AudioAnalyzer...', 'info');
                
                if (typeof window.audioAnalyzer === 'undefined') {
                    throw new Error('window.audioAnalyzer n√£o foi criado');
                }
                log('‚úÖ AudioAnalyzer carregado com sucesso!', 'success');
                
                // Verificar m√©todos da Phase 3
                const phase3Methods = [
                    '_manageCacheTTL',
                    '_invalidateCacheByType', 
                    '_smartCacheInvalidation',
                    '_monitorCacheHealth'
                ];
                
                for (const method of phase3Methods) {
                    if (typeof window.audioAnalyzer[method] !== 'function') {
                        throw new Error(`M√©todo Phase 3 n√£o encontrado: ${method}`);
                    }
                }
                log(`‚úÖ Todos os 4 m√©todos Phase 3 encontrados: ${phase3Methods.join(', ')}`, 'success');
                
                // Criar dados mock para teste
                log('üß™ Criando dados mock para teste...', 'info');
                
                // Mock do cache de an√°lises
                window.__AUDIO_ANALYSIS_CACHE__ = new Map();
                window.__AUDIO_ANALYSIS_CACHE__.set('test1', { analysis: {}, _ts: Date.now() - 1000000 }); // Antigo
                window.__AUDIO_ANALYSIS_CACHE__.set('test2', { analysis: {}, _ts: Date.now() }); // Novo
                
                // Mock do cache de refer√™ncias
                window.__refDataCache = {
                    funk_mandela: { data: {}, _cacheTimestamp: Date.now() - 2000000 }, // Antigo
                    trance: { data: {}, _cacheTimestamp: Date.now() } // Novo
                };
                
                // Mock localStorage
                localStorage.setItem('prodai_temp_old', JSON.stringify({ data: 'test', _ts: Date.now() - 3000000 }));
                localStorage.setItem('prodai_temp_new', JSON.stringify({ data: 'test', _ts: Date.now() }));
                
                log('‚úÖ Dados mock criados', 'success');
                
                // Teste 1: Cache Health Monitor
                log('üìä Testando monitoramento de sa√∫de do cache...', 'info');
                const healthReport = window.audioAnalyzer._monitorCacheHealth();
                logJSON(healthReport, 'Health Report');
                
                // Teste 2: TTL Management
                log('üïê Testando gerenciamento TTL...', 'info');
                const ttlResult = window.audioAnalyzer._manageCacheTTL();
                logJSON(ttlResult, 'TTL Management Result');
                
                // Teste 3: Invalida√ß√£o por tipo
                log('üéØ Testando invalida√ß√£o por tipo...', 'info');
                const invalidationResult = window.audioAnalyzer._invalidateCacheByType('analysis');
                logJSON(invalidationResult, 'Cache Invalidation Result');
                
                // Teste 4: Smart Invalidation
                log('üß† Testando invalida√ß√£o inteligente...', 'info');
                const smartResult = window.audioAnalyzer._smartCacheInvalidation({
                    maxAnalysisEntries: 1,
                    maxReferenceEntries: 1,
                    aggressiveCleanup: true
                });
                logJSON(smartResult, 'Smart Invalidation Result');
                
                // Teste 5: Health final
                log('üìä Verifica√ß√£o final de sa√∫de...', 'info');
                const finalHealth = window.audioAnalyzer._monitorCacheHealth();
                logJSON(finalHealth, 'Final Health Report');
                
                log('üéâ PHASE 3 - CACHE INVALIDATION: SUCESSO TOTAL!', 'success');
                log('‚úÖ Todas as 3 fases implementadas com seguran√ßa!', 'success');
                log('üöÄ Sistema Memory Management completo e pronto para produ√ß√£o!', 'success');
                
            } catch (error) {
                log(`‚ùå ERRO CR√çTICO: ${error.message}`, 'error');
                log(`‚ùå Stack: ${error.stack}`, 'error');
            }
        }
        
        // Aguardar carregamento
        setTimeout(runPhase3Test, 1000);
    </script>
</body>
</html>
