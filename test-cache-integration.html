<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ TESTE INTEGRA√á√ÉO: Cache Determin√≠stico</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .log { background: #000; padding: 10px; margin: 10px 0; border-left: 3px solid #00ff00; }
        .error { border-color: #ff0000; color: #ff0000; }
        .success { border-color: #00ff00; color: #00ff00; }
        .warning { border-color: #ffaa00; color: #ffaa00; }
        .info { border-color: #0088ff; color: #0088ff; }
        button { background: #333; color: #00ff00; border: 1px solid #555; padding: 10px; margin: 5px; cursor: pointer; }
        button:hover { background: #555; }
        pre { background: #111; padding: 10px; border: 1px solid #333; overflow-x: auto; }
        .status { padding: 10px; margin: 10px 0; border: 1px solid #333; }
        input[type="file"] { background: #333; color: #00ff00; border: 1px solid #555; padding: 5px; }
    </style>
</head>
<body>
    <h1>üîÑ TESTE INTEGRA√á√ÉO: Cache Determin√≠stico</h1>
    <p><strong>Valida√ß√£o completa:</strong> Upload real, cache hits/misses, invalida√ß√£o autom√°tica</p>
    
    <div class="status">
        <h3>üìä Status do Sistema</h3>
        <div id="systemStatus"></div>
    </div>
    
    <div>
        <h3>üéµ Upload de Arquivo de Teste</h3>
        <input type="file" id="audioFile" accept="audio/*">
        <button onclick="analyzeWithCache()">Analisar (com cache)</button>
        <button onclick="analyzeForceNew()">Analisar (for√ßar novo)</button>
    </div>

    <div>
        <h3>üéõÔ∏è Controles de Teste</h3>
        <button onclick="changeGenre('funk')">Mudar ‚Üí Funk</button>
        <button onclick="changeGenre('rock')">Mudar ‚Üí Rock</button>
        <button onclick="changeGenre('eletronico')">Mudar ‚Üí Eletr√¥nico</button>
        <button onclick="simulateRefsUpdate()">Simular Atualiza√ß√£o Refs</button>
        <button onclick="testLegacyMigration()">Testar Migra√ß√£o Legacy</button>
    </div>

    <div>
        <h3>üìà M√©tricas de Cache</h3>
        <button onclick="showCacheMetrics()">Atualizar M√©tricas</button>
        <div id="cacheMetrics"></div>
    </div>

    <div id="results"></div>

    <script src="audio-analyzer.js"></script>
    <script src="refs/embedded-refs.js"></script>
    <script>
        let analyzer = null;
        let analysisCount = 0;
        let cacheMetrics = {
            hits: 0,
            misses: 0,
            invalidations: 0,
            migrations: 0
        };

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(logDiv);
            results.scrollTop = results.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateSystemStatus() {
            const status = {
                analyzer: !!analyzer,
                NEW_CACHE_KEY: window.NEW_CACHE_KEY,
                genre: window.PROD_AI_REF_GENRE,
                refsVersion: window.EMBEDDED_REFS_VERSION,
                cacheSize: window.__AUDIO_ANALYSIS_CACHE__?.size || 0,
                changeMonitor: !!window._cacheChangeMonitor
            };
            
            document.getElementById('systemStatus').innerHTML = `
                <strong>AudioAnalyzer:</strong> ${status.analyzer ? '‚úÖ' : '‚ùå'}<br>
                <strong>NEW_CACHE_KEY:</strong> ${status.NEW_CACHE_KEY ? '‚úÖ' : '‚ùå'}<br>
                <strong>G√™nero Ativo:</strong> ${status.genre || 'N√£o definido'}<br>
                <strong>Vers√£o Refs:</strong> ${status.refsVersion || 'N√£o definido'}<br>
                <strong>Cache Size:</strong> ${status.cacheSize}<br>
                <strong>Change Monitor:</strong> ${status.changeMonitor ? '‚úÖ' : '‚ùå'}
            `;
        }

        async function initializeAnalyzer() {
            try {
                if (!analyzer) {
                    analyzer = new AudioAnalyzer();
                    await analyzer.initializeAnalyzer();
                    log('‚úÖ AudioAnalyzer inicializado', 'success');
                }
                return analyzer;
            } catch (error) {
                log(`‚ùå Erro ao inicializar: ${error.message}`, 'error');
                throw error;
            }
        }

        async function analyzeWithCache() {
            const fileInput = document.getElementById('audioFile');
            if (!fileInput.files[0]) {
                log('‚ö†Ô∏è Selecione um arquivo de √°udio primeiro', 'warning');
                return;
            }

            try {
                await initializeAnalyzer();
                const file = fileInput.files[0];
                
                log(`üéµ Iniciando an√°lise: ${file.name}`, 'info');
                log(`üìä G√™nero: ${window.PROD_AI_REF_GENRE}`, 'info');
                log(`üìö Refs: ${window.EMBEDDED_REFS_VERSION}`, 'info');
                
                const startTime = Date.now();
                
                // Hook nos logs de cache
                const originalCaiarLog = window.__caiarLog;
                window.__caiarLog = function(event, message, data) {
                    if (event.includes('CACHE')) {
                        if (event === 'CACHE_HIT') cacheMetrics.hits++;
                        else if (event === 'CACHE_MISS') cacheMetrics.misses++;
                        else if (event === 'CACHE_INVALIDATE') cacheMetrics.invalidations++;
                        else if (event === 'CACHE_HIT_LEGACY') cacheMetrics.migrations++;
                        
                        log(`üì¶ ${event}: ${message} | Key: ${data?.key || 'N/A'}`, 'info');
                    }
                    if (originalCaiarLog) originalCaiarLog(event, message, data);
                };
                
                const analysis = await analyzer.analyzeAudioFile(file, {
                    runId: `test_${++analysisCount}_${Date.now()}`
                });
                
                const duration = Date.now() - startTime;
                
                log(`‚úÖ An√°lise conclu√≠da em ${duration}ms`, 'success');
                log(`üìä Score: ${analysis.mixScorePct}%`, 'success');
                
                showCacheMetrics();
                updateSystemStatus();
                
            } catch (error) {
                log(`‚ùå Erro na an√°lise: ${error.message}`, 'error');
            }
        }

        async function analyzeForceNew() {
            // Limpar cache antes da an√°lise
            if (window.invalidateAudioAnalysisCache) {
                const result = window.invalidateAudioAnalysisCache();
                log(`üóëÔ∏è Cache limpo: ${result.cleared} entradas`, 'info');
            }
            
            await analyzeWithCache();
        }

        function changeGenre(newGenre) {
            const oldGenre = window.PROD_AI_REF_GENRE;
            log(`üéµ Mudando g√™nero: ${oldGenre} ‚Üí ${newGenre}`, 'info');
            
            window.PROD_AI_REF_GENRE = newGenre;
            
            // Verificar se o monitor detecta a mudan√ßa
            if (window._cacheChangeMonitor) {
                window._cacheChangeMonitor.checkAndInvalidate();
            }
            
            updateSystemStatus();
        }

        function simulateRefsUpdate() {
            const oldVersion = window.EMBEDDED_REFS_VERSION;
            const newVersion = `v2025.08.28-test-${Date.now()}`;
            
            log(`üìö Simulando atualiza√ß√£o refs: ${oldVersion} ‚Üí ${newVersion}`, 'info');
            
            window.EMBEDDED_REFS_VERSION = newVersion;
            
            // Verificar se o monitor detecta a mudan√ßa
            if (window._cacheChangeMonitor) {
                window._cacheChangeMonitor.checkAndInvalidate();
            }
            
            updateSystemStatus();
            
            // Restaurar ap√≥s 5 segundos
            setTimeout(() => {
                window.EMBEDDED_REFS_VERSION = oldVersion;
                log(`üìö Vers√£o refs restaurada: ${oldVersion}`, 'info');
                updateSystemStatus();
            }, 5000);
        }

        function testLegacyMigration() {
            log('üîÑ Testando migra√ß√£o de cache legacy...', 'info');
            
            const cache = window.__AUDIO_ANALYSIS_CACHE__ || new Map();
            window.__AUDIO_ANALYSIS_CACHE__ = cache;
            
            // Adicionar entrada legacy (s√≥ fileHash)
            const legacyHash = 'legacy_test_' + Date.now();
            cache.set(legacyHash, {
                analysis: { 
                    test: true, 
                    message: 'Esta √© uma entrada legacy' 
                },
                _ts: Date.now()
            });
            
            log(`üì¶ Entrada legacy adicionada: ${legacyHash}`, 'info');
            
            // Simular que temos um arquivo com esse hash
            const genre = window.PROD_AI_REF_GENRE || 'test';
            const refsVer = window.EMBEDDED_REFS_VERSION || 'v1.0.0';
            const newKey = `${genre}:${legacyHash}:${refsVer}`;
            
            // Simular migra√ß√£o manual
            if (cache.has(legacyHash) && !cache.has(newKey)) {
                const entry = cache.get(legacyHash);
                cache.set(newKey, entry);
                cache.delete(legacyHash);
                
                log(`‚úÖ Migra√ß√£o simulada: ${legacyHash} ‚Üí ${newKey}`, 'success');
                cacheMetrics.migrations++;
            }
            
            showCacheMetrics();
        }

        function showCacheMetrics() {
            const metricsHtml = `
                <strong>Cache Hits:</strong> ${cacheMetrics.hits}<br>
                <strong>Cache Misses:</strong> ${cacheMetrics.misses}<br>
                <strong>Invalida√ß√µes:</strong> ${cacheMetrics.invalidations}<br>
                <strong>Migra√ß√µes Legacy:</strong> ${cacheMetrics.migrations}<br>
                <strong>Hit Rate:</strong> ${cacheMetrics.hits + cacheMetrics.misses > 0 ? 
                    Math.round(cacheMetrics.hits / (cacheMetrics.hits + cacheMetrics.misses) * 100) : 0}%
            `;
            
            document.getElementById('cacheMetrics').innerHTML = metricsHtml;
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üîÑ Sistema de teste de cache determin√≠stico carregado', 'success');
            
            // Verificar se todas as fun√ß√µes necess√°rias est√£o dispon√≠veis
            const requiredFunctions = [
                'invalidateAudioAnalysisCache',
                'invalidateCacheByChange',
                '_cacheChangeMonitor'
            ];
            
            let allGood = true;
            requiredFunctions.forEach(fn => {
                if (window[fn]) {
                    log(`‚úÖ ${fn} dispon√≠vel`, 'success');
                } else {
                    log(`‚ùå ${fn} n√£o encontrada`, 'error');
                    allGood = false;
                }
            });
            
            if (allGood) {
                log('üéâ Todas as fun√ß√µes de cache est√£o dispon√≠veis!', 'success');
            }
            
            updateSystemStatus();
            showCacheMetrics();
        });

        // Atualizar status periodicamente
        setInterval(updateSystemStatus, 2000);
    </script>
</body>
</html>
