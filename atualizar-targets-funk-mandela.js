import fs from 'fs';
import path from 'path';

class AtualizadorTargetsFunkMandela {
    constructor() {
        this.configPath = 'refs/out/funk_mandela.json';
        this.backupPath = this.gerarNomeBackup();
        this.novosTargets = {
            true_peak_target: -8.0,
            tol_true_peak: 2.5,
            dr_target: 8.0,
            tol_dr: 1.5,
            lra_target: 9.0,
            tol_lra: 2.0,
            stereo_target: 0.60,
            tol_stereo: 0.15
        };
    }

    gerarNomeBackup() {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        return `refs/out/funk_mandela.backup-${timestamp}.json`;
    }

    async executarAtualizacao() {
        console.log('='.repeat(70));
        console.log('ATUALIZACAO DE TARGETS - FUNK MANDELA');
        console.log('='.repeat(70));
        console.log();

        try {
            // 1. Verificar se arquivo existe
            if (!fs.existsSync(this.configPath)) {
                throw new Error(`Arquivo n√£o encontrado: ${this.configPath}`);
            }

            // 2. Carregar configura√ß√£o atual
            console.log('üìÇ Carregando configura√ß√£o atual...');
            const configAtual = JSON.parse(fs.readFileSync(this.configPath, 'utf8'));
            
            // 3. Criar backup
            console.log('üíæ Criando backup de seguran√ßa...');
            this.criarBackup(configAtual);

            // 4. Capturar valores antigos
            console.log('üìä Capturando valores atuais...');
            const valoresAntigos = this.capturarValoresAtuais(configAtual);

            // 5. Aplicar novos valores
            console.log('üîÑ Aplicando novos targets...');
            const configAtualizada = this.aplicarNovosTargets(configAtual);

            // 6. Validar estrutura JSON
            console.log('‚úÖ Validando estrutura JSON...');
            this.validarEstrutura(configAtualizada);

            // 7. Salvar arquivo atualizado
            console.log('üíæ Salvando configura√ß√£o atualizada...');
            this.salvarConfiguracao(configAtualizada);

            // 8. Gerar relat√≥rio de mudan√ßas
            console.log('üìù Gerando relat√≥rio de mudan√ßas...');
            this.gerarRelatorioMudancas(valoresAntigos, this.novosTargets);

            console.log();
            console.log('‚úÖ ATUALIZA√á√ÉO CONCLU√çDA COM SUCESSO!');

        } catch (error) {
            console.log(`‚ùå ERRO: ${error.message}`);
            if (fs.existsSync(this.backupPath)) {
                console.log(`üîÑ Backup dispon√≠vel em: ${this.backupPath}`);
            }
        }
    }

    criarBackup(config) {
        fs.writeFileSync(this.backupPath, JSON.stringify(config, null, 2));
        console.log(`   ‚úÖ Backup criado: ${this.backupPath}`);
    }

    capturarValoresAtuais(config) {
        const legacyCompat = config.funk_mandela?.legacy_compatibility;
        if (!legacyCompat) {
            throw new Error('Se√ß√£o legacy_compatibility n√£o encontrada');
        }

        return {
            true_peak_target: legacyCompat.true_peak_target,
            tol_true_peak: legacyCompat.tol_true_peak,
            dr_target: legacyCompat.dr_target,
            tol_dr: legacyCompat.tol_dr,
            lra_target: legacyCompat.lra_target,
            tol_lra: legacyCompat.tol_lra,
            stereo_target: legacyCompat.stereo_target,
            tol_stereo: legacyCompat.tol_stereo
        };
    }

    aplicarNovosTargets(config) {
        // Criar c√≥pia profunda da configura√ß√£o
        const configAtualizada = JSON.parse(JSON.stringify(config));
        
        // Atualizar valores em legacy_compatibility
        const legacyCompat = configAtualizada.funk_mandela.legacy_compatibility;
        
        Object.entries(this.novosTargets).forEach(([chave, valor]) => {
            legacyCompat[chave] = valor;
        });

        // Tamb√©m atualizar na estrutura "fixed" se existir
        const fixed = configAtualizada.funk_mandela.fixed;
        if (fixed) {
            // True Peak
            if (fixed.truePeak) {
                fixed.truePeak.streamingMax = this.novosTargets.true_peak_target;
            }
            
            // Dynamic Range
            if (fixed.dynamicRange && fixed.dynamicRange.dr) {
                fixed.dynamicRange.dr.target = this.novosTargets.dr_target;
                fixed.dynamicRange.dr.tolerance = this.novosTargets.tol_dr;
            }
        }

        // Atualizar na estrutura "flex" se existir
        const flex = configAtualizada.funk_mandela.flex;
        if (flex) {
            // LRA
            if (flex.lra) {
                const lraCenter = this.novosTargets.lra_target;
                const lraTol = this.novosTargets.tol_lra;
                flex.lra.min = +(lraCenter - lraTol).toFixed(3);
                flex.lra.max = +(lraCenter + lraTol).toFixed(3);
            }
        }

        // Atualizar timestamp de gera√ß√£o
        configAtualizada.funk_mandela.generated_at = new Date().toISOString();
        configAtualizada.funk_mandela.version = "2025-08-updated-targets.2.1.2";

        return configAtualizada;
    }

    validarEstrutura(config) {
        // Verificar se a estrutura JSON √© v√°lida
        try {
            JSON.stringify(config);
            console.log('   ‚úÖ Estrutura JSON v√°lida');
        } catch (error) {
            throw new Error(`JSON inv√°lido: ${error.message}`);
        }

        // Verificar se as se√ß√µes essenciais existem
        if (!config.funk_mandela) {
            throw new Error('Se√ß√£o funk_mandela ausente');
        }

        if (!config.funk_mandela.legacy_compatibility) {
            throw new Error('Se√ß√£o legacy_compatibility ausente');
        }

        console.log('   ‚úÖ Estrutura consistente mantida');
    }

    salvarConfiguracao(config) {
        fs.writeFileSync(this.configPath, JSON.stringify(config, null, 2));
        console.log(`   ‚úÖ Arquivo salvo: ${this.configPath}`);
    }

    gerarRelatorioMudancas(valoresAntigos, novosValores) {
        console.log();
        console.log('üìã RELAT√ìRIO DE MUDAN√áAS APLICADAS:');
        console.log('='.repeat(70));
        
        const mudancas = [
            {
                metrica: 'True Peak Target',
                antigo: valoresAntigos.true_peak_target,
                novo: novosValores.true_peak_target,
                unidade: 'dBTP'
            },
            {
                metrica: 'True Peak Tolerance',
                antigo: valoresAntigos.tol_true_peak,
                novo: novosValores.tol_true_peak,
                unidade: 'dB'
            },
            {
                metrica: 'DR Target',
                antigo: valoresAntigos.dr_target,
                novo: novosValores.dr_target,
                unidade: 'DR'
            },
            {
                metrica: 'DR Tolerance',
                antigo: valoresAntigos.tol_dr,
                novo: novosValores.tol_dr,
                unidade: 'DR'
            },
            {
                metrica: 'LRA Target',
                antigo: valoresAntigos.lra_target,
                novo: novosValores.lra_target,
                unidade: 'LU'
            },
            {
                metrica: 'LRA Tolerance',
                antigo: valoresAntigos.tol_lra,
                novo: novosValores.tol_lra,
                unidade: 'LU'
            },
            {
                metrica: 'Stereo Target',
                antigo: valoresAntigos.stereo_target,
                novo: novosValores.stereo_target,
                unidade: ''
            },
            {
                metrica: 'Stereo Tolerance',
                antigo: valoresAntigos.tol_stereo,
                novo: novosValores.tol_stereo,
                unidade: ''
            }
        ];

        console.log();
        console.log('| M√©trica | Valor Antigo | Valor Novo | Diferen√ßa | Unidade |');
        console.log('|---------|--------------|------------|-----------|---------|');
        
        mudancas.forEach(({ metrica, antigo, novo, unidade }) => {
            const diferenca = +(novo - antigo).toFixed(3);
            const sinal = diferenca > 0 ? '+' : '';
            console.log(`| ${metrica} | ${antigo} | ${novo} | ${sinal}${diferenca} | ${unidade} |`);
        });

        console.log();
        console.log('üîç IMPACTOS DAS MUDAN√áAS:');
        console.log('   ‚Ä¢ True Peak mais permissivo (-8.0 vs -10.9): +2.9 dB de headroom');
        console.log('   ‚Ä¢ DR mantido (8.0): Mesmo perfil din√¢mico');
        console.log('   ‚Ä¢ LRA reduzido (9.0 vs 9.9): Menos varia√ß√£o de loudness permitida');
        console.log('   ‚Ä¢ Stereo mantido (0.60): Mesmo perfil de correla√ß√£o est√©reo');
        console.log('   ‚Ä¢ Toler√¢ncias ajustadas para maior flexibilidade');

        // Salvar relat√≥rio em arquivo
        this.salvarRelatorioArquivo(mudancas);
    }

    salvarRelatorioArquivo(mudancas) {
        const timestamp = new Date().toISOString();
        const relatorio = this.gerarMarkdownRelatorio(mudancas, timestamp);
        
        const nomeArquivo = `RELATORIO_ATUALIZACAO_TARGETS_FUNK_MANDELA_${new Date().toISOString().split('T')[0]}.md`;
        fs.writeFileSync(nomeArquivo, relatorio);
        
        console.log();
        console.log(`üìÑ Relat√≥rio detalhado salvo: ${nomeArquivo}`);
    }

    gerarMarkdownRelatorio(mudancas, timestamp) {
        let md = `# üîÑ RELAT√ìRIO DE ATUALIZA√á√ÉO - TARGETS FUNK MANDELA\n\n`;
        md += `**Data da Atualiza√ß√£o:** ${new Date().toLocaleDateString('pt-BR')}\n`;
        md += `**Timestamp:** ${timestamp}\n`;
        md += `**Arquivo Atualizado:** ${this.configPath}\n`;
        md += `**Backup Criado:** ${this.backupPath}\n\n`;
        
        md += `---\n\n## üìä MUDAN√áAS APLICADAS\n\n`;
        md += `| M√©trica | Valor Antigo | Valor Novo | Diferen√ßa | Unidade |\n`;
        md += `|---------|--------------|------------|-----------|----------|\n`;
        
        mudancas.forEach(({ metrica, antigo, novo, unidade }) => {
            const diferenca = +(novo - antigo).toFixed(3);
            const sinal = diferenca > 0 ? '+' : '';
            md += `| **${metrica}** | ${antigo} | **${novo}** | ${sinal}${diferenca} | ${unidade} |\n`;
        });

        md += `\n---\n\n## üéØ NOVOS PAR√ÇMETROS\n\n`;
        md += `### True Peak\n`;
        md += `- **Target:** -8.0 dBTP\n`;
        md += `- **Toler√¢ncia:** ¬±2.5 dB\n`;
        md += `- **Range:** -10.5 a -5.5 dBTP\n\n`;
        
        md += `### Dynamic Range (DR)\n`;
        md += `- **Target:** 8.0 DR\n`;
        md += `- **Toler√¢ncia:** ¬±1.5 DR\n`;
        md += `- **Range:** 6.5 a 9.5 DR\n\n`;
        
        md += `### Loudness Range (LRA)\n`;
        md += `- **Target:** 9.0 LU\n`;
        md += `- **Toler√¢ncia:** ¬±2.0 LU\n`;
        md += `- **Range:** 7.0 a 11.0 LU\n\n`;
        
        md += `### Correla√ß√£o Est√©reo\n`;
        md += `- **Target:** 0.60\n`;
        md += `- **Toler√¢ncia:** ¬±0.15\n`;
        md += `- **Range:** 0.45 a 0.75\n\n`;

        md += `---\n\n## üîç AN√ÅLISE DE IMPACTO\n\n`;
        md += `### üìà Mudan√ßas Significativas\n`;
        md += `- **True Peak:** Muito mais permissivo (+2.9 dB)\n`;
        md += `- **LRA:** Ligeiramente mais restritivo (-0.9 LU)\n`;
        md += `- **Toler√¢ncias:** Ajustadas para melhor flexibilidade\n\n`;
        
        md += `### üéµ Caracter√≠sticas do Novo Perfil\n`;
        md += `- **Mais headroom:** True Peak -8.0 permite mais dynamics\n`;
        md += `- **Controle LRA:** Menor varia√ß√£o de loudness (mais consistente)\n`;
        md += `- **Flexibilidade:** Toler√¢ncias balanceadas\n`;
        md += `- **Est√©reo mantido:** Perfil de correla√ß√£o preservado\n\n`;

        md += `---\n\n## ‚úÖ VALIDA√á√ÉO\n\n`;
        md += `- ‚úÖ Backup criado antes da modifica√ß√£o\n`;
        md += `- ‚úÖ Estrutura JSON mantida √≠ntegra\n`;
        md += `- ‚úÖ Valores aplicados em todas as se√ß√µes relevantes\n`;
        md += `- ‚úÖ Timestamp de vers√£o atualizado\n`;
        md += `- ‚úÖ Bandas de frequ√™ncia preservadas (conforme solicitado)\n\n`;

        md += `**Status:** Atualiza√ß√£o conclu√≠da com sucesso! üéØ\n`;

        return md;
    }
}

// Executar atualiza√ß√£o
const atualizador = new AtualizadorTargetsFunkMandela();
atualizador.executarAtualizacao().catch(console.error);
