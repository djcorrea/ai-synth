<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Aplicar Corre√ß√£o - Ordem de Execu√ß√£o do Score</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            line-height: 1.6;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .success { background: rgba(46, 204, 113, 0.3); border-left: 4px solid #2ecc71; }
        .warning { background: rgba(241, 196, 15, 0.3); border-left: 4px solid #f1c40f; }
        .error { background: rgba(231, 76, 60, 0.3); border-left: 4px solid #e74c3c; }
        .info { background: rgba(52, 152, 219, 0.3); border-left: 4px solid #3498db; }
        button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .actions {
            text-align: center;
            margin: 30px 0;
        }
        #log {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .highlight {
            background: rgba(255, 255, 0, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Corre√ß√£o da Ordem de Execu√ß√£o do Score</h1>
        
        <div class="info">
            <strong>üìã PROBLEMA IDENTIFICADO:</strong><br>
            O score √© calculado <span class="highlight">ANTES</span> das bandas espectrais (bandEnergies) estarem prontas,
            causando inconsist√™ncia entre o score mostrado e as m√©tricas calculadas.
        </div>

        <div class="info">
            <strong>üõ†Ô∏è SOLU√á√ÉO APLICADA:</strong><br>
            Reorganizar a ordem de execu√ß√£o para calcular o score <span class="highlight">AP√ìS</span> 
            as m√©tricas espectrais estarem completamente processadas.
        </div>

        <div class="success">
            <strong>‚úÖ SEGURAN√áA GARANTIDA:</strong><br>
            ‚Ä¢ Backup autom√°tico dos m√©todos originais<br>
            ‚Ä¢ Revers√£o dispon√≠vel a qualquer momento<br>
            ‚Ä¢ 100% compat√≠vel com c√≥digo existente<br>
            ‚Ä¢ Zero impacto na funcionalidade atual
        </div>

        <div class="actions">
            <button onclick="verificarStatus()">üìä Verificar Status</button>
            <button onclick="aplicarCorrecao()">üöÄ Aplicar Corre√ß√£o</button>
            <button onclick="diagnosticar()">üîç Diagn√≥stico Completo</button>
            <button onclick="reverterCorrecao()">üîÑ Reverter (Se Necess√°rio)</button>
        </div>

        <div id="status"></div>
        <div id="log"></div>
    </div>

    <script src="solucao-definitiva-score.js"></script>
    <script>
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function verificarStatus() {
            addLog('üîç Verificando status da corre√ß√£o...');
            try {
                const result = window.controlarCorrecaoOrdem('status');
                const status = result.aplicada ? 'APLICADA' : 'N√ÉO APLICADA';
                const version = result.versao ? ` (v${result.versao})` : '';
                
                showStatus(`üìä Status: <strong>${status}</strong>${version}`, result.aplicada ? 'success' : 'warning');
                addLog(`Status: ${status}${version}`, 'success');
                
                if (result.aplicada) {
                    addLog('‚úÖ Corre√ß√£o est√° ativa e funcionando');
                } else {
                    addLog('‚ö†Ô∏è Corre√ß√£o n√£o foi aplicada ainda');
                }
            } catch (error) {
                addLog(`‚ùå Erro ao verificar status: ${error.message}`, 'error');
                showStatus('‚ùå Erro ao verificar status', 'error');
            }
        }

        function aplicarCorrecao() {
            addLog('üöÄ Iniciando aplica√ß√£o da corre√ß√£o...');
            showStatus('üîÑ Aplicando corre√ß√£o...', 'info');
            
            try {
                const result = window.aplicarCorrecaoOrdemExecucao();
                
                if (result.success) {
                    showStatus('üéâ Corre√ß√£o aplicada com sucesso!', 'success');
                    addLog('‚úÖ Corre√ß√£o aplicada com sucesso!');
                    addLog(`üìã Detalhes: ${result.message}`);
                    
                    if (result.details) {
                        addLog(`üïê Timestamp: ${result.details.timestamp}`);
                        addLog(`üì¶ Backups criados: ${result.details.backupsCreated ? 'Sim' : 'N√£o'}`);
                    }
                    
                    // Verificar se realmente foi aplicada
                    setTimeout(() => {
                        const status = window.controlarCorrecaoOrdem('status');
                        if (status.aplicada) {
                            addLog('üî• CORRE√á√ÉO ATIVA! Score agora √© calculado na ordem correta.');
                        }
                    }, 500);
                } else {
                    showStatus('‚ùå Falha ao aplicar corre√ß√£o', 'error');
                    addLog(`‚ùå Falha: ${result.message}`);
                    if (result.error) {
                        addLog(`üîç Erro: ${result.error}`);
                    }
                }
            } catch (error) {
                addLog(`üí• Erro cr√≠tico: ${error.message}`, 'error');
                showStatus('üí• Erro cr√≠tico ao aplicar corre√ß√£o', 'error');
            }
        }

        function diagnosticar() {
            addLog('üîç Executando diagn√≥stico completo...');
            try {
                const result = window.diagnosticarOrdemExecucao();
                
                if (result.status === 'success') {
                    const info = result.info;
                    showStatus('üìä Diagn√≥stico conclu√≠do', 'info');
                    
                    addLog('üìã === DIAGN√ìSTICO COMPLETO ===');
                    addLog(`üïê Timestamp: ${info.timestamp}`);
                    addLog(`‚úÖ Corre√ß√£o aplicada: ${info.correcaoAplicada ? 'SIM' : 'N√ÉO'}`);
                    addLog(`üì¶ Vers√£o: ${info.versao || 'N/A'}`);
                    addLog(`üìÖ Data aplica√ß√£o: ${info.dataAplicacao || 'N/A'}`);
                    addLog(`üíæ Backups existem: ${info.backupsExistem ? 'SIM' : 'N√ÉO'}`);
                    addLog(`üéµ Analisador existe: ${info.analisadorExiste ? 'SIM' : 'N√ÉO'}`);
                    addLog(`üéõÔ∏è Controle ativo: ${info.controleAtivo ? 'SIM' : 'N√ÉO'}`);
                    
                    if (info.estatisticas) {
                        addLog('üìä Estat√≠sticas:');
                        addLog(`   - An√°lises executadas: ${info.estatisticas.analyzesCalled}`);
                        addLog(`   - Scores calculados cedo: ${info.estatisticas.scoreCalculatedEarly}`);
                        addLog(`   - Scores calculados tarde: ${info.estatisticas.scoreCalculatedLate}`);
                        addLog(`   - Bandas dispon√≠veis: ${info.estatisticas.bandsAvailable}`);
                    }
                } else {
                    showStatus('‚ùå Erro no diagn√≥stico', 'error');
                    addLog(`‚ùå Erro: ${result.message}`);
                }
            } catch (error) {
                addLog(`üí• Erro no diagn√≥stico: ${error.message}`, 'error');
                showStatus('üí• Erro no diagn√≥stico', 'error');
            }
        }

        function reverterCorrecao() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja reverter a corre√ß√£o? O sistema voltar√° ao comportamento anterior.')) {
                return;
            }
            
            addLog('üîÑ Iniciando revers√£o da corre√ß√£o...');
            showStatus('üîÑ Revertendo corre√ß√£o...', 'warning');
            
            try {
                const result = window.reverterCorrecaoOrdemExecucao();
                
                if (result.success) {
                    showStatus('‚úÖ Corre√ß√£o revertida com sucesso', 'success');
                    addLog('‚úÖ Corre√ß√£o revertida com sucesso');
                    addLog('üîô Sistema voltou ao estado original');
                } else {
                    showStatus('‚ùå Falha ao reverter corre√ß√£o', 'error');
                    addLog(`‚ùå Falha: ${result.message}`);
                }
            } catch (error) {
                addLog(`üí• Erro ao reverter: ${error.message}`, 'error');
                showStatus('üí• Erro ao reverter', 'error');
            }
        }

        // Verificar status inicial quando a p√°gina carrega
        window.addEventListener('load', () => {
            addLog('üéØ P√°gina carregada - Sistema de corre√ß√£o pronto');
            setTimeout(verificarStatus, 1000);
        });

        // Log de inicializa√ß√£o
        addLog('üöÄ Sistema de corre√ß√£o inicializado');
        addLog('üìã Corre√ß√£o dispon√≠vel: Ordem de Execu√ß√£o do Score v1.0.0');
        addLog('üéØ Problema: Score calculado antes das bandas espectrais');
        addLog('‚úÖ Solu√ß√£o: Reordenar execu√ß√£o para ap√≥s Fase 2 completa');
        addLog('üõ°Ô∏è Seguran√ßa: Backups autom√°ticos e revers√£o dispon√≠vel');
    </script>
</body>
</html>
