// üî¨ AN√ÅLISE ESPEC√çFICA DO PROBLEMA DE SCORE FIXO
// Investiga√ß√£o direcionada para descobrir por que o score n√£o muda

console.log('üî¨ [PROBLEMA-SCORE] Iniciando an√°lise espec√≠fica do problema...');

// Capturar dados da √∫ltima an√°lise do console
function capturarDadosConsole() {
    console.log('üìù [CONSOLE-DATA] Analisando dados do console...');
    
    // Procurar por dados no console atual
    const ultimaAnalise = window.__LAST_FULL_ANALYSIS;
    const ultimoScore = window.__LAST_MIX_SCORE;
    
    console.log('üìä [CONSOLE-DATA] √öltima an√°lise:', ultimaAnalise);
    console.log('üéØ [CONSOLE-DATA] √öltimo score:', ultimoScore);
    
    // Dados do console mostram score de 36.5%
    const dadosDoConsole = {
        scoreObtido: 36.5, // do console: "Score final definido: 36.55"
        metricasKey: [
            'lufsIntegrated', 'truePeakDbtp', 'dynamicRange', 'lra', 
            'crestFactor', 'stereoCorrelation', 'stereoWidth',
            'spectralCentroid', 'bandEnergies'
        ],
        valorEsperado: "Deveria ser diferente para arquivo diferente",
        problemaIdentificado: "Score sempre 36.5% independente do arquivo"
    };
    
    return dadosDoConsole;
}

// Simular diferentes arquivos de √°udio
function simularArquivosDiferentes() {
    console.log('üéµ [SIMULA√á√ÉO] Simulando diferentes arquivos de √°udio...');
    
    // Arquivo 1: Qualidade baixa (deveria dar score baixo)
    const arquivoBaixaQualidade = {
        lufsIntegrated: -3.0,  // Muito alto (ruim)
        truePeakDbtp: 0.5,     // Clipping (p√©ssimo)
        dynamicRange: 2.0,     // Muito baixo (ruim)
        dr: 2.0,
        lra: 20.0,            // Muito alto (ruim)
        crestFactor: 3.0,     // Muito baixo (ruim)
        stereoCorrelation: -0.8, // Muito baixo (ruim)
        stereoWidth: 1.5,     // Muito alto (ruim)
        spectralCentroid: 8000, // Muito alto (ruim)
        bandEnergies: {
            'graves_60_120': { rms_db: -25.0 },     // Muito baixo
            'medias_graves_200_500': { rms_db: -1.0 }, // Muito alto  
            'medias_500_2000': { rms_db: -30.0 },   // Muito baixo
            'medias_agudas_2_4khz': { rms_db: 0.0 }, // Muito alto
            'agudos_4_8khz': { rms_db: -35.0 },     // Muito baixo
            'presenca_8_12khz': { rms_db: 2.0 }     // Muito alto
        }
    };
    
    // Arquivo 2: Qualidade alta (deveria dar score alto)
    const arquivoAltaQualidade = {
        lufsIntegrated: -14.0,  // Perfeito
        truePeakDbtp: -3.0,     // Perfeito
        dynamicRange: 12.0,     // Bom
        dr: 12.0,
        lra: 8.0,              // Bom
        crestFactor: 12.0,     // Bom
        stereoCorrelation: 0.6, // Bom
        stereoWidth: 0.8,      // Bom
        spectralCentroid: 2500, // Perfeito
        bandEnergies: {
            'graves_60_120': { rms_db: -8.0 },      // Perfeito
            'medias_graves_200_500': { rms_db: -9.0 }, // Perfeito
            'medias_500_2000': { rms_db: -6.0 },    // Perfeito
            'medias_agudas_2_4khz': { rms_db: -12.0 }, // Perfeito
            'agudos_4_8khz': { rms_db: -16.0 },     // Perfeito
            'presenca_8_12khz': { rms_db: -19.0 }   // Perfeito
        }
    };
    
    // Arquivo 3: Dados do console atual (o que est√° sendo analisado)
    const arquivoAtual = {
        lufsIntegrated: -6.2,
        truePeakDbtp: -1.9,
        dynamicRange: 6.6,
        dr: 6.6,
        lra: 4.96,
        crestFactor: null, // n√£o informado
        stereoCorrelation: 0.20,
        stereoWidth: 0.23,
        spectralCentroid: 4615,
        bandEnergies: {
            'graves_60_120': { rms_db: -6.90 },
            'medias_graves_200_500': { rms_db: -7.44 },
            'medias_500_2000': { rms_db: -7.31 },
            'medias_agudas_2_4khz': { rms_db: -12.34 },
            'agudos_4_8khz': { rms_db: -15.54 },
            'presenca_8_12khz': { rms_db: -22.82 }
        }
    };
    
    return { arquivoBaixaQualidade, arquivoAltaQualidade, arquivoAtual };
}

// Testar cada arquivo e comparar scores
function testarTodosArquivos() {
    console.log('üß™ [TESTE-COMPARATIVO] Testando todos os arquivos...');
    
    const arquivos = simularArquivosDiferentes();
    const referencia = {
        lufs_target: -8.0,
        tol_lufs: 2.0,
        true_peak_target: -3.0,
        tol_true_peak: 2.0,
        dr_target: 8.0,
        tol_dr: 3.0,
        lra_target: 9.0,
        tol_lra: 4.0,
        stereo_target: 0.6,
        tol_stereo: 0.5,
        bands: {
            'graves_60_120': { target_db: -8.0, tol_db: 2.0 },
            'medias_graves_200_500': { target_db: -9.0, tol_db: 2.0 },
            'medias_500_2000': { target_db: -6.0, tol_db: 2.0 },
            'medias_agudas_2_4khz': { target_db: -12.0, tol_db: 3.0 },
            'agudos_4_8khz': { target_db: -16.0, tol_db: 4.0 },
            'presenca_8_12khz': { target_db: -19.0, tol_db: 3.0 }
        }
    };
    
    const resultados = {};
    
    // Verificar se fun√ß√£o de scoring existe
    if (!window.computeMixScore) {
        console.error('‚ùå [TESTE-COMPARATIVO] window.computeMixScore n√£o encontrado!');
        return null;
    }
    
    // Testar cada arquivo
    Object.entries(arquivos).forEach(([nome, dados]) => {
        console.log(`üéµ [TESTE-COMPARATIVO] Testando ${nome}...`);
        console.log(`üìä [TESTE-COMPARATIVO] Dados:`, dados);
        
        try {
            const resultado = window.computeMixScore(dados, referencia);
            resultados[nome] = {
                score: resultado.scorePct,
                metodo: resultado.method || resultado.scoringMethod,
                classificacao: resultado.classification,
                detalhes: resultado
            };
            
            console.log(`‚úÖ [TESTE-COMPARATIVO] ${nome}: ${resultado.scorePct}% (${resultado.method})`);
        } catch (error) {
            console.error(`‚ùå [TESTE-COMPARATIVO] Erro em ${nome}:`, error);
            resultados[nome] = { error: error.message };
        }
    });
    
    return resultados;
}

// Analisar diferen√ßas nos resultados
function analisarDiferencas(resultados) {
    console.log('üìà [AN√ÅLISE] Analisando diferen√ßas nos scores...');
    
    if (!resultados) {
        console.error('‚ùå [AN√ÅLISE] Nenhum resultado para analisar');
        return null;
    }
    
    const scores = Object.entries(resultados).map(([nome, dados]) => ({
        nome,
        score: dados.score || 0,
        metodo: dados.metodo || 'N/A'
    }));
    
    console.log('üìä [AN√ÅLISE] Scores obtidos:');
    scores.forEach(item => {
        console.log(`  ${item.nome}: ${item.score}% (${item.metodo})`);
    });
    
    // Calcular diferen√ßas
    const scoreValues = scores.map(s => s.score).filter(s => s > 0);
    const minScore = Math.min(...scoreValues);
    const maxScore = Math.max(...scoreValues);
    const diferenca = maxScore - minScore;
    
    console.log(`üìà [AN√ÅLISE] Score m√≠nimo: ${minScore}%`);
    console.log(`üìà [AN√ÅLISE] Score m√°ximo: ${maxScore}%`);
    console.log(`üìà [AN√ÅLISE] Diferen√ßa: ${diferenca.toFixed(1)} pontos`);
    
    // Diagn√≥stico
    if (diferenca < 5) {
        console.error('‚ùå [DIAGN√ìSTICO] PROBLEMA DETECTADO: Scores muito similares!');
        console.error('‚ùå [DIAGN√ìSTICO] Sistema n√£o est√° diferenciando qualidade de √°udio adequadamente');
        console.error('‚ùå [DIAGN√ìSTICO] Diferen√ßa de apenas ' + diferenca.toFixed(1) + ' pontos entre qualidade baixa e alta');
        return { problema: true, diferenca, scores };
    } else {
        console.log('‚úÖ [DIAGN√ìSTICO] Sistema funcionando: diferen√ßa de ' + diferenca.toFixed(1) + ' pontos');
        return { problema: false, diferenca, scores };
    }
}

// Investigar poss√≠veis causas do problema
function investigarCausas() {
    console.log('üîç [INVESTIGA√á√ÉO] Investigando poss√≠veis causas...');
    
    const causas = [];
    
    // 1. Verificar se scoring.js est√° carregado corretamente
    if (!window.computeMixScore) {
        causas.push('scoring.js n√£o carregado ou fun√ß√£o n√£o dispon√≠vel');
    }
    
    // 2. Verificar se h√° cache/valores fixos
    if (window.__LAST_MIX_SCORE) {
        causas.push('Cache de score pode estar interferindo');
    }
    
    // 3. Verificar flags do sistema
    const flags = {
        AUDIT_MODE: window.AUDIT_MODE,
        SCORING_V2: window.SCORING_V2,
        USE_TT_DR: window.USE_TT_DR,
        AUTO_SCORING_V2: window.AUTO_SCORING_V2
    };
    
    if (!Object.values(flags).some(Boolean)) {
        causas.push('Flags do sistema n√£o est√£o configuradas corretamente');
    }
    
    // 4. Verificar se Equal Weight V3 est√° for√ßado
    if (window.__MIX_SCORING_VERSION__ && window.__MIX_SCORING_VERSION__.includes('equal-weight-v3-FORCED')) {
        causas.push('Sistema for√ßado para Equal Weight V3 - pode ter bug');
    }
    
    // 5. Verificar se refer√™ncias est√£o ativas
    if (!window.PROD_AI_REF_DATA || !window.PROD_AI_REF_DATA_ACTIVE) {
        causas.push('Refer√™ncias de g√™nero n√£o est√£o ativas');
    }
    
    console.log('üîç [INVESTIGA√á√ÉO] Poss√≠veis causas encontradas:');
    causas.forEach((causa, index) => {
        console.log(`  ${index + 1}. ${causa}`);
    });
    
    return causas;
}

// Propor solu√ß√µes
function proporSolucoes(causas) {
    console.log('üí° [SOLU√á√ïES] Propondo solu√ß√µes...');
    
    const solucoes = [];
    
    causas.forEach(causa => {
        if (causa.includes('scoring.js')) {
            solucoes.push('Recarregar scoring.js ou verificar imports');
        }
        if (causa.includes('cache')) {
            solucoes.push('Limpar cache: delete window.__LAST_MIX_SCORE');
        }
        if (causa.includes('flags')) {
            solucoes.push('Configurar flags: window.AUDIT_MODE = true; window.SCORING_V2 = true');
        }
        if (causa.includes('equal-weight-v3')) {
            solucoes.push('Desabilitar for√ßamento do Equal Weight V3 ou corrigir bug na implementa√ß√£o');
        }
        if (causa.includes('refer√™ncias')) {
            solucoes.push('Ativar refer√™ncias: window.PROD_AI_REF_DATA_ACTIVE = true');
        }
    });
    
    console.log('üí° [SOLU√á√ïES] Solu√ß√µes propostas:');
    solucoes.forEach((solucao, index) => {
        console.log(`  ${index + 1}. ${solucao}`);
    });
    
    return solucoes;
}

// Fun√ß√£o principal de an√°lise
function analisarProblemaScore() {
    console.log('üéØ [AN√ÅLISE-PRINCIPAL] Iniciando an√°lise completa do problema...');
    
    // Capturar dados atuais
    const dadosConsole = capturarDadosConsole();
    
    // Testar diferentes arquivos
    const resultados = testarTodosArquivos();
    
    // Analisar diferen√ßas
    const analise = analisarDiferencas(resultados);
    
    // Investigar causas
    const causas = investigarCausas();
    
    // Propor solu√ß√µes
    const solucoes = proporSolucoes(causas);
    
    // Relat√≥rio final
    console.log('üìã [RELAT√ìRIO-FINAL] ========================');
    console.log('üìã [RELAT√ìRIO-FINAL] AN√ÅLISE DO PROBLEMA SCORE');
    console.log('üìã [RELAT√ìRIO-FINAL] ========================');
    
    if (analise && analise.problema) {
        console.error('‚ùå [RELAT√ìRIO-FINAL] PROBLEMA CONFIRMADO: Score n√£o est√° variando adequadamente');
        console.error('‚ùå [RELAT√ìRIO-FINAL] Diferen√ßa entre qualidades: ' + analise.diferenca.toFixed(1) + ' pontos');
        console.error('‚ùå [RELAT√ìRIO-FINAL] Esperado: pelo menos 20-30 pontos de diferen√ßa');
    } else {
        console.log('‚úÖ [RELAT√ìRIO-FINAL] Sistema aparenta estar funcionando corretamente');
    }
    
    console.log('üîç [RELAT√ìRIO-FINAL] Causas identificadas: ' + causas.length);
    console.log('üí° [RELAT√ìRIO-FINAL] Solu√ß√µes propostas: ' + solucoes.length);
    
    return {
        problema: analise ? analise.problema : true,
        dadosConsole,
        resultados,
        analise,
        causas,
        solucoes,
        timestamp: new Date().toISOString()
    };
}

// Disponibilizar globalmente
if (typeof window !== 'undefined') {
    window.analisarProblemaScore = analisarProblemaScore;
    window.testarTodosArquivos = testarTodosArquivos;
    window.investigarCausas = investigarCausas;
    window.proporSolucoes = proporSolucoes;
    
    console.log('üîß [SETUP] Fun√ß√µes de an√°lise dispon√≠veis:');
    console.log('üîß [SETUP] - window.analisarProblemaScore() // An√°lise completa');
    console.log('üîß [SETUP] - window.testarTodosArquivos() // Teste comparativo');
    console.log('üîß [SETUP] - window.investigarCausas() // Investiga√ß√£o');
}

// Auto-executar uma an√°lise inicial
setTimeout(() => {
    console.log('üöÄ [AUTO-EXEC] Executando an√°lise autom√°tica em 3 segundos...');
    if (typeof window !== 'undefined' && window.analisarProblemaScore) {
        window.analisarProblemaScore();
    }
}, 3000);

export { analisarProblemaScore, testarTodosArquivos, investigarCausas };
