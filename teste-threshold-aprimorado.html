<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Teste: Threshold de Valida√ß√£o Aprimorado</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            margin: 0;
            padding: 20px;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        .title {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .section {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
        }
        .config-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .config-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
        }
        .btn {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            border: none;
            color: white;
            padding: 12px 25px;
            font-size: 14px;
            border-radius: 20px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .btn.danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .btn.warning { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .results {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .status-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .valid { color: #2ecc71; }
        .invalid { color: #e74c3c; }
        .warning { color: #f39c12; }
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        .threshold-display {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üîß Teste: Threshold de Valida√ß√£o Aprimorado</h1>
        
        <div class="section">
            <h2>üìä Status Atual do Sistema</h2>
            <div class="status-grid" id="statusGrid">
                <div class="status-card">
                    <h3>Corre√ß√£o Ativa</h3>
                    <div class="status-value" id="correctionStatus">--</div>
                </div>
                <div class="status-card">
                    <h3>Threshold Atual</h3>
                    <div class="status-value" id="thresholdStatus">--</div>
                </div>
                <div class="status-card">
                    <h3>Modo Adaptativo</h3>
                    <div class="status-value" id="adaptiveStatus">--</div>
                </div>
                <div class="status-card">
                    <h3>Bandas M√≠nimas</h3>
                    <div class="status-value" id="minimumBandsStatus">--</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>‚öôÔ∏è Configura√ß√£o de Threshold</h2>
            <div class="config-panel">
                <div class="config-item">
                    <h3>Threshold de Valida√ß√£o</h3>
                    <input type="range" id="thresholdSlider" min="0.1" max="1.0" step="0.05" value="0.85">
                    <div class="threshold-display" id="thresholdDisplay">85%</div>
                    <p>Porcentagem de bandas que devem estar v√°lidas</p>
                </div>
                <div class="config-item">
                    <h3>Bandas M√≠nimas</h3>
                    <input type="range" id="minimumSlider" min="1" max="8" step="1" value="3">
                    <div class="threshold-display" id="minimumDisplay">3</div>
                    <p>N√∫mero m√≠nimo absoluto de bandas v√°lidas</p>
                </div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="applyThresholdConfig()">üéØ Aplicar Configura√ß√£o</button>
                <button class="btn warning" onclick="resetToDefaults()">üîÑ Restaurar Padr√µes</button>
            </div>
        </div>

        <div class="section">
            <h2>üß™ Presets de Configura√ß√£o</h2>
            <div style="text-align: center;">
                <button class="btn" onclick="applyPreset('conservative')">üõ°Ô∏è Conservador (90%)</button>
                <button class="btn" onclick="applyPreset('balanced')">‚öñÔ∏è Balanceado (85%)</button>
                <button class="btn" onclick="applyPreset('permissive')">üöÄ Permissivo (75%)</button>
            </div>
        </div>

        <div class="section">
            <h2>üîç Teste de Valida√ß√£o</h2>
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="testValidation('4bands_full')">Teste: 4 Bandas (100%)</button>
                <button class="btn" onclick="testValidation('4bands_partial')">Teste: 4 Bandas (75%)</button>
                <button class="btn" onclick="testValidation('7bands_full')">Teste: 7 Bandas (100%)</button>
                <button class="btn" onclick="testValidation('7bands_partial')">Teste: 7 Bandas (85%)</button>
                <button class="btn danger" onclick="testValidation('invalid')">Teste: Dados Inv√°lidos</button>
            </div>
        </div>

        <div class="section">
            <h2>üìã Resultados dos Testes</h2>
            <div class="results" id="testResults">
Aguardando testes...

Para come√ßar:
1. Ajuste o threshold usando os controles acima
2. Execute um dos testes de valida√ß√£o
3. Observe os logs detalhados aqui
            </div>
        </div>
    </div>

    <!-- Carregar o m√≥dulo de corre√ß√£o -->
    <script src="pipeline-order-correction.js"></script>
    
    <script>
        // Refer√™ncias aos elementos
        const thresholdSlider = document.getElementById('thresholdSlider');
        const minimumSlider = document.getElementById('minimumSlider');
        const thresholdDisplay = document.getElementById('thresholdDisplay');
        const minimumDisplay = document.getElementById('minimumDisplay');
        const testResults = document.getElementById('testResults');

        // Atualizar displays dos sliders
        thresholdSlider.addEventListener('input', () => {
            const value = parseFloat(thresholdSlider.value);
            thresholdDisplay.textContent = `${Math.round(value * 100)}%`;
        });

        minimumSlider.addEventListener('input', () => {
            const value = parseInt(minimumSlider.value);
            minimumDisplay.textContent = value;
        });

        // Atualizar status do sistema
        function updateSystemStatus() {
            const status = window.PipelineOrderCorrection?.getValidationStatus();
            
            if (status) {
                document.getElementById('correctionStatus').textContent = status.correctionEnabled ? 'SIM' : 'N√ÉO';
                document.getElementById('correctionStatus').className = status.correctionEnabled ? 'valid' : 'invalid';
                
                document.getElementById('thresholdStatus').textContent = `${Math.round(status.config.validBandsThreshold * 100)}%`;
                document.getElementById('adaptiveStatus').textContent = status.config.adaptiveThreshold ? 'SIM' : 'N√ÉO';
                document.getElementById('minimumBandsStatus').textContent = status.config.minimumValidBands;
                
                // Atualizar sliders para refletir configura√ß√£o atual
                thresholdSlider.value = status.config.validBandsThreshold;
                minimumSlider.value = status.config.minimumValidBands;
                thresholdDisplay.textContent = `${Math.round(status.config.validBandsThreshold * 100)}%`;
                minimumDisplay.textContent = status.config.minimumValidBands;
            } else {
                document.getElementById('correctionStatus').textContent = 'ERRO';
                document.getElementById('correctionStatus').className = 'invalid';
            }
        }

        // Aplicar configura√ß√£o de threshold
        function applyThresholdConfig() {
            const threshold = parseFloat(thresholdSlider.value);
            const minimum = parseInt(minimumSlider.value);
            
            if (window.PipelineOrderCorrection?.configureValidationThreshold) {
                const result = window.PipelineOrderCorrection.configureValidationThreshold({
                    threshold: threshold,
                    minimumBands: minimum,
                    adaptive: true,
                    verbose: true
                });
                
                logToResults(`‚úÖ Configura√ß√£o aplicada:
Threshold: ${Math.round(threshold * 100)}%
M√≠nimo: ${minimum} bandas
Adaptativo: SIM
Verbose: SIM

Configura√ß√£o completa: ${JSON.stringify(result, null, 2)}`);
                
                updateSystemStatus();
            } else {
                logToResults('‚ùå Erro: Sistema de corre√ß√£o n√£o encontrado!');
            }
        }

        // Aplicar presets
        function applyPreset(preset) {
            const presets = {
                conservative: { threshold: 0.9, minimumBands: 4 },
                balanced: { threshold: 0.85, minimumBands: 3 },
                permissive: { threshold: 0.75, minimumBands: 2 }
            };
            
            const config = presets[preset];
            if (config) {
                thresholdSlider.value = config.threshold;
                minimumSlider.value = config.minimumBands;
                thresholdDisplay.textContent = `${Math.round(config.threshold * 100)}%`;
                minimumDisplay.textContent = config.minimumBands;
                
                applyThresholdConfig();
                logToResults(`üéØ Preset "${preset}" aplicado`);
            }
        }

        // Restaurar padr√µes
        function resetToDefaults() {
            if (window.PipelineOrderCorrection?.configureValidationThreshold) {
                window.PipelineOrderCorrection.configureValidationThreshold({
                    threshold: 0.85,
                    minimumBands: 3,
                    adaptive: true,
                    verbose: true
                });
                
                updateSystemStatus();
                logToResults('üîÑ Configura√ß√£o restaurada para os padr√µes');
            }
        }

        // Testar valida√ß√£o com dados simulados
        function testValidation(testType) {
            const testData = {
                '4bands_full': {
                    bandEnergies: {
                        sub: { rms_db: -12.5 },
                        low: { rms_db: -8.2 },
                        mid: { rms_db: -6.8 },
                        high: { rms_db: -10.1 }
                    }
                },
                '4bands_partial': {
                    bandEnergies: {
                        sub: { rms_db: -12.5 },
                        low: { rms_db: -8.2 },
                        mid: { rms_db: -6.8 },
                        high: { rms_db: -Infinity } // 1 banda inv√°lida
                    }
                },
                '7bands_full': {
                    bandEnergies: {
                        subBass: { rms_db: -15.2 },
                        bass: { rms_db: -8.7 },
                        lowMid: { rms_db: -12.1 },
                        mid: { rms_db: -6.8 },
                        highMid: { rms_db: -9.4 },
                        high: { rms_db: -11.2 },
                        presence: { rms_db: -13.8 }
                    }
                },
                '7bands_partial': {
                    bandEnergies: {
                        subBass: { rms_db: -15.2 },
                        bass: { rms_db: -8.7 },
                        lowMid: { rms_db: -12.1 },
                        mid: { rms_db: -6.8 },
                        highMid: { rms_db: -9.4 },
                        high: { rms_db: -11.2 },
                        presence: { rms_db: -Infinity } // 1 banda inv√°lida
                    }
                },
                'invalid': {
                    bandEnergies: {
                        broken1: null,
                        broken2: { rms_db: -Infinity },
                        broken3: { rms_db: NaN },
                        broken4: undefined
                    }
                }
            };

            const data = testData[testType];
            if (!data) {
                logToResults(`‚ùå Tipo de teste desconhecido: ${testType}`);
                return;
            }

            const runId = `test_${Date.now()}`;
            
            if (window.PipelineOrderCorrection?.validateSpectralBands) {
                logToResults(`üß™ Executando teste: ${testType} (${runId})\n`);
                
                const result = window.PipelineOrderCorrection.validateSpectralBands(data, runId);
                
                logToResults(`üìä Resultado da valida√ß√£o:
‚úÖ Ready: ${result.ready}
‚úÖ Valid: ${result.valid}
üìù Reason: ${result.reason}
üìä Bands: ${result.validBandCount}/${result.bandCount}
üìà Ratio: ${(result.validRatio * 100).toFixed(1)}%
üéØ Threshold: ${(result.thresholdUsed * 100).toFixed(1)}%
üîß Adaptive: ${result.adaptiveMode}

${result.valid ? '‚úÖ PASSOU NA VALIDA√á√ÉO' : '‚ùå FALHOU NA VALIDA√á√ÉO'}
`);
            } else {
                logToResults('‚ùå Sistema de valida√ß√£o n√£o encontrado!');
            }
        }

        // Log para √°rea de resultados
        function logToResults(message) {
            const timestamp = new Date().toLocaleTimeString();
            testResults.textContent += `\n[${timestamp}] ${message}\n`;
            testResults.scrollTop = testResults.scrollHeight;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            updateSystemStatus();
            logToResults('üéØ Sistema de teste carregado');
            logToResults('üìä Use os controles acima para testar diferentes configura√ß√µes');
        });
    </script>
</body>
</html>
