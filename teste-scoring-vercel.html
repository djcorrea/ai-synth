<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste Scoring Vercel - Unifica√ß√£o</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            margin: 0;
            line-height: 1.4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            border-radius: 10px;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        .result-box {
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        .info { border-left: 4px solid #2196F3; }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        .btn:hover { background: #45a049; }
        .btn:disabled { background: #666; cursor: not-allowed; }
        
        .score-display {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            background: #333;
        }
        
        .score-success { color: #4CAF50; }
        .score-error { color: #f44336; }
        
        .comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .genre-test {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Teste Scoring Vercel - Unifica√ß√£o</h1>
            <p>Verificando se o sistema Equal Weight V3 est√° funcionando na Vercel</p>
        </div>
        
        <div class="test-section">
            <h2>üöÄ Teste Direto do Scoring.js</h2>
            <button class="btn" onclick="testarScoringDireto()">Testar Scoring Direto</button>
            <button class="btn" onclick="testarMultiplosGeneros()">Testar M√∫ltiplos G√™neros</button>
            <button class="btn" onclick="verificarLogsVercel()">Verificar Logs Vercel</button>
            <div id="scoringResults"></div>
        </div>
        
        <div class="test-section">
            <h2>üìä Compara√ß√£o de G√™neros</h2>
            <div id="genreComparison" class="comparison"></div>
        </div>
        
        <div class="test-section">
            <h2>üîç Logs do Sistema</h2>
            <div class="result-box" id="systemLogs"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('systemLogs');
            const linha = `[${timestamp}] ${message}\n`;
            logContainer.textContent += linha;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            if (type === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }
        
        async function testarScoringDireto() {
            log('üß™ Testando scoring.js diretamente...');
            
            try {
                // Cache bust agressivo
                const cacheBust = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                log(`üîÑ Cache bust: ${cacheBust}`);
                
                const scoringModule = await import(`./lib/audio/features/scoring.js?v=${cacheBust}`);
                log('‚úÖ M√≥dulo scoring carregado: ' + !!scoringModule);
                log('‚úÖ computeMixScore dispon√≠vel: ' + (typeof scoringModule.computeMixScore === 'function'));
                
                // Dados de teste padr√£o
                const testData = {
                    lufsIntegrated: -14.5,
                    truePeakDbtp: -1.2,
                    dr: 8.5,
                    lra: 6.8,
                    crestFactor: 9.2,
                    stereoCorrelation: 0.25,
                    stereoWidth: 0.65,
                    balanceLR: 0.02,
                    spectralCentroid: 2800,
                    spectralFlatness: 0.22,
                    spectralRolloff85: 9200,
                    dcOffset: 0.01,
                    clippingSamples: 0,
                    clippingPct: 0
                };
                
                const testRef = {
                    lufs_target: -11.5,
                    tol_lufs: 1.8,
                    true_peak_target: -0.8,
                    tol_true_peak: 1,
                    dr_target: 7.2,
                    tol_dr: 2,
                    stereo_target: 0.38,
                    tol_stereo: 0.15
                };
                
                log('üéØ Executando computeMixScore...');
                const resultado = scoringModule.computeMixScore(testData, testRef);
                
                log('\nüìä RESULTADO:');
                log('Score: ' + (resultado?.score || resultado?.scorePct));
                log('Method: ' + (resultado?.method || resultado?.scoringMethod));
                log('Engine: ' + resultado?.engineVersion);
                log('Unified: ' + resultado?.unifiedScoring);
                log('Classification: ' + resultado?.classification);
                
                // Mostrar resultado visual
                const container = document.getElementById('scoringResults');
                const score = resultado?.score || resultado?.scorePct || 'N/A';
                const isSuccess = resultado?.engineVersion === '3.0.0' && resultado?.unifiedScoring;
                
                container.innerHTML = `
                    <div class="score-display ${isSuccess ? 'score-success' : 'score-error'}">
                        Score: ${score}%
                    </div>
                    <div class="result-box ${isSuccess ? 'success' : 'error'}">
                        <strong>Engine Version:</strong> ${resultado?.engineVersion}<br>
                        <strong>Method:</strong> ${resultado?.method || resultado?.scoringMethod}<br>
                        <strong>Unified Scoring:</strong> ${resultado?.unifiedScoring}<br>
                        <strong>Classification:</strong> ${resultado?.classification}<br>
                        <strong>Status:</strong> ${isSuccess ? '‚úÖ UNIFICA√á√ÉO FUNCIONANDO' : '‚ùå UNIFICA√á√ÉO COM PROBLEMA'}
                    </div>
                `;
                
                return resultado;
                
            } catch (error) {
                log('‚ùå ERRO: ' + error.message, 'error');
                log('‚ùå Stack: ' + error.stack, 'error');
                
                const container = document.getElementById('scoringResults');
                container.innerHTML = `
                    <div class="result-box error">
                        <strong>‚ùå ERRO NO TESTE:</strong><br>
                        ${error.message}
                    </div>
                `;
                
                return null;
            }
        }
        
        async function testarMultiplosGeneros() {
            log('üéµ Testando m√∫ltiplos g√™neros...');
            
            const generos = [
                {
                    nome: 'funk_mandela',
                    ref: {
                        lufs_target: -11.5,
                        tol_lufs: 1.8,
                        true_peak_target: -0.8,
                        tol_true_peak: 1,
                        dr_target: 7.2,
                        tol_dr: 2,
                        stereo_target: 0.38,
                        tol_stereo: 0.15
                    }
                },
                {
                    nome: 'trance',
                    ref: {
                        lufs_target: -12.8,
                        tol_lufs: 1.9,
                        true_peak_target: -0.8,
                        tol_true_peak: 1,
                        dr_target: 7.2,
                        tol_dr: 2,
                        stereo_target: 0.42,
                        tol_stereo: 0.14
                    }
                },
                {
                    nome: 'eletronico',
                    ref: {
                        lufs_target: -12.8,
                        tol_lufs: 1.9,
                        true_peak_target: -0.8,
                        tol_true_peak: 1,
                        dr_target: 7.2,
                        tol_dr: 2,
                        stereo_target: 0.42,
                        tol_stereo: 0.14
                    }
                }
            ];
            
            const resultados = [];
            
            for (const genero of generos) {
                log(`üéØ Testando g√™nero: ${genero.nome}`);
                
                try {
                    const scoringModule = await import(`./lib/audio/features/scoring.js?v=${Date.now()}`);
                    
                    const testData = {
                        lufsIntegrated: -14.5,
                        truePeakDbtp: -1.2,
                        dr: 8.5,
                        lra: 6.8,
                        crestFactor: 9.2,
                        stereoCorrelation: 0.25,
                        stereoWidth: 0.65,
                        balanceLR: 0.02,
                        spectralCentroid: 2800,
                        spectralFlatness: 0.22,
                        spectralRolloff85: 9200,
                        dcOffset: 0.01,
                        clippingSamples: 0,
                        clippingPct: 0
                    };
                    
                    const resultado = scoringModule.computeMixScore(testData, genero.ref);
                    
                    resultados.push({
                        genero: genero.nome,
                        score: resultado?.score || resultado?.scorePct,
                        method: resultado?.method || resultado?.scoringMethod,
                        engine: resultado?.engineVersion,
                        unified: resultado?.unifiedScoring,
                        classification: resultado?.classification
                    });
                    
                    log(`‚úÖ ${genero.nome}: ${resultado?.score || resultado?.scorePct}%`);
                    
                } catch (error) {
                    log(`‚ùå Erro em ${genero.nome}: ${error.message}`, 'error');
                    resultados.push({
                        genero: genero.nome,
                        error: error.message
                    });
                }
            }
            
            // Mostrar compara√ß√£o visual
            const container = document.getElementById('genreComparison');
            container.innerHTML = resultados.map(r => `
                <div class="genre-test">
                    <h3>üéµ ${r.genero.toUpperCase()}</h3>
                    ${r.error ? 
                        `<div style="color: #f44336;">‚ùå Erro: ${r.error}</div>` :
                        `<div><strong>Score:</strong> ${r.score}%</div>
                         <div><strong>Method:</strong> ${r.method}</div>
                         <div><strong>Engine:</strong> ${r.engine}</div>
                         <div><strong>Unified:</strong> ${r.unified ? '‚úÖ' : '‚ùå'}</div>
                         <div><strong>Classification:</strong> ${r.classification}</div>`
                    }
                </div>
            `).join('');
            
            // Verificar se s√£o diferentes
            const scores = resultados.filter(r => !r.error).map(r => r.score);
            const scoresDiferentes = new Set(scores).size > 1;
            
            log(`\nüéØ AN√ÅLISE FINAL:`);
            log(`Scores diferentes: ${scoresDiferentes ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
            log(`Todos com Engine 3.0.0: ${resultados.every(r => r.engine === '3.0.0') ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
            log(`Todos unificados: ${resultados.every(r => r.unified === true) ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
            
            return resultados;
        }
        
        function verificarLogsVercel() {
            log('üîç Verificando logs espec√≠ficos do Vercel...');
            
            // Interceptar console para capturar logs do sistema
            const originalLog = console.log;
            console.log = function(...args) {
                if (args[0] && typeof args[0] === 'string') {
                    if (args[0].includes('[SCORING_VERCEL]') || 
                        args[0].includes('[VERCEL_LOG]') ||
                        args[0].includes('[EQUAL_WEIGHT_V3]') ||
                        args[0].includes('[SCORING_ENTRY]')) {
                        log('üîç VERCEL LOG: ' + args.join(' '));
                    }
                }
                originalLog.apply(console, args);
            };
            
            log('‚úÖ Interceptador de logs ativado');
            log('üí° Execute uma an√°lise de √°udio para ver os logs em tempo real');
        }
        
        // Auto-executar teste inicial
        document.addEventListener('DOMContentLoaded', () => {
            log('üß™ Sistema de teste carregado');
            setTimeout(() => {
                log('üöÄ Executando teste autom√°tico...');
                testarScoringDireto();
            }, 1000);
        });
    </script>
</body>
</html>
