<!DOCTYPE html>
<html>
<head>
    <title>🔧 FASE 2 INTEGRATION TEST</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #fff; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #444; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.success { background: #0a3d0a; color: #4ade80; }
        .status.error { background: #3d0a0a; color: #f87171; }
        .status.info { background: #0a1a3d; color: #60a5fa; }
        button { background: #333; color: #fff; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 3px; }
        button:hover { background: #555; }
        #console { background: #111; padding: 15px; border-radius: 5px; height: 300px; overflow-y: auto; font-size: 12px; }
        .upload-area { border: 2px dashed #666; padding: 20px; text-align: center; margin: 10px 0; }
        .upload-area:hover { border-color: #999; }
    </style>
</head>
<body>
    <h1>🔧 FASE 2 INTEGRATION TEST</h1>
    <p>Teste de integração do UI Gate com sistema real</p>
    
    <div class="test-section">
        <h2>🎛️ Controles</h2>
        <button onclick="testUIGateWithRealSystem()">🔒 Testar UI Gate Real</button>
        <button onclick="testRunIdWarnings()">⚠️ Testar Warnings RUNID_ENFORCED</button>
        <button onclick="simulateRaceCondition()">🏃 Simular Race Condition</button>
        <button onclick="clearAll()">🧹 Limpar Tudo</button>
    </div>
    
    <div class="test-section">
        <h2>📂 Upload de Teste</h2>
        <div class="upload-area" onclick="document.getElementById('testFile').click()">
            <p>📁 Clique para escolher arquivo de áudio (para testes reais)</p>
            <input type="file" id="testFile" accept="audio/*" style="display:none" onchange="handleFileUpload(this.files[0])">
        </div>
    </div>
    
    <div class="test-section">
        <h2>📊 Status dos Testes</h2>
        <div id="testStatus"></div>
    </div>
    
    <div class="test-section">
        <h2>📝 Console</h2>
        <div id="console"></div>
    </div>
    
    <!-- Incluir sistema real -->
    <script src="audio-analyzer.js"></script>
    <script src="audio-analyzer-integration.js"></script>
    
    <script>
        const statusDiv = document.getElementById('testStatus');
        const consoleDiv = document.getElementById('console');
        
        function log(msg, type = 'info') {
            console.log(msg);
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleDiv.appendChild(div);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function addStatus(title, status, details = '') {
            const div = document.createElement('div');
            div.className = `status ${status}`;
            div.innerHTML = `
                <strong>${title}</strong>: ${status.toUpperCase()}<br>
                ${details ? `<small>${details}</small>` : ''}
            `;
            statusDiv.appendChild(div);
        }
        
        function clearAll() {
            statusDiv.innerHTML = '';
            consoleDiv.innerHTML = '';
            log('🧹 Console e status limpos', 'info');
        }
        
        async function testUIGateWithRealSystem() {
            log('🔒 Iniciando teste UI Gate com sistema real...', 'info');
            
            try {
                // Verificar se as funções existem
                if (typeof window.displayModalResults !== 'function') {
                    throw new Error('displayModalResults não encontrada');
                }
                
                // Criar análise mock
                const mockAnalysis1 = {
                    runId: 'test-ui-gate-001',
                    technicalData: { lufsIntegrated: -14.5 },
                    qualityOverall: { scorePct: 85 }
                };
                
                const mockAnalysis2 = {
                    runId: 'test-ui-gate-002', 
                    technicalData: { lufsIntegrated: -16.2 },
                    qualityOverall: { scorePct: 92 }
                };
                
                // Definir análise atual
                window.__CURRENT_ANALYSIS_RUN_ID__ = 'test-ui-gate-002';
                log(`📍 Análise atual definida: ${window.__CURRENT_ANALYSIS_RUN_ID__}`, 'info');
                
                // Hook para capturar tentativas de renderização
                let renderAttempts = [];
                const originalDisplayModalResults = window.displayModalResults;
                
                window.displayModalResults = function(analysis) {
                    const analysisRunId = analysis?.runId || analysis?.metadata?.runId;
                    const currentRunId = window.__CURRENT_ANALYSIS_RUN_ID__;
                    const shouldBlock = analysisRunId && currentRunId && analysisRunId !== currentRunId;
                    
                    renderAttempts.push({
                        analysisRunId,
                        currentRunId,
                        blocked: shouldBlock,
                        timestamp: Date.now()
                    });
                    
                    log(`🎨 Tentativa de renderização - runId: ${analysisRunId}, blocked: ${shouldBlock}`, shouldBlock ? 'error' : 'success');
                    
                    // Chamar lógica original
                    return originalDisplayModalResults.call(this, analysis);
                };
                
                // Testar renderização da análise antiga (deve ser bloqueada)
                log('🔄 Tentando renderizar análise antiga...', 'info');
                window.displayModalResults(mockAnalysis1);
                
                // Testar renderização da análise atual (deve passar)
                log('🔄 Tentando renderizar análise atual...', 'info');
                window.displayModalResults(mockAnalysis2);
                
                // Verificar resultados
                const blockedAttempts = renderAttempts.filter(a => a.blocked);
                const allowedAttempts = renderAttempts.filter(a => !a.blocked);
                
                // Restaurar função original
                window.displayModalResults = originalDisplayModalResults;
                
                if (blockedAttempts.length === 1 && allowedAttempts.length === 1) {
                    addStatus('UI Gate Real', 'success', `Bloqueou ${blockedAttempts.length} análise(s) obsoleta(s), permitiu ${allowedAttempts.length} atual`);
                    log('✅ Teste UI Gate Real PASSOU', 'success');
                } else {
                    addStatus('UI Gate Real', 'error', `Esperado: 1 bloqueada + 1 permitida. Obtido: ${blockedAttempts.length} bloqueadas + ${allowedAttempts.length} permitidas`);
                    log('❌ Teste UI Gate Real FALHOU', 'error');
                }
                
            } catch (error) {
                log(`❌ Erro no teste UI Gate Real: ${error.message}`, 'error');
                addStatus('UI Gate Real', 'error', error.message);
            }
        }
        
        async function testRunIdWarnings() {
            log('⚠️ Testando warnings RUNID_ENFORCED...', 'info');
            
            try {
                // Verificar se AudioAnalyzer existe
                if (typeof window.AudioAnalyzer === 'undefined') {
                    throw new Error('AudioAnalyzer não disponível');
                }
                
                // Capturar warnings no console
                let warnings = [];
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    warnings.push(args.join(' '));
                    return originalWarn.apply(console, args);
                };
                
                // Simular chamada sem runId em ambiente rigoroso
                const analyzer = new AudioAnalyzer();
                
                // Mock de arquivo para teste
                const mockFile = new File(['mock'], 'test.mp3', { type: 'audio/mp3' });
                
                // Tentar análise sem runId (deve gerar warning se RUNID_ENFORCED=true)
                try {
                    await analyzer.analyzeAudioFile(mockFile, {});
                } catch (e) {
                    // Ignorar erros de análise, focamos nos warnings
                }
                
                // Restaurar console.warn
                console.warn = originalWarn;
                
                // Verificar se warning foi gerado
                const runIdWarnings = warnings.filter(w => w.includes('RUNID_ENFORCED'));
                
                if (runIdWarnings.length > 0) {
                    addStatus('RUNID_ENFORCED Warnings', 'success', `${runIdWarnings.length} warning(s) gerado(s) corretamente`);
                    log('✅ Warnings RUNID_ENFORCED funcionando', 'success');
                } else {
                    addStatus('RUNID_ENFORCED Warnings', 'info', 'Nenhum warning gerado (RUNID_ENFORCED pode estar desabilitado)');
                    log('ℹ️ RUNID_ENFORCED pode estar desabilitado neste ambiente', 'info');
                }
                
            } catch (error) {
                log(`❌ Erro no teste de warnings: ${error.message}`, 'error');
                addStatus('RUNID_ENFORCED Warnings', 'error', error.message);
            }
        }
        
        async function simulateRaceCondition() {
            log('🏃 Simulando race condition...', 'info');
            
            try {
                // Simular duas análises concorrentes
                const runId1 = 'race-' + Date.now() + '-001';
                const runId2 = 'race-' + Date.now() + '-002';
                
                log(`🚀 Iniciando análise 1: ${runId1}`, 'info');
                window.__CURRENT_ANALYSIS_RUN_ID__ = runId1;
                
                // Simular delay da primeira análise
                setTimeout(() => {
                    log(`🎨 Análise 1 tentando renderizar (tardia)...`, 'info');
                    if (window.displayModalResults) {
                        window.displayModalResults({ runId: runId1, technicalData: {} });
                    }
                }, 100);
                
                // Rapidamente iniciar segunda análise
                setTimeout(() => {
                    log(`🚀 Iniciando análise 2: ${runId2}`, 'info');
                    window.__CURRENT_ANALYSIS_RUN_ID__ = runId2;
                    
                    // Análise 2 completa rapidamente
                    setTimeout(() => {
                        log(`🎨 Análise 2 tentando renderizar (atual)...`, 'info');
                        if (window.displayModalResults) {
                            window.displayModalResults({ runId: runId2, technicalData: {} });
                        }
                    }, 20);
                }, 50);
                
                setTimeout(() => {
                    addStatus('Race Condition', 'success', 'Simulação de race condition executada - verificar logs para comportamento');
                    log('✅ Simulação de race condition concluída', 'success');
                }, 200);
                
            } catch (error) {
                log(`❌ Erro na simulação: ${error.message}`, 'error');
                addStatus('Race Condition', 'error', error.message);
            }
        }
        
        function handleFileUpload(file) {
            if (!file) return;
            
            log(`📁 Arquivo selecionado: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'info');
            
            // Testar análise real com UI Gate
            if (window.AudioAnalyzer) {
                const analyzer = new AudioAnalyzer();
                const runId = 'real-analysis-' + Date.now();
                
                log(`🎵 Iniciando análise real com runId: ${runId}`, 'info');
                window.__CURRENT_ANALYSIS_RUN_ID__ = runId;
                
                analyzer.analyzeAudioFile(file, { runId }).then(analysis => {
                    log(`✅ Análise real concluída`, 'success');
                    addStatus('Análise Real', 'success', `Arquivo analisado com runId: ${runId}`);
                }).catch(error => {
                    log(`❌ Erro na análise real: ${error.message}`, 'error');
                    addStatus('Análise Real', 'error', error.message);
                });
            }
        }
        
        // Setup inicial
        window.addEventListener('load', function() {
            log('🔧 Sistema de teste Fase 2 carregado', 'success');
            log('🔍 Verificando componentes...', 'info');
            
            // Verificar se componentes estão disponíveis
            const components = {
                'AudioAnalyzer': typeof window.AudioAnalyzer !== 'undefined',
                'displayModalResults': typeof window.displayModalResults !== 'undefined',
                'RUNID_ENFORCED': typeof window.RUNID_ENFORCED !== 'undefined'
            };
            
            Object.entries(components).forEach(([name, available]) => {
                log(`📦 ${name}: ${available ? '✅ Disponível' : '❌ Não encontrado'}`, available ? 'success' : 'error');
            });
            
            log('🎯 Pronto para testes de integração Fase 2', 'info');
        });
    </script>
</body>
</html>
