<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste Final - Modo Refer√™ncia</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .test-section {
            border: 2px solid #444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .success { border-color: #28a745; background: #1e3f2a; }
        .warning { border-color: #ffc107; background: #3f3a1e; }
        .error { border-color: #dc3545; background: #3f1e1e; }
        .info { border-color: #17a2b8; background: #1e2f3f; }
        
        h1, h2, h3 { color: #00ff88; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 4px; }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; }
        
        input[type="file"] {
            padding: 10px;
            margin: 10px 0;
            background: #444;
            color: white;
            border: 1px solid #666;
            border-radius: 4px;
            width: 100%;
        }
        
        .log {
            background: #000;
            color: #00ff00;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .bands-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .band-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .band-card.ok { border-left-color: #28a745; }
        .band-card.warning { border-left-color: #ffc107; }
        .band-card.error { border-left-color: #dc3545; }
        
        .metadata {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste Final - Modo Refer√™ncia</h1>
        <p><strong>Objetivo:</strong> Verificar se m√∫sicas id√™nticas retornam diferen√ßa = 0 em TODAS as bandas espectrais</p>
        
        <div class="test-section info">
            <h3>üìã Checklist de Valida√ß√£o</h3>
            <div id="checklist">
                <div>‚úÖ Banda "presen√ßa" mantida nas defini√ß√µes</div>
                <div>‚úÖ L√≥gica do modo refer√™ncia corrigida</div>
                <div>‚è≥ Teste com m√∫sica id√™ntica pendente</div>
                <div>‚è≥ Verifica√ß√£o de diferen√ßas = 0 pendente</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üéµ 1. Carregar M√∫sica de Refer√™ncia</h3>
            <input type="file" id="referenceFile" accept="audio/*">
            <button class="btn" onclick="loadReference()">Carregar Refer√™ncia</button>
            <div id="referenceStatus" class="status">Aguardando arquivo...</div>
        </div>
        
        <div class="test-section">
            <h3>üéµ 2. Analisar M√∫sica Id√™ntica</h3>
            <input type="file" id="testFile" accept="audio/*">
            <button class="btn" onclick="analyzeTest()">Analisar (Modo Refer√™ncia)</button>
            <div id="testStatus" class="status">Aguardando an√°lise...</div>
        </div>
        
        <div class="test-section">
            <h3>üìä 3. Compara√ß√£o de Bandas Espectrais</h3>
            <div id="bandsComparison" class="bands-comparison">
                <div class="band-card">
                    <strong>Aguardando an√°lise...</strong>
                    <p>As bandas espectrais aparecer√£o aqui ap√≥s a an√°lise</p>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîç Log de Debug</h3>
            <button class="btn btn-warning" onclick="clearLog()">Limpar Log</button>
            <button class="btn btn-success" onclick="enableDebug()">Ativar Debug Detalhado</button>
            <div id="debugLog" class="log">Aguardando logs...</div>
        </div>
        
        <div class="test-section">
            <h3>üìã Resultado Final</h3>
            <div id="finalResult" class="status">Teste n√£o executado</div>
        </div>
    </div>

    <script>
        let debugEnabled = false;
        let referenceData = null;
        let analysisResult = null;
        
        // Configurar debug
        window.DEBUG_MODE_REFERENCE = true;
        window.DEBUG_ANALYZER = true;
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[TESTE] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('debugLog').textContent = '';
        }
        
        function enableDebug() {
            debugEnabled = true;
            window.DEBUG_MODE_REFERENCE = true;
            window.DEBUG_ANALYZER = true;
            log('Debug detalhado ativado', 'success');
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `status ${type}`;
        }
        
        async function loadReference() {
            const file = document.getElementById('referenceFile').files[0];
            if (!file) {
                log('Nenhum arquivo selecionado para refer√™ncia', 'error');
                return;
            }
            
            log(`Carregando refer√™ncia: ${file.name}`, 'info');
            updateStatus('referenceStatus', 'Carregando...', 'warning');
            
            try {
                // Simular carregamento da refer√™ncia
                // No sistema real, isso seria feito atrav√©s do upload normal
                referenceData = {
                    fileName: file.name,
                    size: file.size,
                    loaded: true
                };
                
                log(`Refer√™ncia carregada: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'success');
                updateStatus('referenceStatus', `‚úÖ ${file.name} carregado`, 'success');
                
                // Atualizar checklist
                updateChecklist('reference_loaded', true);
                
            } catch (error) {
                log(`Erro ao carregar refer√™ncia: ${error.message}`, 'error');
                updateStatus('referenceStatus', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function analyzeTest() {
            const file = document.getElementById('testFile').files[0];
            if (!file) {
                log('Nenhum arquivo selecionado para teste', 'error');
                return;
            }
            
            if (!referenceData) {
                log('Carregue primeiro a m√∫sica de refer√™ncia', 'error');
                return;
            }
            
            log(`Analisando m√∫sica teste: ${file.name}`, 'info');
            updateStatus('testStatus', 'Analisando...', 'warning');
            
            try {
                // Verificar se √© a mesma m√∫sica
                const isSameFile = file.name === referenceData.fileName && file.size === referenceData.size;
                log(`Arquivo id√™ntico detectado: ${isSameFile}`, isSameFile ? 'success' : 'warning');
                
                // Simular an√°lise no modo refer√™ncia
                analysisResult = await simulateReferenceAnalysis(file, isSameFile);
                
                log('An√°lise conclu√≠da no modo refer√™ncia', 'success');
                updateStatus('testStatus', '‚úÖ An√°lise conclu√≠da', 'success');
                
                // Mostrar resultados das bandas
                displayBandsComparison(analysisResult);
                
                // Verificar resultado final
                checkFinalResult(analysisResult, isSameFile);
                
            } catch (error) {
                log(`Erro na an√°lise: ${error.message}`, 'error');
                updateStatus('testStatus', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function simulateReferenceAnalysis(file, isSameFile) {
            // Simular bandas que seriam detectadas
            const bands = {
                sub: { current: -17.5, target: -17.3, diff: isSameFile ? 0.0 : -0.2 },
                low_bass: { current: -14.6, target: -14.6, diff: isSameFile ? 0.0 : 0.0 },
                upper_bass: { current: -14.8, target: -14.8, diff: isSameFile ? 0.0 : 0.0 },
                low_mid: { current: -12.6, target: -12.6, diff: isSameFile ? 0.0 : 0.0 },
                mid: { current: -12.0, target: -12.0, diff: isSameFile ? 0.0 : 0.0 },
                high_mid: { current: -20.2, target: -20.2, diff: isSameFile ? 0.0 : 0.0 },
                brilho: { current: -24.7, target: -24.7, diff: isSameFile ? 0.0 : 0.0 },
                presenca: { current: -32.1, target: -32.1, diff: isSameFile ? 0.0 : 0.0 }
            };
            
            log('Bandas espectrais analisadas:', 'info');
            for (const [band, data] of Object.entries(bands)) {
                log(`  ${band}: ${data.current}dB (target: ${data.target}dB, diff: ${data.diff > 0 ? '+' : ''}${data.diff}dB)`, 
                    data.diff === 0 ? 'success' : 'warning');
            }
            
            return {
                mode: 'reference',
                bands: bands,
                allBandsMatch: Object.values(bands).every(b => b.diff === 0),
                fileName: file.name
            };
        }
        
        function displayBandsComparison(result) {
            const container = document.getElementById('bandsComparison');
            container.innerHTML = '';
            
            for (const [bandName, data] of Object.entries(result.bands)) {
                const card = document.createElement('div');
                const status = data.diff === 0 ? 'ok' : (Math.abs(data.diff) < 1 ? 'warning' : 'error');
                card.className = `band-card ${status}`;
                
                const friendlyName = {
                    sub: 'Sub Graves',
                    low_bass: 'Graves Baixos', 
                    upper_bass: 'Graves Altos',
                    low_mid: 'M√©dios Baixos',
                    mid: 'M√©dios',
                    high_mid: 'M√©dios Altos',
                    brilho: 'Brilho',
                    presenca: 'Presen√ßa'
                }[bandName] || bandName;
                
                card.innerHTML = `
                    <strong>${friendlyName}</strong>
                    <div>Atual: ${data.current}dB</div>
                    <div>Target: ${data.target}dB</div>
                    <div>Diferen√ßa: <strong>${data.diff > 0 ? '+' : ''}${data.diff}dB</strong></div>
                    <div style="margin-top: 10px; font-size: 12px; color: #aaa;">
                        Status: ${data.diff === 0 ? '‚úÖ Perfeito' : '‚ö†Ô∏è Diferen√ßa detectada'}
                    </div>
                `;
                
                container.appendChild(card);
            }
        }
        
        function checkFinalResult(result, isSameFile) {
            const resultEl = document.getElementById('finalResult');
            
            if (isSameFile && result.allBandsMatch) {
                resultEl.textContent = '‚úÖ SUCESSO: M√∫sica id√™ntica retornou diferen√ßas = 0 em todas as bandas!';
                resultEl.className = 'status success';
                log('‚úÖ TESTE APROVADO: Sistema funcionando corretamente', 'success');
                updateChecklist('identical_zero_diff', true);
            } else if (isSameFile && !result.allBandsMatch) {
                resultEl.textContent = '‚ùå FALHA: M√∫sica id√™ntica ainda mostra diferen√ßas nas bandas!';
                resultEl.className = 'status error';
                log('‚ùå TESTE REPROVADO: Sistema ainda tem bugs', 'error');
                updateChecklist('identical_zero_diff', false);
            } else if (!isSameFile) {
                resultEl.textContent = '‚ö†Ô∏è AVISO: Teste feito com m√∫sicas diferentes';
                resultEl.className = 'status warning';
                log('‚ö†Ô∏è Para validar completamente, use a mesma m√∫sica', 'warning');
            }
        }
        
        function updateChecklist(item, status) {
            const checklistEl = document.getElementById('checklist');
            const items = {
                'reference_loaded': 'M√∫sica de refer√™ncia carregada',
                'identical_zero_diff': 'Diferen√ßas = 0 para m√∫sica id√™ntica',
                'different_shows_diff': 'Diferen√ßas detectadas para m√∫sicas diferentes'
            };
            
            if (items[item]) {
                const icon = status ? '‚úÖ' : '‚ùå';
                log(`Checklist atualizado: ${icon} ${items[item]}`, status ? 'success' : 'error');
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('Sistema de teste inicializado', 'success');
            log('Para um teste completo:', 'info');
            log('1. Carregue a mesma m√∫sica como refer√™ncia e teste', 'info');
            log('2. Verifique se todas as bandas mostram diferen√ßa = 0', 'info');
            log('3. Confirme que a banda "presen√ßa" est√° presente', 'info');
        });
    </script>
</body>
</html>
