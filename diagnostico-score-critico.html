<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ DIAGN√ìSTICO CR√çTICO - Por que o Score N√£o Muda?</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #0a0a0a;
            color: #00ff41;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #111;
            border: 2px solid #00ff41;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #00ff41;
            padding-bottom: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #1a1a1a;
            border-left: 4px solid #ff6b35;
            border-radius: 5px;
        }
        .critical {
            border-left-color: #ff3333;
            background: #2a1a1a;
        }
        .success {
            border-left-color: #00ff41;
            background: #1a2a1a;
        }
        .warning {
            border-left-color: #ffaa00;
            background: #2a2a1a;
        }
        button {
            background: #00ff41;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        button:hover {
            background: #00cc33;
            transform: scale(1.05);
        }
        button:active {
            transform: scale(0.95);
        }
        .log-output {
            background: #000;
            color: #00ff41;
            padding: 20px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .hypothesis {
            background: #2a1a2a;
            border: 1px solid #ff66aa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .evidence {
            background: #1a2a2a;
            border: 1px solid #66aaff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .solution {
            background: #2a2a1a;
            border: 1px solid #aaff66;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
        }
        .status.error { background: #ff3333; color: white; }
        .status.warning { background: #ffaa00; color: black; }
        .status.success { background: #00ff41; color: black; }
        .status.info { background: #66aaff; color: black; }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ DIAGN√ìSTICO CR√çTICO</h1>
            <h2>Por que o Score N√£o Muda Mesmo com as Corre√ß√µes?</h2>
            <p><span class="status error">PROBLEMA</span> Score permanece em 36 pontos independente das bandas espectrais</p>
        </div>

        <div class="section critical">
            <h3>üö® DESCOBERTA CR√çTICA</h3>
            <p><strong>A "corre√ß√£o" da ordem de execu√ß√£o foi DESNECESS√ÅRIA!</strong></p>
            <ul>
                <li><strong>Linha 1411:</strong> <code>if (false && enableScoring)</code> - Scoring J√Å estava desabilitado na Fase 1</li>
                <li><strong>Linha 1931:</strong> Scoring J√Å acontece ap√≥s Fase 2 com bandas calculadas</li>
                <li><strong>Linha 3701:</strong> <code>td.bandEnergies = bandEnergies</code> - Bandas S√ÉO adicionadas corretamente</li>
            </ul>
        </div>

        <div class="section warning">
            <h3>üéØ HIP√ìTESES PARA INVESTIGA√á√ÉO</h3>
            <div class="hypothesis">
                <strong>A. bandEnergies n√£o chegam ao scoring</strong><br>
                As bandas s√£o calculadas mas se perdem no caminho
            </div>
            <div class="hypothesis">
                <strong>B. Scoring n√£o considera bandEnergies</strong><br>
                A fun√ß√£o computeMixScore ignora as bandas espectrais
            </div>
            <div class="hypothesis">
                <strong>C. Refer√™ncia sem targets de bandas</strong><br>
                N√£o h√° dados de refer√™ncia para comparar as bandas
            </div>
            <div class="hypothesis">
                <strong>D. Cache invalidando dados</strong><br>
                Cache est√° removendo bandEnergies entre c√°lculo e scoring
            </div>
            <div class="hypothesis">
                <strong>E. Race condition temporal</strong><br>
                Timing entre fases est√° causando perda de dados
            </div>
        </div>

        <div class="section">
            <h3>üîß FERRAMENTAS DE DIAGN√ìSTICO</h3>
            <div class="grid">
                <div>
                    <button onclick="executarDiagnosticoCompleto()">
                        üî¨ Diagn√≥stico Completo
                    </button>
                    <br><small>Analisa todas as hip√≥teses e coleta evid√™ncias</small>
                </div>
                <div>
                    <button onclick="ativarMonitoramento()">
                        üëÅÔ∏è Monitor Tempo Real
                    </button>
                    <br><small>Instala hooks para monitorar scoring em tempo real</small>
                </div>
            </div>
            <div class="grid">
                <div>
                    <button onclick="testarScoringManual()">
                        üß™ Teste Manual Scoring
                    </button>
                    <br><small>Testa scoring com e sem bandas para comparar</small>
                </div>
                <div>
                    <button onclick="verificarVercelDeploy()">
                        üåê Verificar Deploy Vercel
                    </button>
                    <br><small>Confirma se mudan√ßas foram aplicadas na produ√ß√£o</small>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>üìä RESULTADOS DO DIAGN√ìSTICO</h3>
            <div id="resultados" class="log-output">
                Clique em "Diagn√≥stico Completo" para come√ßar a investiga√ß√£o...
            </div>
        </div>

        <div class="section success">
            <h3>üí° PR√ìXIMOS PASSOS</h3>
            <div class="solution">
                <strong>1. Executar diagn√≥stico para identificar o problema real</strong><br>
                Usar as ferramentas acima para encontrar a causa raiz
            </div>
            <div class="solution">
                <strong>2. Investigar os outros 5 problemas da auditoria</strong><br>
                Fallbacks, convers√£o de unidades, pesos, cache, convers√£o de bandas
            </div>
            <div class="solution">
                <strong>3. Implementar corre√ß√£o baseada em evid√™ncias</strong><br>
                N√£o mais "chutes" - s√≥ corre√ß√µes baseadas em dados reais
            </div>
        </div>
    </div>

    <!-- Carregar depend√™ncias -->
    <script src="diagnostico-score-problema.js"></script>
    
    <script>
        // Vari√°vel global para armazenar √∫ltimo diagn√≥stico
        let ultimoDiagnostico = null;
        
        /**
         * Executa diagn√≥stico completo e exibe resultados
         */
        async function executarDiagnosticoCompleto() {
            const output = document.getElementById('resultados');
            output.innerHTML = 'üîÑ Executando diagn√≥stico completo...\n';
            
            try {
                // Verificar se fun√ß√£o est√° dispon√≠vel
                if (typeof window.diagnosticarScoreProblema !== 'function') {
                    throw new Error('Fun√ß√£o de diagn√≥stico n√£o carregada. Recarregue a p√°gina.');
                }
                
                // Executar diagn√≥stico
                ultimoDiagnostico = window.diagnosticarScoreProblema();
                
                // Formatar resultados
                let resultado = 'üî¨ DIAGN√ìSTICO COMPLETO EXECUTADO\n';
                resultado += '='.repeat(50) + '\n\n';
                
                resultado += 'üìÖ Timestamp: ' + ultimoDiagnostico.timestamp + '\n\n';
                
                // Evid√™ncias
                resultado += 'üìä EVID√äNCIAS COLETADAS:\n';
                resultado += '-'.repeat(30) + '\n';
                for (const [key, value] of Object.entries(ultimoDiagnostico.evidencias)) {
                    resultado += `${key}: ${JSON.stringify(value, null, 2)}\n`;
                }
                resultado += '\n';
                
                // Hip√≥teses
                resultado += 'üéØ HIP√ìTESES IDENTIFICADAS:\n';
                resultado += '-'.repeat(30) + '\n';
                ultimoDiagnostico.hipoteses.forEach((h, i) => {
                    resultado += `${i + 1}. ${h}\n`;
                });
                resultado += '\n';
                
                // Solu√ß√µes
                resultado += 'üí° SOLU√á√ïES PROPOSTAS:\n';
                resultado += '-'.repeat(30) + '\n';
                ultimoDiagnostico.solucoes.forEach((s, i) => {
                    resultado += `${i + 1}. ${s}\n`;
                });
                
                if (ultimoDiagnostico.erro) {
                    resultado += '\n‚ùå ERRO: ' + ultimoDiagnostico.erro + '\n';
                }
                
                output.innerHTML = resultado;
                
            } catch (error) {
                output.innerHTML = '‚ùå ERRO no diagn√≥stico: ' + error.message + '\n\n' +
                    'Poss√≠veis causas:\n' +
                    '1. P√°gina n√£o carregou completamente\n' +
                    '2. Scripts n√£o foram carregados\n' +
                    '3. Sistema de √°udio n√£o inicializado\n\n' +
                    'Recarregue a p√°gina e tente novamente.';
                console.error('Erro no diagn√≥stico:', error);
            }
        }
        
        /**
         * Ativa monitoramento em tempo real
         */
        function ativarMonitoramento() {
            const output = document.getElementById('resultados');
            
            try {
                if (typeof window.monitorarScoreEmTempoReal !== 'function') {
                    throw new Error('Fun√ß√£o de monitoramento n√£o carregada');
                }
                
                window.monitorarScoreEmTempoReal();
                
                output.innerHTML = 'üëÅÔ∏è MONITORAMENTO ATIVADO\n' +
                    '='.repeat(30) + '\n\n' +
                    '‚úÖ Hooks instalados em computeMixScore\n' +
                    'üì° Logs aparecer√£o no console durante an√°lises\n' +
                    'üéØ Execute uma an√°lise de √°udio para ver os logs\n\n' +
                    '‚ö†Ô∏è Abra o Console do Navegador (F12) para ver os logs detalhados';
                
            } catch (error) {
                output.innerHTML = '‚ùå ERRO ao ativar monitoramento: ' + error.message;
                console.error('Erro no monitoramento:', error);
            }
        }
        
        /**
         * Testa scoring manual com dados simulados
         */
        async function testarScoringManual() {
            const output = document.getElementById('resultados');
            output.innerHTML = 'üß™ Executando teste manual de scoring...\n';
            
            try {
                // Dados de teste COM bandas
                const testComBandas = {
                    lufsIntegrated: -14.2,
                    truePeakDbtp: -1.5,
                    dynamicRange: 8.5,
                    lra: 6.2,
                    stereoCorrelation: 0.85,
                    bandEnergies: {
                        sub: { rms_db: -18.5, energy: 0.012, energyPct: 8.2 },
                        low_bass: { rms_db: -12.3, energy: 0.045, energyPct: 15.1 },
                        upper_bass: { rms_db: -10.1, energy: 0.058, energyPct: 18.7 },
                        low_mid: { rms_db: -8.7, energy: 0.072, energyPct: 22.3 },
                        mid: { rms_db: -9.2, energy: 0.065, energyPct: 19.8 },
                        high_mid: { rms_db: -15.1, energy: 0.028, energyPct: 10.4 },
                        brilho: { rms_db: -22.3, energy: 0.008, energyPct: 3.8 },
                        presenca: { rms_db: -24.1, energy: 0.005, energyPct: 1.7 }
                    }
                };
                
                // Dados de teste SEM bandas
                const testSemBandas = {
                    lufsIntegrated: -14.2,
                    truePeakDbtp: -1.5,
                    dynamicRange: 8.5,
                    lra: 6.2,
                    stereoCorrelation: 0.85
                };
                
                let resultado = 'üß™ TESTE MANUAL DE SCORING\n';
                resultado += '='.repeat(40) + '\n\n';
                
                // Verificar se scoring est√° dispon√≠vel
                if (typeof window !== 'undefined' && window.scoringModule && window.scoringModule.computeMixScore) {
                    // Obter refer√™ncia
                    const ref = window.PROD_AI_REF_DATA_ACTIVE || window.PROD_AI_REF_DATA;
                    if (!ref) {
                        throw new Error('Refer√™ncia de dados n√£o encontrada');
                    }
                    
                    const activeGenre = window.PROD_AI_REF_GENRE || 'default';
                    const genreRef = ref[activeGenre];
                    
                    // Teste com bandas
                    const scoreComBandas = window.scoringModule.computeMixScore(testComBandas, genreRef);
                    const scoreSemBandas = window.scoringModule.computeMixScore(testSemBandas, genreRef);
                    
                    resultado += 'üìä DADOS DE ENTRADA:\n';
                    resultado += `G√™nero ativo: ${activeGenre}\n`;
                    resultado += `Refer√™ncia tem bandas: ${!!(genreRef && genreRef.bands)}\n`;
                    resultado += `N√∫mero de targets de bandas: ${genreRef && genreRef.bands ? Object.keys(genreRef.bands).length : 0}\n\n`;
                    
                    resultado += 'üéØ RESULTADOS DOS TESTES:\n';
                    resultado += `Score COM bandas: ${scoreComBandas ? scoreComBandas.scorePct : 'null'}%\n`;
                    resultado += `Score SEM bandas: ${scoreSemBandas ? scoreSemBandas.scorePct : 'null'}%\n`;
                    
                    if (scoreComBandas && scoreSemBandas) {
                        const diferenca = scoreComBandas.scorePct - scoreSemBandas.scorePct;
                        resultado += `Diferen√ßa: ${diferenca.toFixed(2)} pontos\n\n`;
                        
                        if (Math.abs(diferenca) < 1) {
                            resultado += '‚ö†Ô∏è PROBLEMA IDENTIFICADO: Scoring n√£o considera bandas espectrais!\n';
                            resultado += '   A diferen√ßa √© < 1 ponto, indicando que bandEnergies s√£o ignoradas.\n';
                        } else {
                            resultado += '‚úÖ Scoring CONSIDERA bandas espectrais corretamente.\n';
                            resultado += '   Problema deve estar em outro lugar.\n';
                        }
                        
                        resultado += '\nüìã DETALHES DO SCORING:\n';
                        resultado += `M√©todo usado (com bandas): ${scoreComBandas.scoringMethod || 'N/A'}\n`;
                        resultado += `M√©todo usado (sem bandas): ${scoreSemBandas.scoringMethod || 'N/A'}\n`;
                    }
                    
                } else {
                    resultado += '‚ùå M√≥dulo de scoring n√£o dispon√≠vel\n';
                    resultado += 'Poss√≠veis causas:\n';
                    resultado += '1. P√°gina n√£o carregou completamente\n';
                    resultado += '2. Sistema de √°udio n√£o inicializado\n';
                    resultado += '3. Scripts de scoring n√£o carregados\n';
                }
                
                output.innerHTML = resultado;
                
            } catch (error) {
                output.innerHTML = '‚ùå ERRO no teste manual: ' + error.message;
                console.error('Erro no teste manual:', error);
            }
        }
        
        /**
         * Verifica se deploy foi feito no Vercel
         */
        async function verificarVercelDeploy() {
            const output = document.getElementById('resultados');
            output.innerHTML = 'üåê Verificando deploy no Vercel...\n';
            
            try {
                let resultado = 'üåê VERIFICA√á√ÉO DE DEPLOY VERCEL\n';
                resultado += '='.repeat(40) + '\n\n';
                
                // Verificar se arquivos de corre√ß√£o existem
                const arquivosCorrecao = [
                    'solucao-definitiva-score.js',
                    'diagnostico-score-problema.js'
                ];
                
                resultado += 'üìÅ ARQUIVOS DE CORRE√á√ÉO:\n';
                for (const arquivo of arquivosCorrecao) {
                    try {
                        const response = await fetch(arquivo);
                        if (response.ok) {
                            resultado += `‚úÖ ${arquivo} - Encontrado (${response.status})\n`;
                        } else {
                            resultado += `‚ùå ${arquivo} - N√£o encontrado (${response.status})\n`;
                        }
                    } catch (error) {
                        resultado += `‚ùå ${arquivo} - Erro: ${error.message}\n`;
                    }
                }
                
                resultado += '\nüîç CACHE BUSTING:\n';
                resultado += `Timestamp atual: ${Date.now()}\n`;
                resultado += `Cache buster ativo: ${!!window.cacheBusterTimestamp}\n`;
                
                resultado += '\n‚ö†Ô∏è IMPORTANTE:\n';
                resultado += 'Se os arquivos n√£o foram encontrados:\n';
                resultado += '1. Deploy pode n√£o ter sido feito\n';
                resultado += '2. Cache do Vercel pode estar ativo\n';
                resultado += '3. Build pode ter falhado\n\n';
                resultado += 'Verifique o dashboard do Vercel para confirmar deploy.';
                
                output.innerHTML = resultado;
                
            } catch (error) {
                output.innerHTML = '‚ùå ERRO na verifica√ß√£o: ' + error.message;
                console.error('Erro na verifica√ß√£o Vercel:', error);
            }
        }
        
        // Carregar diagn√≥stico automaticamente se poss√≠vel
        window.addEventListener('load', () => {
            console.log('üî¨ [DIAGN√ìSTICO] P√°gina carregada, fun√ß√µes dispon√≠veis:');
            console.log('   - executarDiagnosticoCompleto()');
            console.log('   - ativarMonitoramento()');
            console.log('   - testarScoringManual()');
            console.log('   - verificarVercelDeploy()');
        });
    </script>
</body>
</html>
