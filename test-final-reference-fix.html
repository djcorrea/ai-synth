<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Teste Final - CorreÃ§Ã£o Bug Modo ReferÃªncia</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; font-family: 'Consolas', monospace; font-size: 12px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; margin: 10px 0; max-height: 300px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 11px; }
        .critical { border-left: 4px solid #dc3545; background: #fff5f5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Teste Final - CorreÃ§Ã£o Bug Modo ReferÃªncia</h1>
        <p><strong>Objetivo:</strong> Verificar se o sistema agora usa mÃ©tricas da referÃªncia especÃ­fica</p>
        
        <button onclick="testCompleteReferenceFlow()">ğŸ§ª Testar Fluxo Completo de ReferÃªncia</button>
        <button onclick="testGenreVsReferenceTargets()">ğŸ¯ Testar Targets: GÃªnero vs ReferÃªncia</button>
        <button onclick="clearResults()">ğŸ§¹ Limpar</button>
        
        <div id="results"></div>
        <div id="logs" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            logDiv.innerHTML += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function addResult(success, message, critical = false) {
            const resultsDiv = document.getElementById('results');
            let resultClass = success ? 'success' : 'error';
            if (critical) resultClass += ' critical';
            resultsDiv.innerHTML += `<div class="test-result ${resultClass}">${message}</div>`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('logs').innerHTML = '';
        }

        async function testCompleteReferenceFlow() {
            clearResults();
            log('=== TESTE COMPLETO DO FLUXO DE REFERÃŠNCIA ===');
            
            try {
                // 1. Simular targets de gÃªnero existentes (Funk)
                const originalRefData = window.PROD_AI_REF_DATA;
                const originalRefGenre = window.PROD_AI_REF_GENRE;
                
                window.PROD_AI_REF_DATA = {
                    funk: { 
                        lufs: -8.0, 
                        stereoCorrelation: 0.9,
                        dynamicRange: 6.0,
                        truePeak: -0.5
                    }
                };
                window.PROD_AI_REF_GENRE = 'funk';
                
                log('Targets de gÃªnero FUNK configurados: LUFS=-8.0, Stereo=0.9');
                addResult(true, 'âœ… PASSO 1: Targets de gÃªnero Funk configurados');
                
                // 2. Simular targets da mÃºsica de referÃªncia (diferentes do Funk)
                const referenceTargets = {
                    lufs: -12.5,          // DIFERENTE do funk (-8.0)
                    stereoCorrelation: 0.75,  // DIFERENTE do funk (0.9)
                    dynamicRange: 8.3,    // DIFERENTE do funk (6.0)
                    truePeak: -0.8        // DIFERENTE do funk (-0.5)
                };
                
                log('Targets da REFERÃŠNCIA extraÃ­dos: LUFS=-12.5, Stereo=0.75');
                addResult(true, 'âœ… PASSO 2: Targets da referÃªncia extraÃ­dos (DIFERENTES do funk)');
                
                // 3. Aplicar sistema de referÃªncia temporariamente
                window.PROD_AI_REF_DATA = {
                    funk: window.PROD_AI_REF_DATA.funk, // Manter funk original
                    reference_music: referenceTargets   // Adicionar targets da referÃªncia
                };
                window.PROD_AI_REF_GENRE = 'reference_music';
                
                log('Sistema configurado para usar reference_music ao invÃ©s de funk');
                addResult(true, 'âœ… PASSO 3: Sistema redirecionado para targets da referÃªncia');
                
                // 4. Verificar se o sistema pegaria os targets corretos
                const activeGenre = window.PROD_AI_REF_GENRE;
                const activeTargets = window.PROD_AI_REF_DATA[activeGenre];
                
                if (activeTargets && activeTargets.lufs === -12.5) {
                    log('Sistema encontrou targets corretos da referÃªncia');
                    addResult(true, 'âœ… PASSO 4: Sistema encontrou targets da referÃªncia (-12.5 LUFS)');
                } else {
                    log('ERRO: Sistema nÃ£o encontrou targets da referÃªncia', 'error');
                    addResult(false, 'âŒ PASSO 4: Sistema nÃ£o encontrou targets da referÃªncia');
                    return;
                }
                
                // 5. Simular anÃ¡lise do usuÃ¡rio com targets da referÃªncia
                const userMetrics = {
                    lufs: -14.2,  // Mais baixo que referÃªncia (-12.5)
                    stereoCorrelation: 0.82,  // Maior que referÃªncia (0.75)
                    dynamicRange: 6.8,  // Menor que referÃªncia (8.3)
                    truePeak: -1.1   // Menor que referÃªncia (-0.8)
                };
                
                // 6. Calcular diferenÃ§as baseadas na REFERÃŠNCIA (nÃ£o no gÃªnero funk)
                const differences = {
                    lufs: userMetrics.lufs - referenceTargets.lufs,  // -14.2 - (-12.5) = -1.7
                    stereoCorrelation: userMetrics.stereoCorrelation - referenceTargets.stereoCorrelation,  // 0.82 - 0.75 = +0.07
                    dynamicRange: userMetrics.dynamicRange - referenceTargets.dynamicRange,  // 6.8 - 8.3 = -1.5
                    truePeak: userMetrics.truePeak - referenceTargets.truePeak  // -1.1 - (-0.8) = -0.3
                };
                
                log(`DiferenÃ§as calculadas vs REFERÃŠNCIA: LUFS=${differences.lufs.toFixed(1)}dB`);
                
                // 7. Verificar que as diferenÃ§as sÃ£o especÃ­ficas da referÃªncia
                const differencesVsGenre = {
                    lufs: userMetrics.lufs - window.PROD_AI_REF_DATA.funk.lufs,  // -14.2 - (-8.0) = -6.2
                };
                
                log(`Para comparaÃ§Ã£o, vs FUNK seria: LUFS=${differencesVsGenre.lufs.toFixed(1)}dB`);
                
                if (Math.abs(differences.lufs - differencesVsGenre.lufs) > 3) {
                    addResult(true, `âœ… PASSO 5: DiferenÃ§as CORRETAS! ReferÃªncia: ${differences.lufs.toFixed(1)}dB vs Funk: ${differencesVsGenre.lufs.toFixed(1)}dB`);
                } else {
                    addResult(false, 'âŒ PASSO 5: DiferenÃ§as ainda baseadas no gÃªnero, nÃ£o na referÃªncia');
                }
                
                // 8. Gerar sugestÃµes especÃ­ficas da referÃªncia
                const suggestions = [];
                if (Math.abs(differences.lufs) > 0.5) {
                    const action = differences.lufs < 0 ? 'Aumentar' : 'Diminuir';
                    suggestions.push(`${action} volume em ${Math.abs(differences.lufs).toFixed(1)}dB para igualar Ã  mÃºsica de referÃªncia`);
                }
                
                if (Math.abs(differences.dynamicRange) > 1.0) {
                    const action = differences.dynamicRange < 0 ? 'Aumentar' : 'Reduzir';
                    suggestions.push(`${action} range dinÃ¢mico em ${Math.abs(differences.dynamicRange).toFixed(1)}dB para igualar Ã  referÃªncia`);
                }
                
                log(`SugestÃµes baseadas na referÃªncia: ${suggestions.length} sugestÃµes`);
                suggestions.forEach((suggestion, index) => {
                    addResult(true, `âœ… SugestÃ£o ${index + 1}: ${suggestion}`);
                });
                
                // 9. Restaurar estado original
                window.PROD_AI_REF_DATA = originalRefData;
                window.PROD_AI_REF_GENRE = originalRefGenre;
                
                log('Estado original restaurado');
                addResult(true, 'âœ… PASSO 6: Estado original restaurado');
                
                // 10. Resultado final
                addResult(true, 'ğŸ‰ TESTE COMPLETO APROVADO: Sistema usa mÃ©tricas especÃ­ficas da referÃªncia!', true);
                log('=== FLUXO DE REFERÃŠNCIA FUNCIONANDO CORRETAMENTE ===');
                
            } catch (error) {
                log(`Erro durante teste: ${error.message}`, 'error');
                addResult(false, `âŒ Erro: ${error.message}`);
            }
        }

        async function testGenreVsReferenceTargets() {
            clearResults();
            log('=== TESTE COMPARATIVO: GÃŠNERO vs REFERÃŠNCIA ===');
            
            try {
                // Configurar dois cenÃ¡rios diferentes
                const scenarioA_Genre = {
                    PROD_AI_REF_DATA: { funk: { lufs: -8.0, stereoCorrelation: 0.9 } },
                    PROD_AI_REF_GENRE: 'funk'
                };
                
                const scenarioB_Reference = {
                    PROD_AI_REF_DATA: { reference_music: { lufs: -14.0, stereoCorrelation: 0.6 } },
                    PROD_AI_REF_GENRE: 'reference_music'
                };
                
                const userAudio = { lufs: -12.0, stereoCorrelation: 0.7 };
                
                // Testar cenÃ¡rio A (GÃªnero Funk)
                window.PROD_AI_REF_DATA = scenarioA_Genre.PROD_AI_REF_DATA;
                window.PROD_AI_REF_GENRE = scenarioA_Genre.PROD_AI_REF_GENRE;
                
                const diffA = userAudio.lufs - scenarioA_Genre.PROD_AI_REF_DATA.funk.lufs;
                log(`CenÃ¡rio A (Funk): UsuÃ¡rio (-12.0) vs Target (-8.0) = ${diffA}dB`);
                addResult(true, `ğŸ“Š CenÃ¡rio GÃŠNERO: DiferenÃ§a = ${diffA}dB`);
                
                // Testar cenÃ¡rio B (ReferÃªncia)
                window.PROD_AI_REF_DATA = scenarioB_Reference.PROD_AI_REF_DATA;
                window.PROD_AI_REF_GENRE = scenarioB_Reference.PROD_AI_REF_GENRE;
                
                const diffB = userAudio.lufs - scenarioB_Reference.PROD_AI_REF_DATA.reference_music.lufs;
                log(`CenÃ¡rio B (ReferÃªncia): UsuÃ¡rio (-12.0) vs Target (-14.0) = ${diffB}dB`);
                addResult(true, `ğŸ“Š CenÃ¡rio REFERÃŠNCIA: DiferenÃ§a = ${diffB}dB`);
                
                // Verificar que sÃ£o diferentes
                if (Math.abs(diffA - diffB) > 2) {
                    addResult(true, `âœ… DIFERENÃ‡AS DETECTADAS: GÃªnero(${diffA}dB) â‰  ReferÃªncia(${diffB}dB)`, true);
                    log('Sistema diferencia corretamente entre gÃªnero e referÃªncia');
                } else {
                    addResult(false, 'âŒ Sistema ainda retorna valores similares para gÃªnero e referÃªncia');
                }
                
            } catch (error) {
                log(`Erro durante teste comparativo: ${error.message}`, 'error');
                addResult(false, `âŒ Erro: ${error.message}`);
            }
        }
    </script>
</body>
</html>
