<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì Teste Sistema Educativo + Clipping</title>
    <style>
        body {
            background: #0e0f1a;
            color: #e9e9f1;
            font-family: 'Poppins', sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #1a1b2e;
            border: 1px solid #2a2b3e;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .upload-area {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(74, 144, 226, 0.02) 100%);
        }
        .upload-area:hover {
            border-color: #4a90e2;
            background: rgba(74, 144, 226, 0.1);
        }
        .upload-area.dragover {
            border-color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
        }
        button {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }
        button:hover {
            background: linear-gradient(135deg, #357abd 0%, #2968a3 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .results-container {
            display: none;
        }
        .results-container.show {
            display: block;
        }
        
        /* Cards Did√°ticos - Estilos melhorados */
        .diag-item.critical.enhanced.didactic-card {
            border-left: 4px solid #F44336 !important;
            background: rgba(244, 67, 54, 0.1) !important;
            margin: 12px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .diag-item.critical.enhanced.didactic-card:hover {
            background: rgba(244, 67, 54, 0.15) !important;
            transform: translateX(2px);
        }
        
        .diag-item.inconsistent.enhanced.didactic-card {
            border-left: 4px solid #FF9800 !important;
            background: rgba(255, 152, 0, 0.1) !important;
            margin: 12px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .diag-item.inconsistent.enhanced.didactic-card:hover {
            background: rgba(255, 152, 0, 0.15) !important;
            transform: translateX(2px);
        }
        
        .diag-item.enhanced.didactic-card {
            border-left: 3px solid #4a90e2 !important;
            background: rgba(74, 144, 226, 0.05) !important;
            margin: 12px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .diag-item.enhanced.didactic-card:hover {
            background: rgba(74, 144, 226, 0.1) !important;
            transform: translateX(2px);
        }
        
        .didactic-explanation {
            font-size: 13px !important;
            line-height: 1.6 !important;
            margin: 10px 0 !important;
            color: #e8e8e8 !important;
            font-weight: 400 !important;
        }
        
        .didactic-action {
            margin: 10px 0 !important;
            padding: 10px !important;
            border-radius: 6px !important;
            font-size: 13px !important;
        }
        
        .didactic-rationale {
            font-size: 11px !important;
            opacity: 0.9 !important;
            font-style: italic !important;
            margin: 8px 0 !important;
            padding: 8px !important;
            border-radius: 4px !important;
        }
        
        .didactic-technical {
            font-size: 10px !important;
            opacity: 0.8 !important;
            margin-top: 8px !important;
            padding: 6px !important;
            border-radius: 4px !important;
            font-family: 'Courier New', monospace !important;
        }
        
        .test-audio-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }
        .test-audio-button:hover {
            background: linear-gradient(135deg, #ee5a52 0%, #e04848 100%);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        
        .progress-indicator {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .progress-indicator.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 8px;
            display: inline-block;
        }
        .status-ok { background: rgba(81, 207, 102, 0.2); color: #51cf66; }
        .status-warning { background: rgba(255, 152, 0, 0.2); color: #FF9800; }
        .status-critical { background: rgba(244, 67, 54, 0.2); color: #F44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì Teste: Sistema Educativo + Detec√ß√£o de Clipping</h1>
        <p>Verificando se os cards did√°ticos educativos est√£o funcionando junto com a detec√ß√£o rigorosa de clipping</p>

        <div class="section">
            <h3>üìÅ Upload de √Åudio para Teste</h3>
            <div class="upload-area" id="uploadArea">
                <div>
                    <h4>üéµ Arraste um arquivo de √°udio aqui</h4>
                    <p>ou clique para selecionar</p>
                    <p><small>Formatos: MP3, WAV, M4A, OGG (m√°x. 50MB)</small></p>
                </div>
                <input type="file" id="audioFile" accept="audio/*" style="display: none;">
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="generateClippedAudio" class="test-audio-button">üîä Gerar √Åudio com Clipping (Teste)</button>
                <button id="generateNormalAudio">üéµ Gerar √Åudio Normal (Controle)</button>
            </div>
            
            <div class="progress-indicator" id="progressIndicator">
                <div class="spinner"></div>
                <p id="progressText">Analisando √°udio...</p>
            </div>
        </div>

        <div class="section results-container" id="resultsContainer">
            <h3>üìä Resultados da An√°lise</h3>
            
            <div id="statusIndicators"></div>
            
            <div id="technicalProblems">
                <h4>‚ö†Ô∏è Problemas T√©cnicos</h4>
                <div id="problemsContent"></div>
            </div>
            
            <div id="didacticSuggestions">
                <h4>üéì Sugest√µes Educativas</h4>
                <div id="suggestionsContent"></div>
            </div>
            
            <div id="systemValidation">
                <h4>‚úÖ Valida√ß√£o do Sistema</h4>
                <div id="validationContent"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="suggestion-text-generator.js"></script>
    <script src="audio-analyzer.js"></script>
    <script src="audio-analyzer-integration.js"></script>

    <script>
        let analyzer;
        
        // Setup file upload
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('audioFile');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Generate test audios
        document.getElementById('generateClippedAudio').addEventListener('click', () => {
            generateTestAudio(1.3, 'clipped'); // 130% amplitude - vai clipar
        });
        
        document.getElementById('generateNormalAudio').addEventListener('click', () => {
            generateTestAudio(0.7, 'normal'); // 70% amplitude - normal
        });

        async function initAnalyzer() {
            try {
                if (typeof AudioAnalyzer !== 'undefined') {
                    analyzer = new AudioAnalyzer();
                    console.log('‚úÖ AudioAnalyzer inicializado');
                    return true;
                } else {
                    console.error('‚ùå AudioAnalyzer n√£o dispon√≠vel');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erro ao inicializar analyzer:', error);
                return false;
            }
        }

        function createTestAudio(amplitude, filename) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const sampleRate = 48000;
            const duration = 3; // 3 segundos
            const buffer = audioContext.createBuffer(2, sampleRate * duration, sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = buffer.getChannelData(channel);
                for (let i = 0; i < channelData.length; i++) {
                    const t = i / sampleRate;
                    // Mistura de frequ√™ncias para teste mais realista
                    const sample = (
                        Math.sin(2 * Math.PI * 440 * t) * 0.6 +  // 440Hz fundamental
                        Math.sin(2 * Math.PI * 880 * t) * 0.3 +  // harm√¥nico
                        Math.sin(2 * Math.PI * 220 * t) * 0.1    // sub-harm√¥nico
                    ) * amplitude;
                    
                    channelData[i] = Math.max(-1, Math.min(1, sample)); // Hard clipping se necess√°rio
                }
            }
            
            return buffer;
        }

        async function generateTestAudio(amplitude, type) {
            showProgress(`Gerando √°udio de teste (${type})...`);
            
            try {
                if (!await initAnalyzer()) {
                    throw new Error('Analyzer n√£o dispon√≠vel');
                }
                
                const audioBuffer = createTestAudio(amplitude, `teste_${type}.wav`);
                console.log(`‚úÖ √Åudio ${type} gerado: amplitude ${amplitude}`);
                
                await analyzeAudio(audioBuffer, `teste_${type}.wav`);
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar √°udio:', error);
                hideProgress();
            }
        }

        async function handleFile(file) {
            showProgress(`Processando ${file.name}...`);
            
            try {
                if (!await initAnalyzer()) {
                    throw new Error('Analyzer n√£o dispon√≠vel');
                }
                
                const arrayBuffer = await file.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                await analyzeAudio(audioBuffer, file.name);
                
            } catch (error) {
                console.error('‚ùå Erro ao processar arquivo:', error);
                hideProgress();
            }
        }

        async function analyzeAudio(audioBuffer, filename) {
            showProgress('Analisando √°udio...');
            
            try {
                // Realizar an√°lise completa
                const analysis = await analyzer.analyzeAudioBufferDirect(audioBuffer, filename);
                
                // Exibir resultados
                displayResults(analysis, filename);
                hideProgress();
                
            } catch (error) {
                console.error('‚ùå Erro na an√°lise:', error);
                hideProgress();
            }
        }

        function displayResults(analysis, filename) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.classList.add('show');
            
            // Status indicators
            displayStatusIndicators(analysis);
            
            // Technical problems
            displayTechnicalProblems(analysis);
            
            // Didactic suggestions
            displayDidacticSuggestions(analysis);
            
            // System validation
            displaySystemValidation(analysis);
        }

        function displayStatusIndicators(analysis) {
            const container = document.getElementById('statusIndicators');
            const td = analysis.technicalData || {};
            const problems = analysis.problems || [];
            
            let indicators = [];
            
            // Clipping status
            const hasClipping = problems.some(p => p.type === 'clipping') || 
                               (td.clippingSamples > 0) || 
                               (td.peak > -0.1) || 
                               (td.truePeakDbtp > -0.1);
            
            if (hasClipping) {
                indicators.push('<span class="status-indicator status-critical">üö® CLIPPING DETECTADO</span>');
            } else {
                indicators.push('<span class="status-indicator status-ok">‚úÖ SEM CLIPPING</span>');
            }
            
            // SuggestionTextGenerator status
            if (typeof window.SuggestionTextGenerator !== 'undefined') {
                indicators.push('<span class="status-indicator status-ok">üéì SISTEMA EDUCATIVO ATIVO</span>');
            } else {
                indicators.push('<span class="status-indicator status-warning">‚ö†Ô∏è SISTEMA EDUCATIVO INATIVO</span>');
            }
            
            container.innerHTML = indicators.join('');
        }

        function displayTechnicalProblems(analysis) {
            const container = document.getElementById('problemsContent');
            const td = analysis.technicalData || {};
            
            let html = `
                <div style="background: #1a1b2e; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h5>üìä M√©tricas Detalhadas:</h5>
                    <p><strong>Peak:</strong> ${(td.peak || -Infinity).toFixed(2)} dB</p>
                    <p><strong>True Peak:</strong> ${td.truePeakDbtp ? td.truePeakDbtp.toFixed(2) + ' dBTP' : 'N/A'}</p>
                    <p><strong>Clipping Samples:</strong> ${td.clippingSamples || 0}</p>
                    <p><strong>Clipping %:</strong> ${(td.clippingPct || 0).toFixed(4)}%</p>
                </div>
            `;
            
            if (analysis.problems && analysis.problems.length > 0) {
                html += '<div>';
                analysis.problems.forEach(problem => {
                    html += `
                        <div class="diag-item danger" style="margin: 10px 0; padding: 12px; background: rgba(244, 67, 54, 0.1); border-left: 4px solid #F44336; border-radius: 8px;">
                            <div style="font-weight: bold; color: #F44336;">${problem.type}: ${problem.message}</div>
                            <div style="margin-top: 8px; font-size: 13px; opacity: 0.9;">${problem.solution || ''}</div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p style="color: #51cf66;">‚úÖ Nenhum problema t√©cnico detectado</p>';
            }
            
            container.innerHTML = html;
        }

        function displayDidacticSuggestions(analysis) {
            const container = document.getElementById('suggestionsContent');
            
            if (analysis.suggestions && analysis.suggestions.length > 0) {
                // Verificar se o gerador de texto est√° dispon√≠vel
                if (typeof window.SuggestionTextGenerator !== 'undefined') {
                    const generator = new window.SuggestionTextGenerator();
                    
                    let html = '';
                    analysis.suggestions.forEach(suggestion => {
                        const didacticText = generator.generateDidacticText(suggestion);
                        html += renderDidacticCard(didacticText, suggestion);
                    });
                    
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: #FF9800;">‚ö†Ô∏è Sistema educativo n√£o dispon√≠vel. Carregue suggestion-text-generator.js</p>';
                }
            } else {
                container.innerHTML = '<p style="color: #51cf66;">‚úÖ Nenhuma sugest√£o adicional</p>';
            }
        }

        function renderDidacticCard(didacticText, originalSuggestion) {
            if (!didacticText) return '';
            
            if (didacticText.isCritical) {
                return `
                    <div class="diag-item critical enhanced didactic-card" style="border-left: 4px solid #F44336; background: rgba(244, 67, 54, 0.1); min-height: auto; padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1; font-weight: 700; font-size: 14px; color: #F44336;">${didacticText.title}</div>
                            <span style="background: #F44336; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold;">CR√çTICO</span>
                        </div>
                        <div class="didactic-explanation" style="font-size: 13px; line-height: 1.5; margin: 8px 0; color: #ff6b6b; font-weight: 500;">
                            ${didacticText.explanation}
                        </div>
                        <div class="didactic-action" style="margin: 8px 0; padding: 8px; background: rgba(244, 67, 54, 0.15); border-radius: 4px; border-left: 3px solid #F44336;">
                            <strong>üö® A√ß√£o Urgente:</strong> ${didacticText.action}
                        </div>
                        <div class="didactic-rationale" style="font-size: 11px; opacity: 0.9; font-style: italic; margin: 8px 0; padding: 6px; background: rgba(244, 67, 54, 0.05); border-radius: 3px;">
                            <strong>‚ö†Ô∏è Por que √© cr√≠tico:</strong> ${didacticText.rationale}
                        </div>
                        <div class="didactic-technical" style="font-size: 10px; opacity: 0.8; margin-top: 8px; padding: 4px; background: rgba(0,0,0,0.3); border-radius: 3px; font-family: monospace;">
                            üîç ${didacticText.technical}
                        </div>
                    </div>
                `;
            } else if (didacticText.isInconsistent) {
                return `
                    <div class="diag-item inconsistent enhanced didactic-card" style="border-left: 4px solid #FF9800; background: rgba(255, 152, 0, 0.1); min-height: auto; padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1; font-weight: 700; font-size: 14px; color: #FF9800;">${didacticText.title}</div>
                            <span style="background: #FF9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold;">SUSPEITO</span>
                        </div>
                        <div class="didactic-explanation" style="font-size: 13px; line-height: 1.5; margin: 8px 0; color: #F57C00; font-weight: 500;">
                            ${didacticText.explanation}
                        </div>
                        <div class="didactic-action" style="margin: 8px 0; padding: 8px; background: rgba(255, 152, 0, 0.15); border-radius: 4px; border-left: 3px solid #FF9800;">
                            <strong>‚ö†Ô∏è A√ß√£o Recomendada:</strong> ${didacticText.action}
                        </div>
                        <div class="didactic-rationale" style="font-size: 11px; opacity: 0.9; font-style: italic; margin: 8px 0; padding: 6px; background: rgba(255, 152, 0, 0.05); border-radius: 3px;">
                            <strong>üîç Por que √© suspeito:</strong> ${didacticText.rationale}
                        </div>
                        <div class="didactic-technical" style="font-size: 10px; opacity: 0.8; margin-top: 8px; padding: 4px; background: rgba(0,0,0,0.3); border-radius: 3px; font-family: monospace;">
                            ‚ö†Ô∏è ${didacticText.technical}
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="diag-item enhanced didactic-card" style="border-left: 3px solid #4a90e2; background: rgba(74, 144, 226, 0.05); min-height: auto; padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1; font-weight: 600; font-size: 14px; color: #4a90e2;">${didacticText.title}</div>
                        </div>
                        <div class="didactic-explanation" style="font-size: 13px; line-height: 1.5; margin: 8px 0; color: #e8e8e8;">
                            ${didacticText.explanation}
                        </div>
                        <div class="didactic-action" style="margin: 8px 0; padding: 8px; background: rgba(74, 144, 226, 0.1); border-radius: 4px; border-left: 2px solid #4a90e2;">
                            <strong>üîß A√ß√£o:</strong> ${didacticText.action}
                        </div>
                        <div class="didactic-rationale" style="font-size: 11px; opacity: 0.85; font-style: italic; margin: 8px 0; padding: 6px; background: rgba(74, 144, 226, 0.03); border-radius: 3px;">
                            <strong>üí° Por qu√™:</strong> ${didacticText.rationale}
                        </div>
                        <div class="didactic-technical" style="font-size: 10px; opacity: 0.7; margin-top: 8px; padding: 4px; background: rgba(0,0,0,0.2); border-radius: 3px; font-family: monospace;">
                            üìä ${didacticText.technical}
                        </div>
                    </div>
                `;
            }
        }

        function displaySystemValidation(analysis) {
            const container = document.getElementById('validationContent');
            
            let validations = [];
            
            // Validar se SuggestionTextGenerator est√° carregado
            if (typeof window.SuggestionTextGenerator !== 'undefined') {
                validations.push('‚úÖ SuggestionTextGenerator carregado corretamente');
            } else {
                validations.push('‚ùå SuggestionTextGenerator n√£o encontrado');
            }
            
            // Validar detec√ß√£o de clipping
            const td = analysis.technicalData || {};
            const hasClippingData = Number.isFinite(td.clippingSamples) && Number.isFinite(td.clippingPct);
            if (hasClippingData) {
                validations.push('‚úÖ M√©tricas de clipping calculadas');
            } else {
                validations.push('‚ùå M√©tricas de clipping ausentes');
            }
            
            // Validar crit√©rios rigorosos
            const rigorousCriteria = td.peak > -0.1 || td.clippingSamples > 0;
            if (rigorousCriteria) {
                validations.push('‚úÖ Crit√©rios rigorosos aplicados (threshold -0.1dB)');
            } else {
                validations.push('‚ÑπÔ∏è √Åudio dentro dos crit√©rios rigorosos');
            }
            
            container.innerHTML = validations.map(v => `<p>${v}</p>`).join('');
        }

        function showProgress(message) {
            document.getElementById('progressText').textContent = message;
            document.getElementById('progressIndicator').classList.add('show');
        }

        function hideProgress() {
            document.getElementById('progressIndicator').classList.remove('show');
        }

        // Auto-inicializar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéì Sistema de teste educativo + clipping inicializado');
        });
    </script>
</body>
</html>
