<!DOCTYPE html>
<html>
<head>
    <title>Teste Sistema de G√™nero - PROD.AI</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #0b0f14; color: #00d4ff; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; }
        .success { color: #00ff92; }
        .error { color: #ff4444; }
        button { padding: 10px; margin: 5px; background: #00d4ff; color: #000; border: none; cursor: pointer; }
        pre { background: #1a1a1a; padding: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üß™ Teste do Sistema de Refer√™ncia por G√™nero</h1>
    
    <div class="test-section">
        <h3>1. Teste de Aplica√ß√£o de G√™nero</h3>
        <button onclick="testApplyGenre()">Testar Aplica√ß√£o de funk_mandela</button>
        <button onclick="testClearGenre()">Limpar G√™nero</button>
        <div id="genreResult"></div>
    </div>

    <div class="test-section">
        <h3>2. Teste de Fetch da Refer√™ncia</h3>
        <button onclick="testFetchRef()">Testar Carregamento JSON</button>
        <div id="fetchResult"></div>
    </div>

    <div class="test-section">
        <h3>3. Teste do V2 Analyzer (Mock)</h3>
        <button onclick="testV2Mock()">Simular An√°lise com Refer√™ncia</button>
        <div id="v2Result"></div>
    </div>

    <div class="test-section">
        <h3>4. Estado Global</h3>
        <button onclick="checkGlobalState()">Verificar Estado</button>
        <pre id="globalState"></pre>
    </div>

    <script src="audio-analyzer-integration.js"></script>
    <script>
        // Fun√ß√µes de teste
        async function testApplyGenre() {
            const result = document.getElementById('genreResult');
            try {
                await applyGenreSelection('funk_mandela');
                result.innerHTML = '<span class="success">‚úÖ G√™nero aplicado com sucesso</span>';
            } catch (e) {
                result.innerHTML = `<span class="error">‚ùå Erro: ${e.message}</span>`;
            }
        }

        async function testClearGenre() {
            const result = document.getElementById('genreResult');
            try {
                await applyGenreSelection(null);
                result.innerHTML = '<span class="success">‚úÖ G√™nero limpo</span>';
            } catch (e) {
                result.innerHTML = `<span class="error">‚ùå Erro: ${e.message}</span>`;
            }
        }

        async function testFetchRef() {
            const result = document.getElementById('fetchResult');
            try {
                const res = await fetch('/refs/out/funk_mandela.json', { cache: 'no-store' });
                const data = await res.json();
                const summary = {
                    status: res.status,
                    lufs_target: data.funk_mandela?.lufs_target,
                    version: data.funk_mandela?.version,
                    bands: Object.keys(data.funk_mandela?.bands || {})
                };
                result.innerHTML = `<span class="success">‚úÖ JSON carregado:</span><pre>${JSON.stringify(summary, null, 2)}</pre>`;
            } catch (e) {
                result.innerHTML = `<span class="error">‚ùå Erro: ${e.message}</span>`;
            }
        }

        async function testV2Mock() {
            const result = document.getElementById('v2Result');
            
            // Garantir que h√° dados de refer√™ncia
            if (!window.PROD_AI_REF_GENRE) {
                await testApplyGenre();
            }

            // Mock de m√©tricas
            const mockMetrics = {
                loudness: { lufs_integrated: -12.5 },
                truePeak: { true_peak_dbtp: -8.2 },
                core: { dynamicRange: 6.8 },
                stereo: { width: 0.25 }
            };

            const mockDiagnostics = { suggestions: [] };

            // Simular attachGenreRefSuggestions
            try {
                const genre = (window.PROD_AI_REF_GENRE || '').trim().toLowerCase();
                const refData = window.PROD_AI_REF_DATA || null;
                
                if (genre && refData) {
                    const ref = refData[genre] || refData;
                    
                    // Simular compara√ß√£o simples
                    const comparisons = [];
                    if (ref.lufs_target) {
                        const delta = mockMetrics.loudness.lufs_integrated - ref.lufs_target;
                        comparisons.push(`LUFS: ${mockMetrics.loudness.lufs_integrated} vs ${ref.lufs_target} (Œî${delta.toFixed(1)})`);
                    }
                    if (ref.true_peak_target) {
                        const delta = mockMetrics.truePeak.true_peak_dbtp - ref.true_peak_target;
                        comparisons.push(`True Peak: ${mockMetrics.truePeak.true_peak_dbtp} vs ${ref.true_peak_target} (Œî${delta.toFixed(1)})`);
                    }

                    result.innerHTML = `<span class="success">‚úÖ Simula√ß√£o V2 conclu√≠da:</span>
                        <pre>G√™nero: ${genre}
Compara√ß√µes:
${comparisons.join('\n')}

Evid√™ncia dispon√≠vel: ${!!ref}</pre>`;
                } else {
                    result.innerHTML = `<span class="error">‚ùå Sem dados de refer√™ncia</span>`;
                }
            } catch (e) {
                result.innerHTML = `<span class="error">‚ùå Erro na simula√ß√£o: ${e.message}</span>`;
            }
        }

        function checkGlobalState() {
            const state = document.getElementById('globalState');
            const info = {
                PROD_AI_REF_GENRE: window.PROD_AI_REF_GENRE,
                PROD_AI_REF_DATA_available: !!window.PROD_AI_REF_DATA,
                localStorage_ref: localStorage.getItem('prodai_ref_genre'),
                url_params: new URLSearchParams(window.location.search).get('refgenre'),
                functions_available: {
                    applyGenreSelection: typeof applyGenreSelection,
                    openGenreSelectionModal: typeof openGenreSelectionModal
                }
            };
            state.textContent = JSON.stringify(info, null, 2);
        }

        // Auto-verificar estado na carga
        document.addEventListener('DOMContentLoaded', checkGlobalState);
    </script>
</body>
</html>
