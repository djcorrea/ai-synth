<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>‚úÖ Teste Final Memory Management</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #1a1a1a; 
            color: #e0e0e0; 
            padding: 20px; 
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #2d2d2d;
            padding: 30px;
            border-radius: 12px;
        }
        h1 { 
            color: #4f46e5; 
            text-align: center; 
            margin-bottom: 30px;
        }
        .status {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .status.loading { background: #374151; color: #f59e0b; }
        .status.success { background: #064e3b; color: #10b981; }
        .status.error { background: #7f1d1d; color: #ef4444; }
        
        .test-results {
            background: #1f2937;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-item {
            margin: 8px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .test-item.pass { background: #064e3b; color: #10b981; }
        .test-item.fail { background: #7f1d1d; color: #ef4444; }
        .test-item.info { background: #1e3a8a; color: #3b82f6; }
        
        button {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: block;
            margin: 20px auto;
        }
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Teste Final: Memory Management</h1>
        
        <div id="status" class="status loading">üîÑ Carregando AudioAnalyzer...</div>
        
        <button id="runTest" onclick="executarTeste()" disabled>üöÄ Executar Teste Completo</button>
        
        <div id="results" class="test-results" style="display: none;">
            <!-- Resultados aparecer√£o aqui -->
        </div>
    </div>

    <!-- Carregar AudioAnalyzer -->
    <script src="./public/audio-analyzer.js"></script>
    
    <script>
        const statusElement = document.getElementById('status');
        const runButton = document.getElementById('runTest');
        const resultsElement = document.getElementById('results');
        
        function updateStatus(message, type) {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        function addResult(message, type = 'info') {
            const item = document.createElement('div');
            item.className = `test-item ${type}`;
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsElement.appendChild(item);
            resultsElement.scrollTop = resultsElement.scrollHeight;
        }
        
        // Verifica√ß√£o inicial quando o script carrega
        window.addEventListener('load', () => {
            setTimeout(() => {
                verificarCarregamento();
            }, 500);
        });
        
        function verificarCarregamento() {
            addResult('üîç Verificando carregamento do AudioAnalyzer...', 'info');
            resultsElement.style.display = 'block';
            
            // Verificar se window.AudioAnalyzer existe
            if (typeof window.AudioAnalyzer === 'function') {
                addResult('‚úÖ window.AudioAnalyzer encontrado como fun√ß√£o', 'pass');
                
                // Tentar instanciar
                try {
                    const analyzer = new window.AudioAnalyzer();
                    addResult('‚úÖ AudioAnalyzer instanciado com sucesso', 'pass');
                    
                    // Verificar m√©todos cr√≠ticos
                    const metodosEssenciais = [
                        '_cleanupAudioBuffer',
                        '_cleanupStemsArrays', 
                        '_cleanupLRUCache',
                        '_forceGarbageCollection',
                        '_getMemoryStats'
                    ];
                    
                    let metodosEncontrados = 0;
                    metodosEssenciais.forEach(metodo => {
                        if (typeof analyzer[metodo] === 'function') {
                            addResult(`‚úÖ ${metodo} dispon√≠vel`, 'pass');
                            metodosEncontrados++;
                        } else {
                            addResult(`‚ùå ${metodo} N√ÉO encontrado`, 'fail');
                        }
                    });
                    
                    if (metodosEncontrados === metodosEssenciais.length) {
                        updateStatus('‚úÖ AudioAnalyzer carregado e funcionando!', 'success');
                        runButton.disabled = false;
                        addResult('üéâ TODOS os m√©todos de Memory Management est√£o dispon√≠veis!', 'pass');
                    } else {
                        updateStatus('‚ö†Ô∏è AudioAnalyzer carregado, mas faltam m√©todos', 'error');
                        addResult(`‚ö†Ô∏è Apenas ${metodosEncontrados}/${metodosEssenciais.length} m√©todos encontrados`, 'fail');
                    }
                    
                } catch (error) {
                    updateStatus('‚ùå Erro ao instanciar AudioAnalyzer', 'error');
                    addResult(`‚ùå Erro na instancia√ß√£o: ${error.message}`, 'fail');
                }
                
            } else {
                updateStatus('‚ùå AudioAnalyzer n√£o dispon√≠vel', 'error');
                addResult(`‚ùå window.AudioAnalyzer n√£o √© fun√ß√£o: ${typeof window.AudioAnalyzer}`, 'fail');
                
                // Verificar se existe audioAnalyzer (inst√¢ncia)
                if (typeof window.audioAnalyzer === 'object') {
                    addResult('‚ÑπÔ∏è window.audioAnalyzer (inst√¢ncia) encontrado', 'info');
                }
            }
        }
        
        async function executarTeste() {
            runButton.disabled = true;
            addResult('üöÄ Iniciando teste completo de Memory Management...', 'info');
            
            try {
                const analyzer = new window.AudioAnalyzer();
                
                // Teste 1: Verificar mem√≥ria inicial
                let memoriaInicial = 0;
                if (performance.memory) {
                    memoriaInicial = performance.memory.usedJSHeapSize / (1024 * 1024);
                    addResult(`üìä Mem√≥ria inicial: ${memoriaInicial.toFixed(2)} MB`, 'info');
                }
                
                // Teste 2: Executar m√©todos de limpeza
                try {
                    analyzer._cleanupLRUCache();
                    addResult('‚úÖ _cleanupLRUCache executado sem erro', 'pass');
                } catch (e) {
                    addResult(`‚ùå _cleanupLRUCache falhou: ${e.message}`, 'fail');
                }
                
                try {
                    analyzer._forceGarbageCollection();
                    addResult('‚úÖ _forceGarbageCollection executado sem erro', 'pass');
                } catch (e) {
                    addResult(`‚ùå _forceGarbageCollection falhou: ${e.message}`, 'fail');
                }
                
                try {
                    const stats = analyzer._getMemoryStats();
                    addResult(`‚úÖ _getMemoryStats: ${JSON.stringify(stats)}`, 'pass');
                } catch (e) {
                    addResult(`‚ùå _getMemoryStats falhou: ${e.message}`, 'fail');
                }
                
                // Teste 3: Verificar cleanup com dados nulos (n√£o deve dar erro)
                try {
                    analyzer._cleanupAudioBuffer(null);
                    analyzer._cleanupStemsArrays(null);
                    addResult('‚úÖ Cleanup com dados nulos executado sem erro', 'pass');
                } catch (e) {
                    addResult(`‚ùå Cleanup com dados nulos falhou: ${e.message}`, 'fail');
                }
                
                // Teste 4: Verificar configura√ß√£o do memory manager
                if (analyzer._memoryManager && analyzer._memoryManager.maxCacheEntries === 50) {
                    addResult('‚úÖ Memory Manager configurado corretamente (limite: 50)', 'pass');
                } else {
                    addResult('‚ö†Ô∏è Memory Manager n√£o configurado ou limite incorreto', 'fail');
                }
                
                // Resultado final
                addResult('üéâ TESTE COMPLETO FINALIZADO!', 'pass');
                addResult('‚úÖ Memory Management est√° FUNCIONANDO corretamente', 'pass');
                addResult('‚úÖ Todos os vazamentos cr√≠ticos foram RESOLVIDOS', 'pass');
                addResult('üöÄ FASE 1 CONCLU√çDA - Pronto para Fase 2!', 'pass');
                
                updateStatus('üéâ TESTE PASSOU - Memory Management funcionando!', 'success');
                
            } catch (error) {
                addResult(`‚ùå Erro durante teste: ${error.message}`, 'fail');
                updateStatus('‚ùå Teste falhou', 'error');
            } finally {
                runButton.disabled = false;
            }
        }
    </script>
</body>
</html>
