<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Score Real</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; }
        .upload-area { border: 2px dashed #4CAF50; padding: 30px; text-align: center; margin: 20px 0; border-radius: 8px; }
        .results { background: #16213e; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .score-item { display: flex; justify-content: space-between; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .score-value { font-weight: bold; }
        .color-green { background: rgba(76, 175, 80, 0.2); }
        .color-yellow { background: rgba(255, 193, 7, 0.2); }
        .color-red { background: rgba(244, 67, 54, 0.2); }
        button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #666; cursor: not-allowed; }
        .debug { font-family: monospace; font-size: 12px; background: #0d1421; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .problem { background: rgba(244, 67, 54, 0.1); border-left: 4px solid #f44336; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Teste Score Real - Debug Problema</h1>
        
        <div class="upload-area">
            <input type="file" id="audioFile" accept="audio/*">
            <p>Selecione um arquivo de √°udio para testar</p>
            <button id="analyzeBtn" disabled>Analisar e Debug Score</button>
        </div>

        <div id="results" class="results" style="display: none;">
            <h2>Resultados da An√°lise</h2>
            <div id="scoreBreakdown"></div>
            <div id="debugInfo"></div>
            <div id="problemAnalysis"></div>
        </div>
    </div>

    <script src="/public/audio-analyzer.js"></script>
    <script>
        const audioFile = document.getElementById('audioFile');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const results = document.getElementById('results');
        const scoreBreakdown = document.getElementById('scoreBreakdown');
        const debugInfo = document.getElementById('debugInfo');
        const problemAnalysis = document.getElementById('problemAnalysis');

        let audioAnalyzer = null;

        audioFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                analyzeBtn.disabled = false;
            }
        });

        analyzeBtn.addEventListener('click', async function() {
            if (!audioFile.files[0]) return;
            
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Analisando...';
            
            try {
                // Inicializar analisador se necess√°rio
                if (!audioAnalyzer) {
                    audioAnalyzer = new AudioAnalyzer();
                }

                const file = audioFile.files[0];
                const analysisResult = await audioAnalyzer.analyzeFile(file, {
                    genre: 'trance',
                    features: ['core', 'quality', 'loudness', 'stereo']
                });

                console.log('Resultado completo:', analysisResult);
                
                // Mostrar breakdown dos scores
                const quality = analysisResult.quality;
                if (quality) {
                    showScoreBreakdown(quality);
                    showDebugInfo(analysisResult);
                    analyzeScoreProblem(quality);
                }
                
                results.style.display = 'block';
                
            } catch (error) {
                console.error('Erro na an√°lise:', error);
                alert('Erro na an√°lise: ' + error.message);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analisar e Debug Score';
            }
        });

        function showScoreBreakdown(quality) {
            const breakdown = quality.breakdown || {};
            const overall = quality.overall || 0;
            
            scoreBreakdown.innerHTML = `
                <h3>Score Geral: ${overall}/100</h3>
                <div class="score-item ${getScoreColor(breakdown.dynamics)}">
                    <span>Dynamics:</span>
                    <span class="score-value">${breakdown.dynamics || 0}/100</span>
                </div>
                <div class="score-item ${getScoreColor(breakdown.frequency)}">
                    <span>Frequency:</span>
                    <span class="score-value">${breakdown.frequency || 0}/100</span>
                </div>
                <div class="score-item ${getScoreColor(breakdown.stereo)}">
                    <span>Stereo:</span>
                    <span class="score-value">${breakdown.stereo || 0}/100</span>
                </div>
                <div class="score-item ${getScoreColor(breakdown.loudness)}">
                    <span>Loudness:</span>
                    <span class="score-value">${breakdown.loudness || 0}/100</span>
                </div>
                <div class="score-item ${getScoreColor(breakdown.technical)}">
                    <span>Technical:</span>
                    <span class="score-value">${breakdown.technical || 0}/100</span>
                </div>
            `;
        }

        function getScoreColor(score) {
            if (score >= 80) return 'color-green';
            if (score >= 60) return 'color-yellow';
            return 'color-red';
        }

        function showDebugInfo(result) {
            const quality = result.quality;
            const breakdown = quality.breakdown || {};
            
            // Calcular manualmente o score
            const weights = {
                dynamics: 0.25,
                frequency: 0.20,
                stereo: 0.20,
                loudness: 0.20,
                technical: 0.15
            };
            
            const calculatedScore = Math.round(
                breakdown.dynamics * weights.dynamics +
                breakdown.frequency * weights.frequency +
                breakdown.stereo * weights.stereo +
                breakdown.loudness * weights.loudness +
                breakdown.technical * weights.technical
            );
            
            debugInfo.innerHTML = `
                <h3>Debug C√°lculo Manual</h3>
                <div class="debug">
                    Dynamics: ${breakdown.dynamics} √ó 0.25 = ${(breakdown.dynamics * 0.25).toFixed(2)}<br>
                    Frequency: ${breakdown.frequency} √ó 0.20 = ${(breakdown.frequency * 0.20).toFixed(2)}<br>
                    Stereo: ${breakdown.stereo} √ó 0.20 = ${(breakdown.stereo * 0.20).toFixed(2)}<br>
                    Loudness: ${breakdown.loudness} √ó 0.20 = ${(breakdown.loudness * 0.20).toFixed(2)}<br>
                    Technical: ${breakdown.technical} √ó 0.15 = ${(breakdown.technical * 0.15).toFixed(2)}<br>
                    <strong>Calculado: ${calculatedScore}/100</strong><br>
                    <strong>Sistema: ${quality.overall}/100</strong><br>
                    <strong>Diferen√ßa: ${Math.abs(calculatedScore - quality.overall)}</strong>
                </div>
            `;
        }

        function analyzeScoreProblem(quality) {
            const breakdown = quality.breakdown || {};
            const scores = [breakdown.dynamics, breakdown.frequency, breakdown.stereo, breakdown.loudness, breakdown.technical];
            
            const green = scores.filter(s => s >= 80).length;
            const yellow = scores.filter(s => s >= 60 && s < 80).length;
            const red = scores.filter(s => s < 60).length;
            
            const overall = quality.overall;
            
            problemAnalysis.innerHTML = `
                <div class="problem">
                    <h3>üìä An√°lise do Problema</h3>
                    <p><strong>Cores:</strong> ${green} verde(s), ${yellow} amarelo(s), ${red} vermelho(s)</p>
                    <p><strong>Score Geral:</strong> ${overall}/100</p>
                    
                    ${red >= 3 && overall >= 50 ? `
                        <p style="color: #f44336;"><strong>‚ö†Ô∏è PROBLEMA IDENTIFICADO:</strong></p>
                        <p>Com ${red} scores vermelhos, o score geral deveria ser menor que 50, mas est√° em ${overall}.</p>
                        <p><strong>Poss√≠veis causas:</strong></p>
                        <ul>
                            <li>Um ou mais scores altos est√£o compensando os baixos</li>
                            <li>Os pesos favorecem categorias espec√≠ficas</li>
                            <li>Os thresholds de cor n√£o correspondem aos valores reais</li>
                        </ul>
                    ` : `
                        <p style="color: #4CAF50;"><strong>‚úÖ C√ÅLCULO APARENTA ESTAR CORRETO</strong></p>
                        <p>A distribui√ß√£o de cores condiz com o score geral.</p>
                    `}
                </div>
            `;
        }
    </script>
</body>
</html>
