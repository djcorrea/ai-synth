<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ Teste Espec√≠fico - Problema do Score</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4ecdc4;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .result {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 15px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .score-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .score-card.low {
            border-color: #dc3545;
        }
        
        .score-card.medium {
            border-color: #ffc107;
        }
        
        .score-card.high {
            border-color: #28a745;
        }
        
        .score-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .score-label {
            color: #888;
            font-size: 0.9em;
        }
        
        .error {
            color: #ff0000;
        }
        
        .success {
            color: #00ff00;
        }
        
        .warning {
            color: #ffff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Teste Espec√≠fico - Problema do Score Fixo</h1>
        
        <div class="test-section">
            <h2>üéØ Objetivo</h2>
            <p>Identificar por que o score est√° sempre retornando 36.5% independente do arquivo de √°udio.</p>
            <p>Vamos testar 3 cen√°rios com qualidades muito diferentes para ver se o score varia adequadamente.</p>
        </div>
        
        <div class="test-section">
            <h2>üß™ Teste Comparativo</h2>
            <button class="button" onclick="executarTesteCompleto()">‚ñ∂ Executar Teste Comparativo</button>
            <button class="button" onclick="limparResultados()">üßπ Limpar</button>
            
            <div class="comparison" id="comparison-results">
                <div class="score-card low">
                    <div class="score-value" id="score-baixa">--</div>
                    <div class="score-label">Qualidade Baixa<br>(Deveria ser ~20-30%)</div>
                </div>
                <div class="score-card medium">
                    <div class="score-value" id="score-atual">--</div>
                    <div class="score-label">Arquivo Atual<br>(Score obtido: 36.5%)</div>
                </div>
                <div class="score-card high">
                    <div class="score-value" id="score-alta">--</div>
                    <div class="score-label">Qualidade Alta<br>(Deveria ser ~80-90%)</div>
                </div>
            </div>
            
            <div id="test-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>üîç Diagn√≥stico</h2>
            <button class="button" onclick="diagnosticarSistema()">üî¨ Diagnosticar Sistema</button>
            <button class="button" onclick="verificarFlags()">üèÅ Verificar Flags</button>
            <button class="button" onclick="testarFuncoes()">‚öôÔ∏è Testar Fun√ß√µes</button>
            
            <div id="diagnostic-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>üí° Solu√ß√µes Poss√≠veis</h2>
            <button class="button" onclick="aplicarSolucao1()">üîß Limpar Cache</button>
            <button class="button" onclick="aplicarSolucao2()">üèÅ Reconfigurar Flags</button>
            <button class="button" onclick="aplicarSolucao3()">üîÑ Recarregar Sistema</button>
            
            <div id="solution-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="./lib/audio/features/scoring.js?v=1756170529734"></script>
    <script src="./analise-problema-score.js"></script>
    
    <script>
        function log(message, element = 'test-result') {
            const result = document.getElementById(element);
            result.style.display = 'block';
            result.innerHTML += message + '\n';
            result.scrollTop = result.scrollHeight;
        }
        
        function updateScore(elementId, score, expected = null) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = score ? score.toFixed(1) + '%' : '--';
                
                // Colorir baseado na expectativa
                if (expected) {
                    const diff = Math.abs(score - expected);
                    if (diff < 5) element.style.color = '#28a745'; // Verde se pr√≥ximo
                    else if (diff < 15) element.style.color = '#ffc107'; // Amarelo se moderado
                    else element.style.color = '#dc3545'; // Vermelho se muito diferente
                }
            }
        }
        
        function limparResultados() {
            document.querySelectorAll('.result').forEach(el => {
                el.style.display = 'none';
                el.innerHTML = '';
            });
            
            document.querySelectorAll('.score-value').forEach(el => {
                el.textContent = '--';
                el.style.color = '#4ecdc4';
            });
        }
        
        async function executarTesteCompleto() {
            log('üî¨ [TESTE] Iniciando teste comparativo completo...', 'test-result');
            
            // Verificar se fun√ß√µes est√£o dispon√≠veis
            if (!window.computeMixScore) {
                log('‚ùå [ERRO] window.computeMixScore n√£o encontrado!', 'test-result');
                log('üîÑ [A√á√ÉO] Tentando aguardar carregamento...', 'test-result');
                
                // Aguardar um pouco e tentar novamente
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (!window.computeMixScore) {
                    log('‚ùå [ERRO] Sistema de scoring n√£o carregou!', 'test-result');
                    return;
                }
            }
            
            log('‚úÖ [OK] Sistema de scoring encontrado', 'test-result');
            
            // Definir refer√™ncia
            const referencia = {
                lufs_target: -8.0,
                tol_lufs: 2.0,
                true_peak_target: -3.0,
                tol_true_peak: 2.0,
                dr_target: 8.0,
                tol_dr: 3.0,
                lra_target: 9.0,
                tol_lra: 4.0,
                stereo_target: 0.6,
                tol_stereo: 0.5,
                bands: {
                    'graves_60_120': { target_db: -8.0, tol_db: 2.0 },
                    'medias_graves_200_500': { target_db: -9.0, tol_db: 2.0 },
                    'medias_500_2000': { target_db: -6.0, tol_db: 2.0 },
                    'medias_agudas_2_4khz': { target_db: -12.0, tol_db: 3.0 },
                    'agudos_4_8khz': { target_db: -16.0, tol_db: 4.0 },
                    'presenca_8_12khz': { target_db: -19.0, tol_db: 3.0 }
                }
            };
            
            log('üìã [REF] Refer√™ncia configurada', 'test-result');
            
            // Cen√°rio 1: Qualidade baixa (deveria dar ~20-30%)
            const dadosBaixa = {
                lufsIntegrated: -3.0,     // Muito alto (ruim)
                truePeakDbtp: 0.5,        // Clipping (p√©ssimo)
                dynamicRange: 2.0,        // Muito baixo (ruim)
                dr: 2.0,
                lra: 20.0,               // Muito alto (ruim)
                stereoCorrelation: -0.8,  // Muito baixo (ruim)
                stereoWidth: 1.5,        // Muito alto (ruim)
                spectralCentroid: 8000,   // Muito alto (ruim)
                bandEnergies: {
                    'graves_60_120': { rms_db: -25.0 },      // Muito baixo
                    'medias_graves_200_500': { rms_db: -1.0 }, // Muito alto  
                    'medias_500_2000': { rms_db: -30.0 },    // Muito baixo
                    'medias_agudas_2_4khz': { rms_db: 0.0 },  // Muito alto
                    'agudos_4_8khz': { rms_db: -35.0 },      // Muito baixo
                    'presenca_8_12khz': { rms_db: 2.0 }      // Muito alto
                }
            };
            
            // Cen√°rio 2: Arquivo atual (36.5%)
            const dadosAtual = {
                lufsIntegrated: -6.2,
                truePeakDbtp: -1.9,
                dynamicRange: 6.6,
                dr: 6.6,
                lra: 4.96,
                stereoCorrelation: 0.20,
                stereoWidth: 0.23,
                spectralCentroid: 4615,
                bandEnergies: {
                    'graves_60_120': { rms_db: -6.90 },
                    'medias_graves_200_500': { rms_db: -7.44 },
                    'medias_500_2000': { rms_db: -7.31 },
                    'medias_agudas_2_4khz': { rms_db: -12.34 },
                    'agudos_4_8khz': { rms_db: -15.54 },
                    'presenca_8_12khz': { rms_db: -22.82 }
                }
            };
            
            // Cen√°rio 3: Qualidade alta (deveria dar ~80-90%)
            const dadosAlta = {
                lufsIntegrated: -14.0,    // Perfeito
                truePeakDbtp: -3.0,       // Perfeito
                dynamicRange: 12.0,       // Excelente
                dr: 12.0,
                lra: 8.0,                // Bom
                stereoCorrelation: 0.6,   // Bom
                stereoWidth: 0.8,        // Bom
                spectralCentroid: 2500,   // Perfeito
                bandEnergies: {
                    'graves_60_120': { rms_db: -8.0 },       // Perfeito
                    'medias_graves_200_500': { rms_db: -9.0 }, // Perfeito
                    'medias_500_2000': { rms_db: -6.0 },     // Perfeito
                    'medias_agudas_2_4khz': { rms_db: -12.0 }, // Perfeito
                    'agudos_4_8khz': { rms_db: -16.0 },      // Perfeito
                    'presenca_8_12khz': { rms_db: -19.0 }    // Perfeito
                }
            };
            
            log('üß™ [TESTE] Testando cen√°rio 1: Qualidade baixa...', 'test-result');
            try {
                const resultBaixa = window.computeMixScore(dadosBaixa, referencia);
                log(`üìä [BAIXA] Score: ${resultBaixa.scorePct}% (m√©todo: ${resultBaixa.method})`, 'test-result');
                updateScore('score-baixa', resultBaixa.scorePct, 25);
            } catch (error) {
                log(`‚ùå [BAIXA] Erro: ${error.message}`, 'test-result');
            }
            
            log('üß™ [TESTE] Testando cen√°rio 2: Arquivo atual...', 'test-result');
            try {
                const resultAtual = window.computeMixScore(dadosAtual, referencia);
                log(`üìä [ATUAL] Score: ${resultAtual.scorePct}% (m√©todo: ${resultAtual.method})`, 'test-result');
                updateScore('score-atual', resultAtual.scorePct, 36.5);
            } catch (error) {
                log(`‚ùå [ATUAL] Erro: ${error.message}`, 'test-result');
            }
            
            log('üß™ [TESTE] Testando cen√°rio 3: Qualidade alta...', 'test-result');
            try {
                const resultAlta = window.computeMixScore(dadosAlta, referencia);
                log(`üìä [ALTA] Score: ${resultAlta.scorePct}% (m√©todo: ${resultAlta.method})`, 'test-result');
                updateScore('score-alta', resultAlta.scorePct, 85);
            } catch (error) {
                log(`‚ùå [ALTA] Erro: ${error.message}`, 'test-result');
            }
            
            // An√°lise dos resultados
            const scoreBaixa = parseFloat(document.getElementById('score-baixa').textContent) || 0;
            const scoreAtual = parseFloat(document.getElementById('score-atual').textContent) || 0;
            const scoreAlta = parseFloat(document.getElementById('score-alta').textContent) || 0;
            
            const difBaixaAlta = scoreAlta - scoreBaixa;
            
            log('', 'test-result');
            log('üìà [AN√ÅLISE] Resultados:', 'test-result');
            log(`  Baixa: ${scoreBaixa}%`, 'test-result');
            log(`  Atual: ${scoreAtual}%`, 'test-result');
            log(`  Alta: ${scoreAlta}%`, 'test-result');
            log(`  Diferen√ßa (Alta-Baixa): ${difBaixaAlta.toFixed(1)} pontos`, 'test-result');
            
            if (difBaixaAlta < 10) {
                log('‚ùå [PROBLEMA] DETECTADO: Sistema n√£o est√° diferenciando qualidades!', 'test-result');
                log('‚ùå [PROBLEMA] Diferen√ßa muito pequena entre qualidades extremas', 'test-result');
                log('‚ùå [PROBLEMA] Esperado: pelo menos 30-50 pontos de diferen√ßa', 'test-result');
            } else {
                log('‚úÖ [OK] Sistema est√° diferenciando qualidades adequadamente', 'test-result');
            }
        }
        
        function diagnosticarSistema() {
            log('üî¨ [DIAGN√ìSTICO] Analisando sistema...', 'diagnostic-result');
            
            // Verificar fun√ß√µes carregadas
            const funcoes = [
                'computeMixScore',
                '_computeMixScoreInternal',
                '_computeEqualWeightV3'
            ];
            
            funcoes.forEach(func => {
                const existe = typeof window[func] === 'function';
                log(`${existe ? '‚úÖ' : '‚ùå'} ${func}: ${existe ? 'OK' : 'N√ÉO ENCONTRADA'}`, 'diagnostic-result');
            });
            
            // Verificar vers√£o do scoring
            if (window.__MIX_SCORING_VERSION__) {
                log(`üìã [VERS√ÉO] ${window.__MIX_SCORING_VERSION__}`, 'diagnostic-result');
                
                if (window.__MIX_SCORING_VERSION__.includes('FORCED')) {
                    log('‚ö†Ô∏è [ALERTA] Sistema est√° FOR√áADO - pode ter bugs!', 'diagnostic-result');
                }
            }
            
            // Verificar cache
            if (window.__LAST_MIX_SCORE) {
                log(`üóÑÔ∏è [CACHE] √öltimo score em cache: ${window.__LAST_MIX_SCORE.scorePct}%`, 'diagnostic-result');
                log('‚ö†Ô∏è [CACHE] Cache pode estar interferindo - considere limpar', 'diagnostic-result');
            }
            
            // Verificar an√°lise anterior
            if (window.__LAST_FULL_ANALYSIS) {
                log('üìä [AN√ÅLISE] An√°lise anterior encontrada', 'diagnostic-result');
            }
        }
        
        function verificarFlags() {
            log('üèÅ [FLAGS] Verificando flags do sistema...', 'diagnostic-result');
            
            const flags = {
                'AUDIT_MODE': window.AUDIT_MODE,
                'SCORING_V2': window.SCORING_V2,
                'USE_TT_DR': window.USE_TT_DR,
                'AUTO_SCORING_V2': window.AUTO_SCORING_V2,
                'PROD_AI_REF_GENRE': window.PROD_AI_REF_GENRE,
                'PROD_AI_REF_DATA_ACTIVE': window.PROD_AI_REF_DATA_ACTIVE
            };
            
            Object.entries(flags).forEach(([flag, valor]) => {
                log(`${valor ? '‚úÖ' : '‚ùå'} ${flag}: ${valor}`, 'diagnostic-result');
            });
            
            const flagsAtivas = Object.values(flags).filter(Boolean).length;
            log(`üìä [TOTAL] ${flagsAtivas}/${Object.keys(flags).length} flags ativas`, 'diagnostic-result');
            
            if (flagsAtivas < 3) {
                log('‚ö†Ô∏è [ALERTA] Poucas flags ativas - sistema pode n√£o funcionar corretamente', 'diagnostic-result');
            }
        }
        
        function testarFuncoes() {
            log('‚öôÔ∏è [TESTE-FUNC] Testando fun√ß√µes espec√≠ficas...', 'diagnostic-result');
            
            // Teste b√°sico da fun√ß√£o principal
            if (window.computeMixScore) {
                try {
                    const dadosSimples = {
                        lufsIntegrated: -14,
                        truePeakDbtp: -3,
                        dynamicRange: 10
                    };
                    
                    const resultado = window.computeMixScore(dadosSimples, null);
                    log(`‚úÖ [FUNC] computeMixScore funcionando: ${resultado.scorePct}%`, 'diagnostic-result');
                } catch (error) {
                    log(`‚ùå [FUNC] Erro em computeMixScore: ${error.message}`, 'diagnostic-result');
                }
            }
            
            // Teste da fun√ß√£o Equal Weight V3
            if (window._computeEqualWeightV3) {
                try {
                    const dadosTest = {
                        metrics: { lufsIntegrated: -14, truePeakDbtp: -3 },
                        reference: { lufs_target: -14, true_peak_target: -3 }
                    };
                    
                    const resultado = window._computeEqualWeightV3(dadosTest);
                    log(`‚úÖ [FUNC] _computeEqualWeightV3 funcionando: ${resultado.score}%`, 'diagnostic-result');
                } catch (error) {
                    log(`‚ùå [FUNC] Erro em _computeEqualWeightV3: ${error.message}`, 'diagnostic-result');
                }
            }
        }
        
        function aplicarSolucao1() {
            log('üîß [SOLU√á√ÉO-1] Limpando cache do sistema...', 'solution-result');
            
            // Limpar caches
            if (window.__LAST_MIX_SCORE) {
                delete window.__LAST_MIX_SCORE;
                log('‚úÖ [CACHE] __LAST_MIX_SCORE removido', 'solution-result');
            }
            
            if (window.__LAST_FULL_ANALYSIS) {
                delete window.__LAST_FULL_ANALYSIS;
                log('‚úÖ [CACHE] __LAST_FULL_ANALYSIS removido', 'solution-result');
            }
            
            log('‚úÖ [SOLU√á√ÉO-1] Cache limpo - teste novamente', 'solution-result');
        }
        
        function aplicarSolucao2() {
            log('üèÅ [SOLU√á√ÉO-2] Reconfigurando flags...', 'solution-result');
            
            // Configurar flags essenciais
            window.AUDIT_MODE = true;
            window.SCORING_V2 = true;
            window.USE_TT_DR = true;
            window.AUTO_SCORING_V2 = true;
            window.PROD_AI_REF_DATA_ACTIVE = true;
            
            log('‚úÖ [FLAGS] AUDIT_MODE = true', 'solution-result');
            log('‚úÖ [FLAGS] SCORING_V2 = true', 'solution-result');
            log('‚úÖ [FLAGS] USE_TT_DR = true', 'solution-result');
            log('‚úÖ [FLAGS] AUTO_SCORING_V2 = true', 'solution-result');
            log('‚úÖ [FLAGS] PROD_AI_REF_DATA_ACTIVE = true', 'solution-result');
            
            log('‚úÖ [SOLU√á√ÉO-2] Flags reconfiguradas - teste novamente', 'solution-result');
        }
        
        function aplicarSolucao3() {
            log('üîÑ [SOLU√á√ÉO-3] Recarregando sistema...', 'solution-result');
            
            // Recarregar p√°gina ap√≥s 3 segundos
            log('‚è≥ [RELOAD] Recarregando p√°gina em 3 segundos...', 'solution-result');
            
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üî¨ Teste espec√≠fico do problema de score carregado');
            
            // Auto-verificar ap√≥s 2 segundos
            setTimeout(() => {
                if (window.computeMixScore) {
                    console.log('‚úÖ Sistema de scoring detectado automaticamente');
                } else {
                    console.warn('‚ö†Ô∏è Sistema de scoring n√£o detectado - aguardando...');
                }
            }, 2000);
        });
    </script>
</body>
</html>
