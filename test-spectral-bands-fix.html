<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste Final - Bandas Espectrais Corrigidas</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; font-family: 'Consolas', monospace; font-size: 12px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .critical { border-left: 4px solid #dc3545; background: #fff5f5; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; margin: 10px 0; max-height: 300px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste Final - Corre√ß√£o Bandas Espectrais</h1>
        <p><strong>Objetivo:</strong> Verificar se as bandas espectrais agora usam targets da refer√™ncia</p>
        
        <button onclick="testSpectralBandsReference()">üß™ Testar Bandas Espectrais com Refer√™ncia</button>
        <button onclick="testIdenticalMusicScenario()">üéµ Simular M√∫sicas Id√™nticas</button>
        <button onclick="clearResults()">üßπ Limpar</button>
        
        <div id="results"></div>
        <div id="logs" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            logDiv.innerHTML += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function addResult(success, message, critical = false) {
            const resultsDiv = document.getElementById('results');
            let resultClass = success ? 'success' : 'error';
            if (critical) resultClass += ' critical';
            resultsDiv.innerHTML += `<div class="test-result ${resultClass}">${message}</div>`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('logs').innerHTML = '';
        }

        async function testSpectralBandsReference() {
            clearResults();
            log('=== TESTE BANDAS ESPECTRAIS COM REFER√äNCIA ===');
            
            try {
                // 1. Simular bandas espectrais da m√∫sica de refer√™ncia
                const referenceBandEnergies = {
                    sub: { rms_db: -10.5 },
                    low_bass: { rms_db: -8.2 },
                    mid: { rms_db: -6.8 },
                    high_mid: { rms_db: -7.1 },
                    brilho: { rms_db: -9.3 }
                };
                
                log('Bandas espectrais da refer√™ncia simuladas');
                addResult(true, '‚úÖ PASSO 1: Bandas espectrais da refer√™ncia criadas');
                
                // 2. Criar targets baseados na refer√™ncia
                const referenceTargets = {
                    lufs_target: -12.5,
                    stereo_target: 0.75,
                    dr_target: 8.3,
                    true_peak_target: -0.8,
                    bands: {}
                };
                
                // Converter bandEnergies em targets
                for (const [bandName, bandData] of Object.entries(referenceBandEnergies)) {
                    referenceTargets.bands[bandName] = {
                        target_db: bandData.rms_db,
                        tol_db: 1.0,
                        tol_min: 0.5,
                        tol_max: 1.5
                    };
                }
                
                log('Targets de bandas criados baseados na refer√™ncia');
                log(`Exemplo: sub target = ${referenceTargets.bands.sub.target_db}dB`);
                addResult(true, '‚úÖ PASSO 2: Targets de bandas criados a partir da refer√™ncia');
                
                // 3. Aplicar ao sistema temporariamente
                const originalRefData = window.PROD_AI_REF_DATA;
                const originalRefGenre = window.PROD_AI_REF_GENRE;
                
                window.PROD_AI_REF_DATA = {
                    reference_music: referenceTargets
                };
                window.PROD_AI_REF_GENRE = 'reference_music';
                
                log('Sistema configurado para usar targets de bandas da refer√™ncia');
                addResult(true, '‚úÖ PASSO 3: Sistema configurado com targets de bandas da refer√™ncia');
                
                // 4. Simular bandas espectrais do usu√°rio (diferentes da refer√™ncia)
                const userBandEnergies = {
                    sub: { rms_db: -12.0 },     // -1.5dB vs refer√™ncia (-10.5)
                    low_bass: { rms_db: -7.5 }, // +0.7dB vs refer√™ncia (-8.2)
                    mid: { rms_db: -8.1 },      // -1.3dB vs refer√™ncia (-6.8)
                    high_mid: { rms_db: -6.8 }, // +0.3dB vs refer√™ncia (-7.1)
                    brilho: { rms_db: -10.1 }   // -0.8dB vs refer√™ncia (-9.3)
                };
                
                // 5. Calcular diferen√ßas espec√≠ficas da refer√™ncia
                const differences = {};
                let totalDifference = 0;
                let bandCount = 0;
                
                for (const bandName of Object.keys(referenceBandEnergies)) {
                    const userValue = userBandEnergies[bandName].rms_db;
                    const refValue = referenceBandEnergies[bandName].rms_db;
                    const diff = userValue - refValue;
                    differences[bandName] = diff;
                    totalDifference += Math.abs(diff);
                    bandCount++;
                    
                    log(`Banda ${bandName}: Usuario(${userValue}) vs Ref(${refValue}) = ${diff.toFixed(1)}dB`);
                }
                
                const avgDifference = totalDifference / bandCount;
                log(`Diferen√ßa m√©dia das bandas: ${avgDifference.toFixed(2)}dB`);
                
                if (avgDifference > 0.1) {
                    addResult(true, `‚úÖ PASSO 4: Diferen√ßas detectadas nas bandas (m√©dia: ${avgDifference.toFixed(2)}dB)`);
                } else {
                    addResult(false, '‚ùå PASSO 4: Diferen√ßas muito pequenas - poss√≠vel problema');
                }
                
                // 6. Verificar se targets est√£o acess√≠veis ao sistema
                const systemTargets = window.PROD_AI_REF_DATA?.reference_music?.bands;
                if (systemTargets && systemTargets.sub && systemTargets.sub.target_db === -10.5) {
                    addResult(true, '‚úÖ PASSO 5: Targets de bandas acess√≠veis pelo sistema de an√°lise');
                    log('Sistema pode acessar targets de bandas da refer√™ncia');
                } else {
                    addResult(false, '‚ùå PASSO 5: Targets de bandas n√£o acess√≠veis');
                }
                
                // 7. Gerar sugest√µes baseadas na refer√™ncia
                const suggestions = [];
                for (const [bandName, diff] of Object.entries(differences)) {
                    if (Math.abs(diff) > 0.5) {
                        const action = diff > 0 ? 'Diminuir' : 'Aumentar';
                        const suggestion = `${action} ${bandName} em ${Math.abs(diff).toFixed(1)}dB para igualar √† refer√™ncia`;
                        suggestions.push(suggestion);
                    }
                }
                
                log(`Sugest√µes de bandas geradas: ${suggestions.length} sugest√µes`);
                suggestions.forEach((suggestion, index) => {
                    addResult(true, `‚úÖ Sugest√£o ${index + 1}: ${suggestion}`);
                });
                
                // 8. Restaurar estado original
                window.PROD_AI_REF_DATA = originalRefData;
                window.PROD_AI_REF_GENRE = originalRefGenre;
                
                addResult(true, '‚úÖ PASSO 6: Estado original restaurado', true);
                addResult(true, 'üéâ BANDAS ESPECTRAIS AGORA USAM TARGETS DA REFER√äNCIA!', true);
                
            } catch (error) {
                log(`Erro durante teste: ${error.message}`, 'error');
                addResult(false, `‚ùå Erro: ${error.message}`);
            }
        }

        async function testIdenticalMusicScenario() {
            clearResults();
            log('=== TESTE M√öSICAS ID√äNTICAS ===');
            
            try {
                // Simular an√°lise da mesma m√∫sica como usu√°rio e refer√™ncia
                const identicalBandEnergies = {
                    sub: { rms_db: -9.8 },
                    low_bass: { rms_db: -7.5 },
                    mid: { rms_db: -6.2 },
                    high_mid: { rms_db: -7.8 },
                    brilho: { rms_db: -8.9 }
                };
                
                log('Simulando an√°lise da MESMA m√∫sica como usu√°rio e refer√™ncia');
                
                // Calcular diferen√ßas (devem ser zero)
                let totalDifference = 0;
                let maxDifference = 0;
                
                for (const [bandName, bandData] of Object.entries(identicalBandEnergies)) {
                    const diff = bandData.rms_db - bandData.rms_db; // 0
                    totalDifference += Math.abs(diff);
                    maxDifference = Math.max(maxDifference, Math.abs(diff));
                    
                    log(`Banda ${bandName}: Usuario(${bandData.rms_db}) vs Ref(${bandData.rms_db}) = ${diff}dB`);
                }
                
                if (totalDifference === 0 && maxDifference === 0) {
                    addResult(true, '‚úÖ M√öSICAS ID√äNTICAS: Diferen√ßa total = 0dB em todas as bandas', true);
                    log('Resultado esperado: Nenhuma sugest√£o de corre√ß√£o deve ser gerada');
                } else {
                    addResult(false, `‚ùå PROBLEMA: M√∫sicas id√™nticas mostram diferen√ßas (total: ${totalDifference}dB)`);
                }
                
                log('=== TESTE CONCLU√çDO ===');
                
            } catch (error) {
                log(`Erro durante teste: ${error.message}`, 'error');
                addResult(false, `‚ùå Erro: ${error.message}`);
            }
        }
    </script>
</body>
</html>
