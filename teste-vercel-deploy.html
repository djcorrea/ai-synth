<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Teste Deploy Vercel - Scoring</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #0a0a0a; color: #00ff00; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; }
        button { padding: 10px 20px; margin: 10px; background: #333; color: #fff; border: none; cursor: pointer; }
        button:hover { background: #555; }
        #results { margin-top: 20px; }
        .score-display { font-size: 18px; font-weight: bold; margin: 10px 0; padding: 10px; border-left: 3px solid #00ff00; }
        .reference-display { background: #1a1a1a; padding: 10px; margin: 10px 0; font-size: 12px; }
        .status { padding: 10px; margin: 10px 0; }
        .success { background: #001a00; border-left: 3px solid #00ff00; }
        .error { background: #1a0000; border-left: 3px solid #ff0000; color: #ff6666; }
        .warning { background: #1a1a00; border-left: 3px solid #ffff00; color: #ffff66; }
    </style>
</head>
<body>
    <h1>🚀 Teste Deploy Vercel - Scoring System</h1>
    
    <div class="test-section">
        <h2>🎯 Validação Completa do Sistema</h2>
        <p>Este teste simula exatamente o que acontece no Vercel em produção</p>
        <button onclick="executarTeste()">🚀 Executar Teste Completo</button>
        <button onclick="limparTeste()">🧹 Limpar</button>
    </div>
    
    <div id="results"></div>
    
    <script type="module">
        console.log('🚀 [VERCEL_TEST] Iniciando teste de deploy Vercel');
        
        let testResults = [];
        
        function addResult(status, message, details = '') {
            const result = { status, message, details, timestamp: new Date().toLocaleTimeString() };
            testResults.push(result);
            updateDisplay();
        }
        
        function updateDisplay() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = testResults.map(result => `
                <div class="status ${result.status}">
                    <strong>[${result.timestamp}] ${result.message}</strong>
                    ${result.details ? `<div class="reference-display">${result.details}</div>` : ''}
                </div>
            `).join('');
        }
        
        async function executarTeste() {
            console.log('\\n🚀 [VERCEL_TEST] ======= INICIANDO TESTE COMPLETO =======');
            testResults = [];
            addResult('warning', '🚀 Iniciando teste de deploy Vercel...');
            
            // 1. Testar carregamento dos módulos
            addResult('warning', '📦 Fase 1: Testando carregamento de módulos');
            
            try {
                // Cache busting agressivo como no Vercel
                const cacheBuster = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Testar audio-analyzer
                addResult('warning', '📦 Carregando audio-analyzer.js...');
                const audioAnalyzer = await import(`./audio-analyzer.js?cb=${cacheBuster}`);
                addResult('success', '✅ audio-analyzer.js carregado com sucesso');
                
                // Testar scoring.js
                addResult('warning', '📦 Carregando scoring.js...');
                const scoringModule = await import(`./lib/audio/features/scoring.js?cb=${cacheBuster}`);
                addResult('success', '✅ scoring.js carregado com sucesso');
                
                // 2. Testar carregamento de referências
                addResult('warning', '📋 Fase 2: Testando carregamento de referências');
                
                const referencias = [
                    { nome: 'funk_mandela', url: '/refs/out/funk_mandela.json' },
                    { nome: 'trance', url: '/refs/out/trance.json' },
                    { nome: 'eletronico', url: '/refs/out/eletronico.json' }
                ];
                
                const refData = {};
                
                for (const ref of referencias) {
                    try {
                        addResult('warning', `📋 Carregando ${ref.nome}...`);
                        const response = await fetch(ref.url);
                        if (response.ok) {
                            const data = await response.json();
                            refData[ref.nome] = data;
                            addResult('success', `✅ ${ref.nome} carregado`, 
                                `lufs_target: ${data.lufs_target}, dr_target: ${data.dr_target}, stereo_target: ${data.stereo_target}`);
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    } catch (error) {
                        addResult('error', `❌ Erro ao carregar ${ref.nome}: ${error.message}`);
                        // Fallback hardcoded
                        const fallbacks = {
                            funk_mandela: { lufs_target: -11.5, dr_target: 6.8, stereo_target: 0.2 },
                            trance: { lufs_target: -12.8, dr_target: 9.2, stereo_target: 0.35 },
                            eletronico: { lufs_target: -13.2, dr_target: 8.5, stereo_target: 0.3 }
                        };
                        refData[ref.nome] = fallbacks[ref.nome];
                        addResult('warning', `⚠️ Usando fallback para ${ref.nome}`, 
                            `lufs_target: ${fallbacks[ref.nome].lufs_target}, dr_target: ${fallbacks[ref.nome].dr_target}`);
                    }
                }
                
                // 3. Testar scoring com dados reais
                addResult('warning', '🎯 Fase 3: Testando sistema de scoring');
                
                // Dados técnicos de teste consistentes
                const testTechnicalData = {
                    lufsIntegrated: -12.3,
                    truePeakDbtp: -0.8,
                    dr: 8.2,
                    lra: 6.1,
                    stereoCorrelation: 0.25,
                    dynamicRange: 8.2,
                    dr_stat: 8.2,
                    crestFactor: 12.3,
                    spectralCentroid: 2800,
                    spectralFlatness: 0.18,
                    spectralRolloff85: 7500,
                    dcOffsetLeft: 0.001,
                    dcOffsetRight: -0.002,
                    clippingPct: 0.1
                };
                
                const scores = {};
                
                for (const [genero, reference] of Object.entries(refData)) {
                    try {
                        addResult('warning', `🎵 Calculando score para ${genero}...`);
                        
                        const result = scoringModule.computeMixScore(testTechnicalData, reference);
                        scores[genero] = result;
                        
                        addResult('success', `✅ ${genero}: ${result.scorePct}% (${result.classification})`,
                            `Engine: ${result.engineVersion}, Method: ${result.method}`);
                            
                    } catch (error) {
                        addResult('error', `❌ Erro ao calcular score para ${genero}: ${error.message}`);
                    }
                }
                
                // 4. Validação final
                addResult('warning', '🔍 Fase 4: Validação final');
                
                const scoreValues = Object.values(scores).map(s => s.scorePct);
                const uniqueScores = new Set(scoreValues);
                
                if (uniqueScores.size === scoreValues.length) {
                    addResult('success', '✅ SUCESSO: Todos os scores são diferentes!');
                    addResult('success', '🎉 Sistema funcionando corretamente no ambiente Vercel');
                } else {
                    addResult('error', '❌ FALHA: Alguns scores são idênticos');
                    addResult('error', `Scores encontrados: ${scoreValues.join(', ')}`);
                }
                
                // Resumo final
                const resumo = Object.entries(scores).map(([genero, result]) => 
                    `${genero}: ${result.scorePct}%`
                ).join(' | ');
                
                addResult('success', '📊 RESUMO FINAL', resumo);
                
            } catch (error) {
                addResult('error', `❌ ERRO CRÍTICO: ${error.message}`);
                console.error('[VERCEL_TEST] Erro crítico:', error);
            }
        }
        
        window.executarTeste = executarTeste;
        
        window.limparTeste = () => {
            testResults = [];
            updateDisplay();
            console.clear();
            console.log('🚀 [VERCEL_TEST] Teste limpo - pronto para nova execução');
        };
        
        // Auto-executar o teste ao carregar
        setTimeout(executarTeste, 1000);
    </script>
</body>
</html>
