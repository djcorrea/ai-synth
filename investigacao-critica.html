<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® INVESTIGA√á√ÉO CR√çTICA - Descobrir Problema do Score</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff41;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #111;
            border: 3px solid #ff3333;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.5);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #ff3333;
            padding-bottom: 20px;
        }
        .critical {
            background: #330000;
            border: 2px solid #ff3333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
        }
        .test-section {
            background: #1a1a1a;
            border-left: 5px solid #ffaa00;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .results {
            background: #000;
            color: #00ff41;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        button {
            background: #ff3333;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        button:hover {
            background: #ff5555;
            transform: scale(1.05);
        }
        button.success {
            background: #00aa00;
        }
        button.warning {
            background: #ff8800;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            margin: 5px;
        }
        .status.error { background: #ff3333; color: white; }
        .status.warning { background: #ffaa00; color: black; }
        .status.success { background: #00ff41; color: black; }
        .status.info { background: #66aaff; color: black; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .console-log {
            color: #00ff41;
        }
        .console-error {
            color: #ff3333;
        }
        .console-warn {
            color: #ffaa00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® INVESTIGA√á√ÉO CR√çTICA</h1>
            <h2>Descobrir POR QUE o Score N√£o Muda</h2>
            <p><span class="status error">PROBLEMA</span> Score sempre fica em 36 pontos</p>
            <p><span class="status warning">DESCOBERTA</span> "Corre√ß√£o" da ordem foi desnecess√°ria</p>
        </div>

        <div class="critical">
            <h3>üéØ OBJETIVO DA INVESTIGA√á√ÉO</h3>
            <p>Executar 6 testes para descobrir EXATAMENTE onde est√° o problema:</p>
            <ol>
                <li><strong>TESTE 1:</strong> Sistema b√°sico funcionando?</li>
                <li><strong>TESTE 2:</strong> Refer√™ncia tem dados de bandas?</li>
                <li><strong>TESTE 3:</strong> Simular dados com/sem bandas</li>
                <li><strong>TESTE 4:</strong> Scoring considera bandas?</li>
                <li><strong>TESTE 5:</strong> An√°lise real tem bandEnergies?</li>
                <li><strong>TESTE 6:</strong> Scoring funciona na an√°lise real?</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üöÄ EXECUTAR INVESTIGA√á√ÉO COMPLETA</h3>
            <button onclick="executarInvestigacaoCompleta()" class="success">
                üî¨ INVESTIGAR TUDO AGORA
            </button>
            <button onclick="limparResultados()">
                üóëÔ∏è Limpar Resultados
            </button>
        </div>

        <div class="test-section">
            <h3>üß™ TESTES INDIVIDUAIS</h3>
            <div class="grid">
                <button onclick="executarTeste(1)">üîç Teste 1: Sistema</button>
                <button onclick="executarTeste(2)">üéµ Teste 2: Refer√™ncia</button>
                <button onclick="executarTeste(3)">üìä Teste 3: Dados</button>
                <button onclick="executarTeste(4)">üßÆ Teste 4: Scoring</button>
                <button onclick="executarTeste(5)">üìà Teste 5: An√°lise</button>
                <button onclick="executarTeste(6)">üéØ Teste 6: Real</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üìä RESULTADOS DA INVESTIGA√á√ÉO</h3>
            <div id="resultados" class="results">
                Clique em "INVESTIGAR TUDO AGORA" para descobrir o problema...
            </div>
        </div>

        <div class="test-section">
            <h3>üîß FERRAMENTAS DE DEBUG</h3>
            <div class="grid">
                <button onclick="inspecionarGlobals()" class="warning">
                    üåç Inspecionar Globais
                </button>
                <button onclick="testarScoringDireto()" class="warning">
                    ‚ö° Teste Scoring Direto
                </button>
                <button onclick="analisarUltimaAnalise()" class="warning">
                    üîç Analisar √öltima An√°lise
                </button>
                <button onclick="verificarConsole()" class="warning">
                    üìã Verificar Console
                </button>
            </div>
        </div>
    </div>

    <!-- Carregar depend√™ncias do sistema -->
    <script src="lib/audio/features/scoring.js"></script>
    <script src="public/audio-analyzer.js"></script>
    <script src="public/refs/embedded-refs-new.js"></script>
    
    <!-- Carregar script de investiga√ß√£o -->
    <script src="investigacao-critica-score.js"></script>
    
    <script>
        // Interceptar logs do console para mostrar na tela
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        let logBuffer = [];
        
        function addToBuffer(type, args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            logBuffer.push({
                timestamp,
                type,
                message
            });
            
            // Manter apenas √∫ltimas 100 mensagens
            if (logBuffer.length > 100) {
                logBuffer = logBuffer.slice(-100);
            }
        }
        
        console.log = function(...args) {
            addToBuffer('log', args);
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            addToBuffer('error', args);
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            addToBuffer('warn', args);
            originalWarn.apply(console, args);
        };
        
        /**
         * Executar investiga√ß√£o completa
         */
        function executarInvestigacaoCompleta() {
            const output = document.getElementById('resultados');
            output.innerHTML = 'üöÄ Executando investiga√ß√£o completa...\n\n';
            
            try {
                // Verificar se fun√ß√£o est√° carregada
                if (typeof window.investigacaoCompleta !== 'function') {
                    throw new Error('Script de investiga√ß√£o n√£o carregado corretamente');
                }
                
                // Executar investiga√ß√£o
                const resultado = window.investigacaoCompleta();
                
                // Formatiar resultado
                let relatorio = 'üî¨ INVESTIGA√á√ÉO COMPLETA EXECUTADA\n';
                relatorio += '='.repeat(60) + '\n\n';
                
                relatorio += 'üìÖ Timestamp: ' + resultado.timestamp + '\n';
                relatorio += 'üö® Problemas encontrados: ' + resultado.problemas.length + '\n';
                relatorio += 'üèÅ Conclus√£o: ' + resultado.conclusao + '\n\n';
                
                if (resultado.problemas.length > 0) {
                    relatorio += 'üìã LISTA DE PROBLEMAS:\n';
                    relatorio += '-'.repeat(30) + '\n';
                    resultado.problemas.forEach((problema, i) => {
                        relatorio += `${i + 1}. ${problema}\n`;
                    });
                    relatorio += '\n';
                }
                
                // Adicionar logs do buffer
                relatorio += 'üìù LOGS DA INVESTIGA√á√ÉO:\n';
                relatorio += '-'.repeat(30) + '\n';
                
                const logsRecentes = logBuffer.slice(-20); // √öltimos 20 logs
                logsRecentes.forEach(log => {
                    const prefix = log.type === 'error' ? '‚ùå' : 
                                 log.type === 'warn' ? '‚ö†Ô∏è' : 'üìù';
                    relatorio += `${prefix} [${log.timestamp}] ${log.message}\n`;
                });
                
                output.innerHTML = relatorio;
                
            } catch (error) {
                output.innerHTML = '‚ùå ERRO na investiga√ß√£o: ' + error.message + '\n\n' +
                    'Poss√≠veis causas:\n' +
                    '1. Script n√£o carregou corretamente\n' +
                    '2. Sistema de √°udio n√£o inicializado\n' +
                    '3. P√°ginas n√£o carregou completamente\n\n' +
                    'Abra o Console (F12) para mais detalhes.';
                console.error('Erro na investiga√ß√£o:', error);
            }
        }
        
        /**
         * Executar teste individual
         */
        function executarTeste(numero) {
            const output = document.getElementById('resultados');
            output.innerHTML = `üß™ Executando Teste ${numero}...\n\n`;
            
            try {
                let resultado;
                
                switch(numero) {
                    case 1:
                        resultado = window.teste1_verificarSistema();
                        break;
                    case 2:
                        resultado = window.teste2_verificarReferencia();
                        break;
                    case 3:
                        resultado = window.teste3_simularDados();
                        break;
                    case 4:
                        const { dadosComBandas, dadosSemBandas } = window.teste3_simularDados();
                        const referencia = window.teste2_verificarReferencia();
                        resultado = window.teste4_executarScoring(dadosComBandas, dadosSemBandas, referencia);
                        break;
                    case 5:
                        resultado = window.teste5_verificarUltimaAnalise();
                        break;
                    case 6:
                        const td = window.teste5_verificarUltimaAnalise();
                        const ref = window.teste2_verificarReferencia();
                        resultado = window.teste6_scoringAnaliseReal(td, ref);
                        break;
                    default:
                        throw new Error('N√∫mero de teste inv√°lido');
                }
                
                // Mostrar resultado
                let relatorio = `üß™ TESTE ${numero} EXECUTADO\n`;
                relatorio += '='.repeat(40) + '\n\n';
                relatorio += 'Resultado: ' + JSON.stringify(resultado, null, 2) + '\n\n';
                
                // Logs recentes
                const logsRecentes = logBuffer.slice(-10);
                relatorio += 'üìù Logs do teste:\n';
                logsRecentes.forEach(log => {
                    relatorio += `[${log.timestamp}] ${log.message}\n`;
                });
                
                output.innerHTML = relatorio;
                
            } catch (error) {
                output.innerHTML = `‚ùå ERRO no Teste ${numero}: ${error.message}`;
                console.error(`Erro no teste ${numero}:`, error);
            }
        }
        
        /**
         * Inspecionar vari√°veis globais
         */
        function inspecionarGlobals() {
            const output = document.getElementById('resultados');
            
            let relatorio = 'üåç INSPE√á√ÉO DE VARI√ÅVEIS GLOBAIS\n';
            relatorio += '='.repeat(50) + '\n\n';
            
            const vars = [
                'audioAnalyzer',
                'scoringModule', 
                'PROD_AI_REF_DATA',
                'PROD_AI_REF_GENRE',
                'PROD_AI_REF_DATA_ACTIVE'
            ];
            
            vars.forEach(varName => {
                const exists = typeof window[varName] !== 'undefined';
                const type = typeof window[varName];
                const value = exists ? (type === 'object' ? 'Object' : String(window[varName]).slice(0, 100)) : 'undefined';
                
                relatorio += `${exists ? '‚úÖ' : '‚ùå'} ${varName}: ${type} = ${value}\n`;
            });
            
            // Verificar propriedades importantes
            relatorio += '\nüìä PROPRIEDADES IMPORTANTES:\n';
            relatorio += '-'.repeat(30) + '\n';
            
            if (window.audioAnalyzer) {
                relatorio += `audioAnalyzer.lastAnalysis: ${!!window.audioAnalyzer.lastAnalysis}\n`;
                if (window.audioAnalyzer.lastAnalysis) {
                    const td = window.audioAnalyzer.lastAnalysis.technicalData;
                    relatorio += `lastAnalysis.technicalData: ${!!td}\n`;
                    relatorio += `technicalData.bandEnergies: ${!!(td && td.bandEnergies)}\n`;
                }
            }
            
            if (window.PROD_AI_REF_DATA) {
                relatorio += `PROD_AI_REF_DATA g√™neros: ${Object.keys(window.PROD_AI_REF_DATA).length}\n`;
                relatorio += `G√™neros: ${Object.keys(window.PROD_AI_REF_DATA).join(', ')}\n`;
            }
            
            output.innerHTML = relatorio;
        }
        
        /**
         * Testar scoring diretamente
         */
        function testarScoringDireto() {
            const output = document.getElementById('resultados');
            
            let relatorio = '‚ö° TESTE SCORING DIRETO\n';
            relatorio += '='.repeat(40) + '\n\n';
            
            try {
                if (!window.scoringModule || !window.scoringModule.computeMixScore) {
                    throw new Error('scoringModule n√£o dispon√≠vel');
                }
                
                // Dados de teste b√°sicos
                const testData = {
                    lufsIntegrated: -12.0,
                    truePeakDbtp: -3.0,
                    dynamicRange: 8.0,
                    lra: 7.0,
                    stereoCorrelation: 0.5
                };
                
                // Teste sem refer√™ncia
                relatorio += 'üß™ Teste sem refer√™ncia:\n';
                const scoreSemRef = window.scoringModule.computeMixScore(testData, null);
                relatorio += `Resultado: ${JSON.stringify(scoreSemRef, null, 2)}\n\n`;
                
                // Teste com refer√™ncia (se dispon√≠vel)
                if (window.PROD_AI_REF_DATA) {
                    const firstGenre = Object.keys(window.PROD_AI_REF_DATA)[0];
                    const ref = window.PROD_AI_REF_DATA[firstGenre];
                    
                    relatorio += `üß™ Teste com refer√™ncia (${firstGenre}):\n`;
                    const scoreComRef = window.scoringModule.computeMixScore(testData, ref);
                    relatorio += `Resultado: ${JSON.stringify(scoreComRef, null, 2)}\n\n`;
                }
                
            } catch (error) {
                relatorio += '‚ùå Erro: ' + error.message + '\n';
            }
            
            output.innerHTML = relatorio;
        }
        
        /**
         * Analisar √∫ltima an√°lise
         */
        function analisarUltimaAnalise() {
            const output = document.getElementById('resultados');
            
            let relatorio = 'üîç AN√ÅLISE DA √öLTIMA AN√ÅLISE\n';
            relatorio += '='.repeat(45) + '\n\n';
            
            if (!window.audioAnalyzer || !window.audioAnalyzer.lastAnalysis) {
                relatorio += '‚ùå Nenhuma an√°lise encontrada\n';
                relatorio += 'Execute uma an√°lise de √°udio primeiro.\n';
                output.innerHTML = relatorio;
                return;
            }
            
            const analysis = window.audioAnalyzer.lastAnalysis;
            const td = analysis.technicalData;
            
            relatorio += 'üìä Estrutura da an√°lise:\n';
            relatorio += `timestamp: ${analysis.timestamp}\n`;
            relatorio += `duration: ${analysis.duration}\n`;
            relatorio += `technicalData keys: ${Object.keys(td).join(', ')}\n\n`;
            
            relatorio += 'üéµ M√©tricas principais:\n';
            relatorio += `LUFS: ${td.lufsIntegrated}\n`;
            relatorio += `True Peak: ${td.truePeakDbtp}\n`;
            relatorio += `Dynamic Range: ${td.dynamicRange}\n`;
            relatorio += `LRA: ${td.lra}\n`;
            relatorio += `Stereo Correlation: ${td.stereoCorrelation}\n\n`;
            
            if (td.bandEnergies) {
                relatorio += 'üéπ Bandas espectrais:\n';
                Object.entries(td.bandEnergies).forEach(([banda, dados]) => {
                    relatorio += `  ${banda}: ${dados.rms_db} dB (${dados.energyPct}%)\n`;
                });
            } else {
                relatorio += '‚ùå PROBLEMA: Nenhuma banda espectral encontrada!\n';
            }
            
            output.innerHTML = relatorio;
        }
        
        /**
         * Verificar console
         */
        function verificarConsole() {
            const output = document.getElementById('resultados');
            
            let relatorio = 'üìã LOGS DO CONSOLE\n';
            relatorio += '='.repeat(35) + '\n\n';
            
            if (logBuffer.length === 0) {
                relatorio += 'Nenhum log capturado ainda.\n';
                relatorio += 'Execute alguma opera√ß√£o para ver os logs.\n';
            } else {
                relatorio += `Total de logs capturados: ${logBuffer.length}\n\n`;
                
                // Mostrar √∫ltimos 20 logs
                const logsRecentes = logBuffer.slice(-20);
                logsRecentes.forEach(log => {
                    const prefix = log.type === 'error' ? '‚ùå' : 
                                 log.type === 'warn' ? '‚ö†Ô∏è' : 'üìù';
                    relatorio += `${prefix} [${log.timestamp}] ${log.message}\n`;
                });
            }
            
            output.innerHTML = relatorio;
        }
        
        /**
         * Limpar resultados
         */
        function limparResultados() {
            document.getElementById('resultados').innerHTML = 'Resultados limpos. Execute um teste para ver novos resultados.';
            logBuffer = [];
        }
        
        // Executar investiga√ß√£o automaticamente ao carregar
        window.addEventListener('load', () => {
            console.log('üî¨ P√°gina de investiga√ß√£o carregada');
            console.log('üéØ Pronto para investigar o problema do score');
            
            // Auto-executar ap√≥s 2 segundos
            setTimeout(() => {
                console.log('üöÄ Executando investiga√ß√£o autom√°tica...');
                executarInvestigacaoCompleta();
            }, 2000);
        });
    </script>
</body>
</html>
