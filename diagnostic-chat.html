<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Diagn√≥stico do Chat - PROD.AI</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #0a0a1a;
            color: white;
        }
        
        .diagnostic-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 10px;
            background: rgba(255,255,255,0.02);
        }
        
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #1a1a2e;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        
        .success { border-left: 5px solid #00ff00; }
        .error { border-left: 5px solid #ff0000; }
        .info { border-left: 5px solid #0099ff; }
        .warning { border-left: 5px solid #ffaa00; }
        
        .test-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #1d4ed8;
        }
        
        .test-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .logs {
            max-height: 300px;
            overflow-y: auto;
            background: #000;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .input-test {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <h1>üîß Diagn√≥stico Completo do Chat PROD.AI</h1>
        
        <div class="test-section">
            <h2>1. üìä Status do Sistema</h2>
            <div class="status info" id="systemStatus">Verificando sistema...</div>
            <button class="test-btn" onclick="checkSystemStatus()">üîç Verificar Sistema</button>
        </div>
        
        <div class="test-section">
            <h2>2. üî• Status do Firebase</h2>
            <div class="status info" id="firebaseStatus">Verificando Firebase...</div>
            <button class="test-btn" onclick="checkFirebase()">üîë Testar Firebase</button>
        </div>
        
        <div class="test-section">
            <h2>3. üåê Status da API</h2>
            <div class="status info" id="apiStatus">Verificando API...</div>
            <button class="test-btn" onclick="checkAPI()">üì° Testar API</button>
        </div>
        
        <div class="test-section">
            <h2>4. üí¨ Teste de Mensagem Completo</h2>
            <input type="text" class="input-test" id="testMessage" placeholder="Digite uma mensagem para testar..." value="Ol√°, como voc√™ est√°?">
            <div class="status info" id="messageStatus">Aguardando teste...</div>
            <button class="test-btn" onclick="testMessage()">üöÄ Enviar Mensagem</button>
            <button class="test-btn" onclick="clearLogs()">üßπ Limpar Logs</button>
        </div>
        
        <div class="test-section">
            <h2>5. üìã Logs Detalhados</h2>
            <div class="logs" id="detailedLogs">Logs aparecer√£o aqui...</div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBKby0RdIOGorhrfBRMCWnL25peU3epGTw",
            authDomain: "prodai-58436.firebaseapp.com",
            projectId: "prodai-58436",
            storageBucket: "prodai-58436.appspot.com",
            messagingSenderId: "801631191322",
            appId: "1:801631322:web:80e3d29cf7468331652ca3",
            measurementId: "G-MBDHDYN6Z0"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        
        // Configura√ß√£o da API
        const API_CONFIG = {
            baseURL: (() => {
                const host = window.location.hostname || '';
                const isVercel = host.endsWith('vercel.app');
                const isAiSynthProject = isVercel && host.toLowerCase().startsWith('ai-synth');
                if (isAiSynthProject || host === 'ai-synth.vercel.app') {
                    return '/api';
                }
                if (host === 'localhost' || host.startsWith('127.0.0.1')) {
                    return 'https://prod-ai-teste.vercel.app/api';
                }
                return 'https://prod-ai-teste.vercel.app/api';
            })(),
            get chatEndpoint() {
                return `${this.baseURL}/chat`;
            }
        };
        
        // Sistema de logs
        let logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({timestamp, message, type});
            
            const logsEl = document.getElementById('detailedLogs');
            const colorMap = {
                success: '#00ff00',
                error: '#ff0000',
                warning: '#ffaa00',
                info: '#00aaff'
            };
            
            logsEl.innerHTML += `<div style="color: ${colorMap[type] || '#fff'}">${logEntry}</div>`;
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('detailedLogs').innerHTML = 'Logs limpos...';
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `status ${type}`;
        }
        
        // Testes
        async function checkSystemStatus() {
            addLog('üîç Iniciando verifica√ß√£o do sistema...', 'info');
            
            try {
                // Verificar scripts carregados
                const scriptsLoaded = {
                    firebase: typeof firebase !== 'undefined',
                    auth: typeof firebase !== 'undefined' && firebase.auth,
                    fetch: typeof fetch !== 'undefined'
                };
                
                addLog(`üìã Scripts carregados: ${JSON.stringify(scriptsLoaded, null, 2)}`, 'info');
                
                // Verificar localStorage
                const localData = {
                    user: localStorage.getItem('user'),
                    idToken: localStorage.getItem('idToken')
                };
                
                addLog(`üíæ Dados locais: ${JSON.stringify(localData, null, 2)}`, 'info');
                
                // Verificar configura√ß√£o da API
                addLog(`üåê Configura√ß√£o da API: ${JSON.stringify(API_CONFIG, null, 2)}`, 'info');
                
                updateStatus('systemStatus', '‚úÖ Sistema OK - Todos os componentes carregados', 'success');
                
            } catch (error) {
                addLog(`‚ùå Erro na verifica√ß√£o do sistema: ${error.message}`, 'error');
                updateStatus('systemStatus', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function checkFirebase() {
            addLog('üîë Testando conex√£o com Firebase...', 'info');
            
            try {
                // Verificar se Firebase est√° carregado
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase n√£o carregado');
                }
                
                addLog('‚úÖ Firebase carregado', 'success');
                
                // Verificar autentica√ß√£o
                const currentUser = auth.currentUser;
                if (currentUser) {
                    addLog(`‚úÖ Usu√°rio autenticado: ${currentUser.email} (${currentUser.uid})`, 'success');
                    
                    // Testar token
                    const token = await currentUser.getIdToken();
                    addLog(`‚úÖ Token obtido: ${token.substring(0, 50)}...`, 'success');
                    
                    updateStatus('firebaseStatus', '‚úÖ Firebase OK - Usu√°rio autenticado', 'success');
                } else {
                    addLog('‚ö†Ô∏è Usu√°rio n√£o autenticado', 'warning');
                    updateStatus('firebaseStatus', '‚ö†Ô∏è Usu√°rio n√£o autenticado - Fa√ßa login primeiro', 'warning');
                }
                
            } catch (error) {
                addLog(`‚ùå Erro no Firebase: ${error.message}`, 'error');
                updateStatus('firebaseStatus', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function checkAPI() {
            addLog('üì° Testando conectividade com API...', 'info');
            
            try {
                addLog(`üéØ Endpoint: ${API_CONFIG.chatEndpoint}`, 'info');
                
                // Teste b√°sico de conectividade
                const response = await fetch(API_CONFIG.chatEndpoint, {
                    method: 'HEAD'
                });
                
                addLog(`üìä Resposta: ${response.status} ${response.statusText}`, 'info');
                addLog(`üìã Headers: ${JSON.stringify([...response.headers], null, 2)}`, 'info');
                
                if (response.status === 404) {
                    updateStatus('apiStatus', '‚ùå API n√£o encontrada (404)', 'error');
                } else if (response.status === 405) {
                    updateStatus('apiStatus', '‚úÖ API encontrada (m√©todo n√£o permitido = normal)', 'success');
                } else {
                    updateStatus('apiStatus', `‚úÖ API respondeu com status ${response.status}`, 'success');
                }
                
            } catch (error) {
                addLog(`‚ùå Erro na API: ${error.message}`, 'error');
                updateStatus('apiStatus', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function testMessage() {
            const message = document.getElementById('testMessage').value.trim();
            if (!message) {
                updateStatus('messageStatus', '‚ùå Digite uma mensagem primeiro', 'error');
                return;
            }
            
            addLog(`üöÄ Testando envio de mensagem: "${message}"`, 'info');
            updateStatus('messageStatus', '‚è≥ Enviando mensagem...', 'info');
            
            try {
                // Verificar autentica√ß√£o
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado');
                }
                
                addLog('‚úÖ Usu√°rio autenticado, obtendo token...', 'success');
                const idToken = await currentUser.getIdToken();
                addLog('‚úÖ Token obtido, enviando para API...', 'success');
                
                // Enviar mensagem
                const startTime = Date.now();
                const response = await fetch(API_CONFIG.chatEndpoint, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({ 
                        message, 
                        conversationHistory: [], 
                        idToken 
                    })
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                addLog(`üìä Resposta em ${duration}ms: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const rawText = await response.text();
                    addLog(`üìÑ Resposta raw (${rawText.length} chars): ${rawText.substring(0, 500)}${rawText.length > 500 ? '...' : ''}`, 'success');
                    
                    try {
                        const data = JSON.parse(rawText);
                        addLog(`‚úÖ JSON parseado: ${JSON.stringify(data, null, 2)}`, 'success');
                        
                        if (data.reply) {
                            updateStatus('messageStatus', '‚úÖ Mensagem enviada e resposta recebida com sucesso!', 'success');
                        } else {
                            updateStatus('messageStatus', '‚ö†Ô∏è Resposta recebida mas sem campo "reply"', 'warning');
                        }
                    } catch (parseError) {
                        addLog(`‚ùå Erro ao parsear JSON: ${parseError.message}`, 'error');
                        updateStatus('messageStatus', '‚ùå Resposta n√£o √© JSON v√°lido', 'error');
                    }
                } else {
                    const errorText = await response.text();
                    addLog(`‚ùå Erro HTTP: ${errorText}`, 'error');
                    updateStatus('messageStatus', `‚ùå Erro ${response.status}: ${response.statusText}`, 'error');
                }
                
            } catch (error) {
                addLog(`‚ùå Erro durante teste: ${error.message}`, 'error');
                updateStatus('messageStatus', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üéØ Diagn√≥stico iniciado', 'info');
            
            // Auto-check b√°sico
            setTimeout(() => {
                checkSystemStatus();
            }, 1000);
            
            setTimeout(() => {
                checkFirebase();
            }, 2000);
        });
    </script>
</body>
</html>
