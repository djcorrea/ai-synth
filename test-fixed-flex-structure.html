<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valida√ß√£o Funk Mandela - Estrutura Fixed/Flex</title>
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { 
            color: #333; 
            text-align: center; 
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        .section { 
            margin: 25px 0; 
            padding: 20px; 
            border-radius: 8px; 
            border-left: 4px solid #ddd;
        }
        .section h3 { 
            margin-top: 0; 
            color: #555; 
            font-size: 1.3em;
        }
        .fixed-section { 
            border-left-color: #dc3545; 
            background: #fff5f5; 
        }
        .flex-section { 
            border-left-color: #28a745; 
            background: #f8fff8; 
        }
        .validation-section { 
            border-left-color: #007bff; 
            background: #f8f9ff; 
        }
        .result { 
            margin: 12px 0; 
            padding: 12px; 
            border-radius: 6px; 
            font-weight: 500;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7; 
        }
        .info { 
            background: #e7f3ff; 
            color: #004085; 
            border: 1px solid #bee5eb; 
        }
        .controls { 
            text-align: center; 
            margin: 25px 0; 
        }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .btn-primary { 
            background: #007bff; 
            color: white; 
        }
        .btn-primary:hover { 
            background: #0056b3; 
            transform: translateY(-1px);
        }
        .btn-success { 
            background: #28a745; 
            color: white; 
        }
        .btn-success:hover { 
            background: #1e7e34; 
            transform: translateY(-1px);
        }
        .constraint-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .constraint-card {
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            background: white;
        }
        .constraint-card.fixed {
            border-color: #dc3545;
            background: #fff5f5;
        }
        .constraint-card.flex {
            border-color: #28a745;
            background: #f8fff8;
        }
        .constraint-card h4 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .constraint-card .value {
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.05);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 8px;
        }
        .badge-success { background: #28a745; color: white; }
        .badge-error { background: #dc3545; color: white; }
        .badge-warning { background: #ffc107; color: #212529; }
        
        .test-scenario {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .test-scenario h4 {
            margin-top: 0;
            color: #333;
        }
        .metrics-display {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéõÔ∏è Valida√ß√£o Funk Mandela - Fixed/Flex</h1>
        <p style="text-align: center; color: #666; font-size: 1.1em; margin-bottom: 30px;">
            <strong>Objetivo:</strong> Validar implementa√ß√£o de padr√µes fixos (obrigat√≥rios) vs flex√≠veis (est√©ticos)
        </p>
        
        <div class="controls">
            <button class="btn-primary" onclick="loadAndValidate()">üîÑ Carregar e Validar</button>
            <button class="btn-success" onclick="runConstraintTests()">üß™ Testar Constraints</button>
            <button class="btn-primary" onclick="showStructureDetails()">üìã Detalhes da Estrutura</button>
        </div>

        <div id="loadingStatus" class="section validation-section">
            <h3>üìÇ Status do Carregamento</h3>
            <div id="loadingInfo">Clique em "Carregar e Validar" para iniciar...</div>
        </div>

        <div id="fixedConstraints" class="section fixed-section">
            <h3>üî• Fixed Constraints (Hard - Obrigat√≥rios)</h3>
            <div class="constraint-grid" id="fixedGrid">
                <!-- Preenchido dinamicamente -->
            </div>
            <div id="fixedResults"></div>
        </div>

        <div id="flexConstraints" class="section flex-section">
            <h3>üé® Flex Constraints (Soft - Est√©ticos)</h3>
            <div class="constraint-grid" id="flexGrid">
                <!-- Preenchido dinamicamente -->
            </div>
            <div id="flexResults"></div>
        </div>

        <div id="testScenarios" class="section validation-section">
            <h3>üß™ Cen√°rios de Teste</h3>
            <div id="scenarioResults"></div>
        </div>

        <div id="finalReport" class="section validation-section">
            <h3>üìä Relat√≥rio Final</h3>
            <div id="reportContent"></div>
        </div>
    </div>

    <script src="validate-fixed-flex.js"></script>
    <script>
        let validationData = null;

        async function loadAndValidate() {
            const loadingDiv = document.getElementById('loadingInfo');
            loadingDiv.innerHTML = 'üîÑ Carregando dados...';

            try {
                const response = await fetch('/refs/out/funk_mandela.json?v=' + Date.now(), {
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                validationData = data;

                // Exibir info b√°sica
                const funk = data.funk_mandela;
                let html = `<div class="result success">
                    ‚úÖ <strong>Dados carregados com sucesso!</strong><br>
                    üìÖ Vers√£o: ${funk.version}<br>
                    üîÑ M√©todo: ${funk.aggregation_method}<br>
                    üìù Notas: ${funk.notes || 'N/A'}
                </div>`;

                // Verificar se tem estrutura fixed/flex
                if (funk.fixed && funk.flex) {
                    html += '<div class="result success">‚úÖ Estrutura fixed/flex presente</div>';
                    displayConstraintStructure(funk);
                } else {
                    html += '<div class="result error">‚ùå Estrutura fixed/flex ausente</div>';
                }

                // Verificar compatibilidade legada
                if (funk.legacy_compatibility) {
                    html += '<div class="result info">‚ÑπÔ∏è Compatibilidade legada mantida</div>';
                } else {
                    html += '<div class="result warning">‚ö†Ô∏è Compatibilidade legada ausente</div>';
                }

                loadingDiv.innerHTML = html;

            } catch (error) {
                loadingDiv.innerHTML = `<div class="result error">
                    ‚ùå <strong>Erro ao carregar:</strong> ${error.message}
                </div>`;
            }
        }

        function displayConstraintStructure(funk) {
            // Exibir Fixed Constraints
            const fixedGrid = document.getElementById('fixedGrid');
            const fixedConstraints = [
                {
                    name: 'LUFS Target',
                    data: funk.fixed.lufs?.integrated,
                    expected: { target: -8.0, tolerance: 1.0 }
                },
                {
                    name: 'True Peak',
                    data: funk.fixed.truePeak,
                    expected: { streamingMax: -0.3, baileMax: 0.0 }
                },
                {
                    name: 'Dynamic Range',
                    data: funk.fixed.dynamicRange?.dr,
                    expected: { target: 8.0, tolerance: 1.0 }
                },
                {
                    name: 'Low End Mono',
                    data: funk.fixed.lowEnd?.mono,
                    expected: { cutoffHz: 100 }
                },
                {
                    name: 'Vocal Presence',
                    data: funk.fixed.vocalPresence,
                    expected: { bandHz: [1000, 4000] }
                },
                {
                    name: 'RMS Policy',
                    data: funk.fixed.rms,
                    expected: { policy: 'deriveFromLUFS' }
                }
            ];

            fixedGrid.innerHTML = fixedConstraints.map(constraint => {
                const isValid = validateConstraint(constraint.data, constraint.expected);
                const statusClass = isValid ? 'badge-success' : 'badge-error';
                const statusText = isValid ? 'OK' : 'ERRO';

                return `<div class="constraint-card fixed">
                    <h4>${constraint.name} <span class="status-badge ${statusClass}">${statusText}</span></h4>
                    <div class="value">Atual: ${JSON.stringify(constraint.data || 'N/A')}</div>
                    <div class="value">Esperado: ${JSON.stringify(constraint.expected)}</div>
                </div>`;
            }).join('');

            // Exibir Flex Constraints
            const flexGrid = document.getElementById('flexGrid');
            const flexConstraints = [
                {
                    name: 'Clipping Limit',
                    data: funk.flex.clipping,
                    expected: { samplePctMax: 0.02 }
                },
                {
                    name: 'LRA Range',
                    data: funk.flex.lra,
                    expected: { min: 1.0, max: 4.0 }
                },
                {
                    name: 'Stereo Width',
                    data: funk.flex.stereo?.width,
                    expected: { midsHighsTolerance: 'wide' }
                },
                {
                    name: 'Tonal Curve Bands',
                    data: { count: funk.flex.tonalCurve?.bands?.length || 0 },
                    expected: { count: 8 }
                }
            ];

            flexGrid.innerHTML = flexConstraints.map(constraint => {
                const isValid = validateConstraint(constraint.data, constraint.expected);
                const statusClass = isValid ? 'badge-success' : 'badge-warning';
                const statusText = isValid ? 'OK' : 'ATEN√á√ÉO';

                return `<div class="constraint-card flex">
                    <h4>${constraint.name} <span class="status-badge ${statusClass}">${statusText}</span></h4>
                    <div class="value">Atual: ${JSON.stringify(constraint.data || 'N/A')}</div>
                    <div class="value">Esperado: ${JSON.stringify(constraint.expected)}</div>
                </div>`;
            }).join('');
        }

        function validateConstraint(actual, expected) {
            if (!actual || !expected) return false;
            
            for (const [key, value] of Object.entries(expected)) {
                if (actual[key] !== value) return false;
            }
            return true;
        }

        async function runConstraintTests() {
            if (!validationData) {
                alert('Carregue os dados primeiro!');
                return;
            }

            const scenarioDiv = document.getElementById('scenarioResults');
            scenarioDiv.innerHTML = '<div class="result info">üß™ Executando testes de cen√°rios...</div>';

            // Executar valida√ß√£o usando o script importado
            try {
                const validation = validateFixedFlexStructure(validationData);
                const testResults = testConstraintClassification(validationData);
                
                let html = '<h4>üéØ Resultados dos Testes de Cen√°rios:</h4>';
                
                testResults.forEach((result, index) => {
                    const statusClass = result.hardScore >= 75 ? 'success' : result.hardScore >= 50 ? 'warning' : 'error';
                    
                    html += `<div class="test-scenario">
                        <h4>Cen√°rio ${index + 1}: ${result.testCase}</h4>
                        <div class="result ${statusClass}">
                            üìä Score Hard: ${result.hardScore}% (${result.hardPassed}/${result.hardTotal} constraints)
                        </div>
                        <div class="metrics-display">Esperado: ${result.expected}</div>
                    </div>`;
                });

                // Adicionar resumo da valida√ß√£o
                html += '<h4>üìã Resumo da Valida√ß√£o:</h4>';
                html += `<div class="result ${validation.success ? 'success' : 'error'}">
                    ${validation.success ? '‚úÖ' : '‚ùå'} Status Geral: ${validation.success ? 'SUCESSO' : 'FALHA'}
                </div>`;

                if (validation.errors.length > 0) {
                    html += '<div class="result error">‚ùå Erros encontrados:<br>' + 
                           validation.errors.map(e => `‚Ä¢ ${e}`).join('<br>') + '</div>';
                }

                if (validation.warnings.length > 0) {
                    html += '<div class="result warning">‚ö†Ô∏è Warnings:<br>' + 
                           validation.warnings.map(w => `‚Ä¢ ${w}`).join('<br>') + '</div>';
                }

                scenarioDiv.innerHTML = html;

                // Gerar relat√≥rio final
                generateFinalReport(validation, testResults);

            } catch (error) {
                scenarioDiv.innerHTML = `<div class="result error">‚ùå Erro nos testes: ${error.message}</div>`;
            }
        }

        function generateFinalReport(validation, testResults) {
            const reportDiv = document.getElementById('reportContent');
            
            const successRate = testResults.filter(r => r.hardScore >= 75).length / testResults.length * 100;
            const overallStatus = validation.success && successRate >= 75;
            
            let html = `<div class="result ${overallStatus ? 'success' : 'error'}">
                <h4>${overallStatus ? 'üéâ' : '‚ö†Ô∏è'} Resultado Final: ${overallStatus ? 'APROVADO' : 'NECESSITA AJUSTES'}</h4>
                <p><strong>Taxa de Sucesso:</strong> ${Math.round(successRate)}% dos cen√°rios passaram</p>
                <p><strong>Fixed Constraints:</strong> ${validation.fixedFields.length} implementados</p>
                <p><strong>Flex Constraints:</strong> ${validation.flexFields.length} implementados</p>
                <p><strong>Erros:</strong> ${validation.errors.length}</p>
                <p><strong>Warnings:</strong> ${validation.warnings.length}</p>
            </div>`;

            html += '<h4>üìù Pr√≥ximos Passos:</h4>';
            if (overallStatus) {
                html += `<div class="result success">
                    ‚úÖ Estrutura fixed/flex implementada corretamente<br>
                    ‚úÖ Pronto para integra√ß√£o com engine de scoring<br>
                    ‚úÖ Valida√ß√£o com √°udio real pode prosseguir
                </div>`;
            } else {
                html += `<div class="result warning">
                    üîß Corrigir erros de valida√ß√£o encontrados<br>
                    üîß Verificar campos ausentes ou inv√°lidos<br>
                    üîß Re-testar ap√≥s corre√ß√µes
                </div>`;
            }

            reportDiv.innerHTML = html;
        }

        function showStructureDetails() {
            if (!validationData) {
                alert('Carregue os dados primeiro!');
                return;
            }

            const funk = validationData.funk_mandela;
            const details = {
                version: funk.version,
                fixed_structure: funk.fixed,
                flex_structure: funk.flex,
                legacy_compatibility: funk.legacy_compatibility ? 'Presente' : 'Ausente',
                pattern_rules: funk.legacy_compatibility?.pattern_rules
            };

            console.log('üìã DETALHES DA ESTRUTURA FUNK MANDELA:', details);
            
            alert('Detalhes foram enviados para o console do navegador (F12)');
        }

        // Auto-carregar ao abrir p√°gina
        window.addEventListener('load', () => {
            setTimeout(() => {
                loadAndValidate();
            }, 500);
        });
    </script>
</body>
</html>
