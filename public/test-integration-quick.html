<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste R√°pido - Integra√ß√£o Spectral V2</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        
        pre {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #28a745; }
        .status-fail { background: #dc3545; }
        .status-warn { background: #ffc107; }
        
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a9e;
        }
        
        .spectral-bands {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .band-card {
            background: #333;
            padding: 12px;
            border-radius: 4px;
            text-align: center;
        }
        
        .band-name {
            font-weight: bold;
            color: #007acc;
            margin-bottom: 5px;
        }
        
        .band-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .band-delta {
            font-size: 14px;
            margin-top: 5px;
        }
        
        .delta-good { color: #28a745; }
        .delta-warn { color: #ffc107; }
        .delta-bad { color: #dc3545; }
    </style>
</head>
<body>
    <h1>üß™ Teste R√°pido - Spectral V2 Integration</h1>
    
    <div class="test-section" id="system-check">
        <h2>üìã Verifica√ß√£o do Sistema</h2>
        <div id="system-status">Carregando...</div>
    </div>
    
    <div class="test-section" id="feature-flags">
        <h2>üö© Feature Flags</h2>
        <div id="flags-status">Carregando...</div>
    </div>
    
    <div class="test-section" id="spectral-test">
        <h2>üéµ Teste Spectral V2</h2>
        <button onclick="testSpectralAnalysis()">Testar An√°lise Espectral</button>
        <div id="spectral-results"></div>
    </div>
    
    <div class="test-section" id="mock-data">
        <h2>üéØ Simula√ß√£o com Dados Mock</h2>
        <button onclick="simulateWithMockData()">Simular An√°lise Completa</button>
        <div id="mock-results"></div>
    </div>

    <!-- Feature Flags -->
    <script>
        window.SPECTRAL_INTERNAL_MODE = "percent";
        window.ENABLE_SPECTRAL_V2 = true;
        window.SPECTRAL_DEBUG = true;
    </script>
    
    <!-- Load embedded refs -->
    <script src="refs/embedded-refs-new.js"></script>
    
    <!-- Load spectral V2 system -->
    <script src="spectral-balance-v2.js"></script>
    
    <script>
        // Fun√ß√£o para verificar o sistema
        function checkSystem() {
            const checks = [];
            
            // Verifica se SpectralIntegration existe
            if (window.SpectralIntegration) {
                checks.push({
                    name: "SpectralIntegration Module",
                    status: "ok",
                    details: "M√≥dulo carregado com sucesso"
                });
            } else {
                checks.push({
                    name: "SpectralIntegration Module",
                    status: "fail",
                    details: "M√≥dulo n√£o encontrado"
                });
            }
            
            // Verifica refs embedadas
            if (window.__EMBEDDED_REFS__ && window.__EMBEDDED_REFS__.byGenre) {
                const genreCount = Object.keys(window.__EMBEDDED_REFS__.byGenre).length;
                checks.push({
                    name: "Embedded References",
                    status: "ok",
                    details: `${genreCount} g√™neros carregados`
                });
            } else {
                checks.push({
                    name: "Embedded References",
                    status: "fail",
                    details: "Refer√™ncias n√£o encontradas"
                });
            }
            
            // Verifica feature flags
            checks.push({
                name: "SPECTRAL_INTERNAL_MODE",
                status: window.SPECTRAL_INTERNAL_MODE === "percent" ? "ok" : "warn",
                details: `Modo: ${window.SPECTRAL_INTERNAL_MODE || "undefined"}`
            });
            
            return checks;
        }
        
        // Fun√ß√£o para renderizar status
        function renderStatus(checks, containerId) {
            const container = document.getElementById(containerId);
            const html = checks.map(check => `
                <div style="margin: 8px 0;">
                    <span class="status-indicator status-${check.status}"></span>
                    <strong>${check.name}:</strong> ${check.details}
                </div>
            `).join('');
            container.innerHTML = html;
        }
        
        // Fun√ß√£o para testar an√°lise espectral
        function testSpectralAnalysis() {
            const container = document.getElementById('spectral-results');
            
            if (!window.SpectralIntegration) {
                container.innerHTML = '<div class="error">‚ùå SpectralIntegration n√£o dispon√≠vel</div>';
                return;
            }
            
            try {
                // Dados de teste simulados (simulando um FFT de um track funk)
                const mockSpectralData = {
                    sub: 0.15,        // 15% de energia sub
                    low_bass: 0.22,   // 22% de energia low bass  
                    upper_bass: 0.18, // 18% de energia upper bass
                    low_mid: 0.16,    // 16% de energia low mid
                    mid: 0.14,        // 14% de energia mid
                    high_mid: 0.10,   // 10% de energia high mid
                    brilho: 0.05      // 5% de energia brilho
                };
                
                const result = window.SpectralIntegration.analyzeSpectralBalance(mockSpectralData, 'funk_mandela');
                
                if (result && result.bands) {
                    let html = '<h3>‚úÖ An√°lise Executada com Sucesso</h3>';
                    html += '<div class="spectral-bands">';
                    
                    Object.entries(result.bands).forEach(([bandName, data]) => {
                        const deltaClass = Math.abs(data.delta) <= 3 ? 'delta-good' : 
                                         Math.abs(data.delta) <= 6 ? 'delta-warn' : 'delta-bad';
                        
                        html += `
                            <div class="band-card">
                                <div class="band-name">${bandName.replace('_', ' ').toUpperCase()}</div>
                                <div class="band-value">${data.current_db.toFixed(1)} dB</div>
                                <div class="band-delta ${deltaClass}">
                                    Œî ${data.delta > 0 ? '+' : ''}${data.delta.toFixed(1)} dB
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                    html += '<h4>üìä Dados Brutos:</h4>';
                    html += '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
                    
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="error">‚ùå Resultado inv√°lido da an√°lise</div>';
                }
                
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå Erro na an√°lise: ${error.message}</div>`;
                console.error('Erro no teste spectral:', error);
            }
        }
        
        // Fun√ß√£o para simular dados completos
        function simulateWithMockData() {
            const container = document.getElementById('mock-results');
            
            try {
                // Simula v√°rios cen√°rios
                const scenarios = [
                    {
                        name: "Track Funk Mandela - Ideal",
                        data: { sub: 0.12, low_bass: 0.20, upper_bass: 0.18, low_mid: 0.16, mid: 0.15, high_mid: 0.12, brilho: 0.07 }
                    },
                    {
                        name: "Track com Muito Bass",
                        data: { sub: 0.25, low_bass: 0.30, upper_bass: 0.20, low_mid: 0.12, mid: 0.08, high_mid: 0.03, brilho: 0.02 }
                    },
                    {
                        name: "Track Muito Brilhante",
                        data: { sub: 0.08, low_bass: 0.12, upper_bass: 0.14, low_mid: 0.16, mid: 0.18, high_mid: 0.20, brilho: 0.12 }
                    }
                ];
                
                let html = '<h3>üéØ Simula√ß√µes M√∫ltiplas</h3>';
                
                scenarios.forEach(scenario => {
                    const result = window.SpectralIntegration.analyzeSpectralBalance(scenario.data, 'funk_mandela');
                    
                    html += `<h4>${scenario.name}</h4>`;
                    html += '<div class="spectral-bands">';
                    
                    Object.entries(result.bands).forEach(([bandName, data]) => {
                        const deltaClass = Math.abs(data.delta) <= 3 ? 'delta-good' : 
                                         Math.abs(data.delta) <= 6 ? 'delta-warn' : 'delta-bad';
                        
                        html += `
                            <div class="band-card">
                                <div class="band-name">${bandName.replace('_', ' ').toUpperCase()}</div>
                                <div class="band-value">${data.current_db.toFixed(1)} dB</div>
                                <div class="band-delta ${deltaClass}">
                                    Œî ${data.delta > 0 ? '+' : ''}${data.delta.toFixed(1)} dB
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div><br>';
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå Erro na simula√ß√£o: ${error.message}</div>`;
                console.error('Erro na simula√ß√£o:', error);
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Verifica sistema
            const systemChecks = checkSystem();
            renderStatus(systemChecks, 'system-status');
            
            // Verifica feature flags
            const flagChecks = [
                {
                    name: "SPECTRAL_INTERNAL_MODE",
                    status: window.SPECTRAL_INTERNAL_MODE === "percent" ? "ok" : "warn",
                    details: window.SPECTRAL_INTERNAL_MODE || "undefined"
                },
                {
                    name: "ENABLE_SPECTRAL_V2",
                    status: window.ENABLE_SPECTRAL_V2 ? "ok" : "warn",
                    details: window.ENABLE_SPECTRAL_V2 ? "Habilitado" : "Desabilitado"
                },
                {
                    name: "SPECTRAL_DEBUG",
                    status: window.SPECTRAL_DEBUG ? "ok" : "warn",
                    details: window.SPECTRAL_DEBUG ? "Habilitado" : "Desabilitado"
                }
            ];
            renderStatus(flagChecks, 'flags-status');
            
            // Auto-executa teste se tudo estiver OK
            if (window.SpectralIntegration) {
                setTimeout(() => {
                    testSpectralAnalysis();
                }, 1000);
            }
        });
    </script>
</body>
</html>
