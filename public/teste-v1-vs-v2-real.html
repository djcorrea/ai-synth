<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Teste REAL V1 vs V2</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #000; 
            color: #00ff00; 
            padding: 20px; 
        }
        .button {
            background: #002200;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
            font-size: 16px;
            font-weight: bold;
        }
        .button:hover { background: #004400; }
        .result {
            background: rgba(0,255,0,0.1);
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .success { border-color: #00ff00; background: rgba(0,255,0,0.2); }
        .error { border-color: #ff0000; background: rgba(255,0,0,0.1); color: #ff6666; }
        .warning { border-color: #ffff00; background: rgba(255,255,0,0.1); color: #ffff88; }
        .header {
            border-color: #00ffff;
            background: rgba(0,255,255,0.1);
            color: #00ffff;
            font-weight: bold;
        }
        .comparison {
            border-color: #ff00ff;
            background: rgba(255,0,255,0.1);
            color: #ff88ff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîç TESTE REAL: V1 vs V2 SCORES</h1>
    
    <div class="button" onclick="testRealDifference()">üéØ Comparar V1 vs V2 Real</div>
    <div class="button" onclick="testWithActualData()">üìä Usar Dados da An√°lise Atual</div>
    <div class="button" onclick="testPerfectScore()">üíØ Testar Score Perfeito</div>
    <div class="button" onclick="clearResults()">üßπ Limpar</div>
    
    <div id="results"></div>

    <!-- Carregar sistemas -->
    <script src="scoring-v2-complete.js?v=20250823-balanceado"></script>
    <script src="auto-enable-v2.js?v=20250823-balanceado"></script>

    <script>
        function addResult(message, type = 'result') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Dados reais baseados na an√°lise que voc√™ mostrou
        const realAnalysisData = {
            lufsIntegrated: -6.66, // Din√¢mica da an√°lise real
            truePeakDbtp: -2.07,   // Pico Real da an√°lise real
            dynamicRange: 8.89,    // Din√¢mica alto/baixo da an√°lise real
            lra: 2.56,             // Varia√ß√£o de Volume
            stereoCorrelation: 0.11, // Correla√ß√£o Est√©reo
            dcOffset: 0.0002,
            clippingPercent: 0.174, // 0.174% da an√°lise real
            bandEnergies: {
                sub_bass: { rms_db: -19.23 },    // Agudos da an√°lise
                bass: { rms_db: -13.52 },        // M√©dios Agudos
                low_mid: { rms_db: -7.65 },      // M√©dios
                mid: { rms_db: -8.00 },          // M√©dios Graves
                high_mid: { rms_db: -9.32 },     // Graves Altos
                treble: { rms_db: -28.56 }       // Presen√ßa
            }
        };

        async function testRealDifference() {
            addResult('üîç TESTE REAL: V1 vs V2 com compara√ß√£o for√ßada', 'header');
            
            if (!window.ScoringV2Complete) {
                addResult('‚ùå Sistema V2 n√£o carregado', 'error');
                return;
            }

            const reference = { genre: 'funk_mandela' };

            try {
                // TESTE V1 - FOR√áAR V1
                addResult('üîß For√ßando V1...', 'result');
                window.SCORING_V2_DISABLED = true;
                window.SCORING_V2_TEST = false;
                
                const v1Result = await window.ScoringV2Complete.computeMixScore(realAnalysisData, reference);
                
                // TESTE V2 - FOR√áAR V2  
                addResult('üöÄ For√ßando V2...', 'result');
                window.SCORING_V2_DISABLED = false;
                window.SCORING_V2_TEST = true;
                
                const v2Result = await window.ScoringV2Complete.computeMixScore(realAnalysisData, reference);

                // COMPARA√á√ÉO
                const scoreDiff = v2Result.scorePct - v1Result.scorePct;
                const percentImprovement = v1Result.scorePct > 0 ? (scoreDiff / v1Result.scorePct * 100) : 0;

                addResult('üéØ RESULTADOS DA COMPARA√á√ÉO REAL:', 'comparison');
                addResult(`   V1: ${v1Result.scorePct}% (${v1Result.method})`, 'result');
                addResult(`   V2: ${v2Result.scorePct}% (${v2Result.method})`, 'result');
                addResult(`   Diferen√ßa: ${scoreDiff > 0 ? '+' : ''}${scoreDiff.toFixed(1)} pontos`, 'result');
                addResult(`   Melhoria: ${percentImprovement > 0 ? '+' : ''}${percentImprovement.toFixed(1)}%`, 'result');

                if (v2Result.method.includes('v2')) {
                    if (scoreDiff > 0) {
                        addResult('‚úÖ V2 EST√Å MELHORANDO O SCORE!', 'success');
                    } else if (scoreDiff === 0) {
                        addResult('‚ö†Ô∏è V2 funcionando mas score igual (pode ser normal)', 'warning');
                    } else {
                        addResult('‚ö†Ô∏è V2 funcionando mas score menor (investigar)', 'warning');
                    }
                } else {
                    addResult('‚ùå V2 N√ÉO est√° sendo usado!', 'error');
                }

                // Logs detalhados
                addResult('üîç Detalhes V1:', 'result');
                addResult(`   Tempo: ${v1Result.processingTime}ms`, 'result');
                addResult(`   Vers√£o: ${v1Result.scoringVersion || 'v1'}`, 'result');
                
                addResult('üîç Detalhes V2:', 'result');
                addResult(`   Tempo: ${v2Result.processingTime}ms`, 'result');
                addResult(`   Vers√£o: ${v2Result.scoringVersion || 'v2'}`, 'result');

            } catch (error) {
                addResult(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
        }

        async function testWithActualData() {
            addResult('üìä TESTE COM DADOS DA SUA AN√ÅLISE ATUAL', 'header');
            
            // Tentar descobrir por que o score deu 54
            if (!window.ScoringV2Complete) {
                addResult('‚ùå Sistema V2 n√£o carregado', 'error');
                return;
            }

            const reference = { genre: 'funk_mandela' };

            try {
                // Resetar flags
                window.SCORING_V2_DISABLED = undefined;
                window.SCORING_V2_TEST = undefined;

                // Teste com dados reais
                const result = await window.ScoringV2Complete.computeMixScore(realAnalysisData, reference);

                addResult('üéØ RESULTADO COM DADOS REAIS:', 'header');
                addResult(`   Score: ${result.scorePct}%`, 'result');
                addResult(`   M√©todo: ${result.method}`, 'result');
                addResult(`   Classifica√ß√£o: ${result.classification}`, 'result');
                addResult(`   Vers√£o: ${result.scoringVersion || 'n√£o informado'}`, 'result');

                // Verificar se bate com o que apareceu na interface (54)
                if (Math.abs(result.scorePct - 54) < 1) {
                    addResult('‚úÖ Score bate com a interface (54)', 'success');
                } else {
                    addResult(`‚ö†Ô∏è Score diferente da interface (esperado ~54, got ${result.scorePct})`, 'warning');
                }

                // Verificar qual vers√£o est√° sendo usada
                if (result.method && result.method.includes('v2')) {
                    addResult('‚úÖ V2 est√° sendo usado na an√°lise atual', 'success');
                } else {
                    addResult('‚ùå V1 est√° sendo usado (V2 n√£o ativo)', 'error');
                }

                // An√°lise dos dados
                addResult('üîç AN√ÅLISE DOS DADOS:', 'header');
                addResult(`   Clipping: ${realAnalysisData.clippingPercent}% (${realAnalysisData.clippingPercent > 0.1 ? 'Alto' : 'OK'})`, 'result');
                addResult(`   Din√¢mica: ${realAnalysisData.dynamicRange} (${realAnalysisData.dynamicRange < 6 ? 'Baixa' : 'OK'})`, 'result');
                addResult(`   LUFS: ${realAnalysisData.lufsIntegrated} (${realAnalysisData.lufsIntegrated > -14 ? 'Alto' : 'OK'})`, 'result');

            } catch (error) {
                addResult(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
        }

        async function testPerfectScore() {
            addResult('üíØ TESTE DE SCORE PERFEITO (100%)', 'header');
            
            if (!window.ScoringV2Complete) {
                addResult('‚ùå Sistema V2 n√£o carregado', 'error');
                return;
            }

            // Dados PERFEITOS baseados nos targets do funk_mandela
            const perfectData = {
                lufsIntegrated: -10.0,   // Exato do target
                truePeakDbtp: -0.8,      // Exato do target
                dynamicRange: 7.0,       // Exato do target
                lra: 3.5,                // Exato do target
                stereoCorrelation: 0.65, // Exato do target
                dcOffset: 0.0001,        // Perfeito
                clippingPercent: 0,      // Zero clipping
                bandEnergies: {
                    sub_bass: { rms_db: -9.0 },
                    bass: { rms_db: -7.5 },
                    low_mid: { rms_db: -8.5 },
                    mid: { rms_db: -9.5 },
                    high_mid: { rms_db: -11.5 },
                    treble: { rms_db: -14.0 }
                }
            };

            const reference = { genre: 'funk_mandela' };

            try {
                const result = await window.ScoringV2Complete.computeMixScore(perfectData, reference);

                addResult('üéØ RESULTADO SCORE PERFEITO:', 'comparison');
                addResult(`   Score: ${result.scorePct}%`, result.scorePct >= 98 ? 'success' : 'warning');
                addResult(`   M√©todo: ${result.method}`, 'result');
                addResult(`   Classifica√ß√£o: ${result.classification}`, 'result');

                if (result.scorePct >= 98) {
                    addResult('‚úÖ PERFEITO! Score 100% √© alcan√ß√°vel!', 'success');
                } else if (result.scorePct >= 90) {
                    addResult('‚ö†Ô∏è Quase perfeito - toler√¢ncias OK', 'warning');
                } else {
                    addResult('‚ùå Score muito baixo - toler√¢ncias muito rigorosas', 'error');
                }

                // Teste com dados 95% perfeitos
                addResult('üìä Testando dados 95% perfeitos...', 'result');
                const almostPerfectData = {
                    ...perfectData,
                    lufsIntegrated: -11.5,   // +1.5 LUFS de diferen√ßa
                    dynamicRange: 6.0,       // -1.0 dB diferen√ßa
                    truePeakDbtp: -0.3       // +0.5 dB diferen√ßa
                };

                const result95 = await window.ScoringV2Complete.computeMixScore(almostPerfectData, reference);
                addResult(`   Score 95%: ${result95.scorePct}%`, 'result');

            } catch (error) {
                addResult(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
        }

        // Verificar carregamento
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (window.ScoringV2Complete) {
                    addResult('‚úÖ Sistema V2 carregado - pronto para testar', 'success');
                    
                    // Verificar status atual
                    const status = window.ScoringV2Complete.getStatus();
                    addResult(`üìä Status atual: ${status.currentMode}`, 'result');
                } else {
                    addResult('‚ùå Sistema V2 n√£o carregado', 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>
