<!DOCTYPE html>
<html>
<head>
    <title>üîç MONITOR VERCEL - Status P√≥s-Corre√ß√£o</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .monitor { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #2a2a2a; }
        .success { border-color: #28a745; background: #1e4620; }
        .error { border-color: #dc3545; background: #4d1f1f; }
        .warning { border-color: #ffc107; background: #4d4020; }
        .test { margin: 10px 0; padding: 10px; background: #333; }
        .log { font-size: 12px; color: #ccc; margin: 5px 0; }
        button { padding: 10px 20px; margin: 10px 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .metric { padding: 15px; background: #333; border-radius: 8px; }
        .metric-value { font-size: 24px; font-weight: bold; color: #17a2b8; }
        .metric-label { font-size: 12px; color: #ccc; }
        h2 { color: #ffc107; }
        h3 { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>üîç MONITOR VERCEL - Status P√≥s-Corre√ß√£o</h1>
    <p>Sistema de monitoramento em tempo real das corre√ß√µes aplicadas</p>
    
    <button onclick="executarMonitoramento()">üöÄ INICIAR MONITORAMENTO</button>
    <button onclick="testarSistemaCompleto()">üéµ TESTE SISTEMA COMPLETO</button>
    <button onclick="limparResultados()">üßπ LIMPAR</button>
    
    <div class="metrics" id="metricas">
        <div class="metric">
            <div class="metric-value" id="sucessos">0</div>
            <div class="metric-label">Recursos OK</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="falhas">0</div>
            <div class="metric-label">404 Errors</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="fallbacks">0</div>
            <div class="metric-label">Fallbacks Usados</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="tempo">0ms</div>
            <div class="metric-label">Tempo Total</div>
        </div>
    </div>
    
    <div id="resultados"></div>

    <script>
        const resultados = document.getElementById('resultados');
        let metricas = { sucessos: 0, falhas: 0, fallbacks: 0, tempo: 0 };
        
        function log(msg, tipo = 'info') {
            console.log(`[MONITOR] ${msg}`);
            const div = document.createElement('div');
            div.className = `log ${tipo}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            return div;
        }
        
        function criarSecao(titulo, tipo = 'info') {
            const section = document.createElement('div');
            section.className = `monitor ${tipo}`;
            section.innerHTML = `<h3>${titulo}</h3>`;
            return section;
        }
        
        function atualizarMetricas() {
            document.getElementById('sucessos').textContent = metricas.sucessos;
            document.getElementById('falhas').textContent = metricas.falhas;
            document.getElementById('fallbacks').textContent = metricas.fallbacks;
            document.getElementById('tempo').textContent = metricas.tempo + 'ms';
        }
        
        async function testarRecurso(paths, nome) {
            const inicio = Date.now();
            
            for (let i = 0; i < paths.length; i++) {
                const path = paths[i];
                try {
                    const response = await fetch(path, { 
                        cache: 'no-store',
                        headers: { 'Cache-Control': 'no-cache' }
                    });
                    
                    if (response.ok) {
                        const tempo = Date.now() - inicio;
                        console.log(`‚úÖ ${nome}: ${path} (${tempo}ms)`);
                        
                        if (i > 0) metricas.fallbacks++;
                        metricas.sucessos++;
                        metricas.tempo += tempo;
                        
                        return { 
                            sucesso: true, 
                            path: path, 
                            tentativa: i + 1,
                            tempo: tempo,
                            status: response.status 
                        };
                    }
                } catch (error) {
                    console.log(`‚ùå ${nome}: ${path} - ${error.message}`);
                }
            }
            
            metricas.falhas++;
            return { sucesso: false, paths: paths };
        }
        
        async function monitorarRecursosEssenciais() {
            const secao = criarSecao('üîó RECURSOS ESSENCIAIS', 'warning');
            resultados.appendChild(secao);
            
            const testes = [
                {
                    nome: 'Embedded Refs New',
                    paths: [
                        '/refs/embedded-refs-new.js',
                        'refs/embedded-refs-new.js',
                        './refs/embedded-refs-new.js'
                    ]
                },
                {
                    nome: 'Funk Mandela JSON',
                    paths: [
                        '/refs/out/funk_mandela.json',
                        'refs/out/funk_mandela.json',
                        './refs/out/funk_mandela.json'
                    ]
                },
                {
                    nome: 'Trance JSON',
                    paths: [
                        '/refs/out/trance.json',
                        'refs/out/trance.json',
                        './refs/out/trance.json'
                    ]
                },
                {
                    nome: 'Genres JSON',
                    paths: [
                        '/refs/out/genres.json',
                        'refs/out/genres.json',
                        './refs/out/genres.json'
                    ]
                }
            ];
            
            for (const teste of testes) {
                const resultado = await testarRecurso(teste.paths, teste.nome);
                const div = document.createElement('div');
                div.className = `test ${resultado.sucesso ? 'success' : 'error'}`;
                
                if (resultado.sucesso) {
                    div.innerHTML = `
                        <strong>‚úÖ ${teste.nome}</strong><br>
                        Path: ${resultado.path}<br>
                        Tentativa: ${resultado.tentativa}/${teste.paths.length}<br>
                        Tempo: ${resultado.tempo}ms<br>
                        Status: ${resultado.status}
                    `;
                } else {
                    div.innerHTML = `
                        <strong>‚ùå ${teste.nome}</strong><br>
                        Todos os paths falharam:<br>
                        ${resultado.paths.join('<br>')}
                    `;
                }
                
                secao.appendChild(div);
                atualizarMetricas();
            }
        }
        
        async function testarSistemaAudioAnalyzer() {
            const secao = criarSecao('üéµ SISTEMA AUDIO ANALYZER', 'info');
            resultados.appendChild(secao);
            
            // Verificar se as fun√ß√µes essenciais existem
            const funcoes = [
                'window.AudioAnalyzer',
                'window.fetchRefJsonWithFallback',
                'window.__EMBEDDED_REFS__'
            ];
            
            funcoes.forEach(funcao => {
                const existe = eval(`typeof ${funcao}`) !== 'undefined';
                const div = document.createElement('div');
                div.className = `test ${existe ? 'success' : 'error'}`;
                div.innerHTML = `<strong>${funcao}:</strong> ${existe ? 'DISPON√çVEL' : 'N√ÉO ENCONTRADO'}`;
                secao.appendChild(div);
            });
        }
        
        async function executarMonitoramento() {
            limparResultados();
            metricas = { sucessos: 0, falhas: 0, fallbacks: 0, tempo: 0 };
            
            const inicio = criarSecao('üöÄ INICIANDO MONITORAMENTO VERCEL', 'warning');
            resultados.appendChild(inicio);
            
            try {
                await monitorarRecursosEssenciais();
                await testarSistemaAudioAnalyzer();
                
                const fim = criarSecao('‚úÖ MONITORAMENTO CONCLU√çDO', 'success');
                fim.innerHTML += `<p>üìä Recursos OK: ${metricas.sucessos} | Falhas: ${metricas.falhas} | Fallbacks: ${metricas.fallbacks}</p>`;
                resultados.appendChild(fim);
                
            } catch (error) {
                const erro = criarSecao(`üí• ERRO NO MONITORAMENTO: ${error.message}`, 'error');
                resultados.appendChild(erro);
            }
        }
        
        async function testarSistemaCompleto() {
            const secao = criarSecao('üéµ TESTE SISTEMA COMPLETO', 'warning');
            resultados.appendChild(secao);
            
            // Simular abertura do modal de an√°lise
            try {
                if (typeof window.openAudioModal === 'function') {
                    secao.innerHTML += '<p>‚úÖ Modal de √°udio dispon√≠vel</p>';
                } else {
                    secao.innerHTML += '<p>‚ùå Modal de √°udio n√£o dispon√≠vel</p>';
                }
                
                // Verificar carregamento de g√™neros
                if (window.__EMBEDDED_REFS__ && window.__EMBEDDED_REFS__.manifest) {
                    secao.innerHTML += '<p>‚úÖ Manifesto de g√™neros carregado</p>';
                } else {
                    secao.innerHTML += '<p>‚ö†Ô∏è Usando fallback de g√™neros</p>';
                }
                
            } catch (error) {
                secao.innerHTML += `<p>‚ùå Erro no teste: ${error.message}</p>`;
            }
        }
        
        function limparResultados() {
            resultados.innerHTML = '';
            metricas = { sucessos: 0, falhas: 0, fallbacks: 0, tempo: 0 };
            atualizarMetricas();
        }
        
        // Auto-executar ao carregar
        window.addEventListener('load', () => {
            console.log('üîç MONITOR VERCEL CARREGADO');
            atualizarMetricas();
        });
    </script>
</body>
</html>
