<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Sugestões Corrigidas</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .suggestion {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .suggestion.fixed {
            border-left-color: #4CAF50;
        }
        .suggestion.broken {
            border-left-color: #f44336;
        }
        .metric {
            font-family: monospace;
            background: #444;
            padding: 5px;
            border-radius: 3px;
            margin: 5px 0;
        }
        #results {
            white-space: pre-wrap;
            font-family: monospace;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Teste de Sugestões Corrigidas</h1>
        <p>Verificando se as correções nas sugestões estão funcionando corretamente</p>
        
        <button class="test-button" onclick="testTruePeakSuggestions()">🎯 Testar True Peak</button>
        <button class="test-button" onclick="testAllSuggestions()">📊 Testar Todas as Métricas</button>
        <button class="test-button" onclick="clearResults()">🧹 Limpar</button>
        
        <div id="results"></div>
    </div>

    <!-- Scripts necessários -->
    <script src="refs/embedded-refs-new.js"></script>
    <script src="suggestion-scorer.js"></script>
    <script src="enhanced-suggestion-engine.js"></script>
    <script src="audio-analyzer-integration.js"></script>

    <script>
        const log = (msg) => {
            const results = document.getElementById('results');
            results.textContent += msg + '\n';
        };

        const clearResults = () => {
            document.getElementById('results').textContent = '';
        };

        // Simular dados do áudio analisado nas imagens
        const mockAnalysis = {
            technicalData: {
                lufsIntegrated: -6.10,
                truePeakDbtp: -1.26,    // Problema: mais baixo que target -0.8
                dynamicRange: 11.38,    // Problema: mais alto que target 7.0
                lra: 4.91,
                stereoCorrelation: 0.16,
                clippingPercent: 7.223,
                
                bandEnergies: {
                    sub_bass: { rms_db: -10.50 },
                    bass: { rms_db: -11.50 },
                    low_mid: { rms_db: -8.07 },
                    mid: { rms_db: -6.61 },
                    high_mid: { rms_db: -10.67 },
                    treble: { rms_db: -15.76 }
                }
            },
            suggestions: []
        };

        const mockRefData = {
            lufs_target: -10.0,
            tol_lufs: 3.0,
            true_peak_target: -0.8,
            tol_true_peak: 1.0,
            dr_target: 7.0,
            tol_dr: 2.0,
            lra_target: 3.5,
            tol_lra: 1.0,
            stereo_target: 0.65,
            tol_stereo: 0.2
        };

        window.PROD_AI_REF_GENRE = 'funk_mandela';
        window.__activeRefData = mockRefData;

        const testTruePeakSuggestions = () => {
            clearResults();
            log('🎯 TESTE DE SUGESTÕES TRUE PEAK');
            log('================================\n');
            
            log('📊 Dados do Teste:');
            log(`True Peak Atual: ${mockAnalysis.technicalData.truePeakDbtp} dBTP`);
            log(`True Peak Target: ${mockRefData.true_peak_target} dBTP`);
            log(`Diferença: ${(mockAnalysis.technicalData.truePeakDbtp - mockRefData.true_peak_target).toFixed(2)} dBTP`);
            log(`Status: Valor ABAIXO do target (limitação excessiva)\n`);
            
            // Teste com sistema legado (corrigido)
            log('🔧 Testando Sistema Legado (Corrigido):');
            try {
                if (typeof updateReferenceSuggestions === 'function') {
                    const testAnalysis = JSON.parse(JSON.stringify(mockAnalysis));
                    updateReferenceSuggestions(testAnalysis);
                    
                    const truePeakSuggestion = testAnalysis.suggestions.find(s => s.type === 'reference_true_peak');
                    if (truePeakSuggestion) {
                        log(`✅ Sugestão Gerada:`);
                        log(`   Mensagem: "${truePeakSuggestion.message}"`);
                        log(`   Ação: "${truePeakSuggestion.action}"`);
                        log(`   Detalhes: "${truePeakSuggestion.details}"\n`);
                    } else {
                        log('❌ Nenhuma sugestão de True Peak gerada\n');
                    }
                } else {
                    log('❌ Função updateReferenceSuggestions não disponível\n');
                }
            } catch (error) {
                log(`❌ Erro no sistema legado: ${error.message}\n`);
            }
            
            // Teste com Enhanced Suggestion Engine
            log('🎯 Testando Enhanced Suggestion Engine:');
            try {
                if (typeof EnhancedSuggestionEngine !== 'undefined' && typeof SuggestionScorer !== 'undefined') {
                    const engine = new EnhancedSuggestionEngine();
                    const result = engine.processAnalysis(mockAnalysis, mockRefData);
                    
                    const truePeakSuggestion = result.suggestions.find(s => s.type === 'reference_true_peak');
                    if (truePeakSuggestion) {
                        log(`✅ Sugestão Enhanced:`);
                        log(`   Mensagem: "${truePeakSuggestion.message}"`);
                        log(`   Ação: "${truePeakSuggestion.action}"`);
                        log(`   Por quê: "${truePeakSuggestion.why}"`);
                        log(`   Prioridade: ${truePeakSuggestion.priority}`);
                        log(`   Severidade: ${truePeakSuggestion.severity.level} (${truePeakSuggestion.severity.label})\n`);
                    } else {
                        log('❌ Nenhuma sugestão Enhanced de True Peak gerada\n');
                    }
                } else {
                    log('❌ Enhanced Suggestion Engine não disponível\n');
                }
            } catch (error) {
                log(`❌ Erro no Enhanced Engine: ${error.message}\n`);
            }
            
            log('📋 Avaliação:');
            log('A sugestão correta deveria ser:');
            log('  "Reduzir limitação para -0.8 dBTP"');
            log('  Ou similar indicando MENOS limitação/compressão');
        };

        const testAllSuggestions = () => {
            clearResults();
            log('📊 TESTE COMPLETO DE SUGESTÕES');
            log('==============================\n');
            
            const problems = [
                {
                    metric: 'LUFS',
                    value: mockAnalysis.technicalData.lufsIntegrated,
                    target: mockRefData.lufs_target,
                    expected: 'DIMINUIR 3.9 LUFS'
                },
                {
                    metric: 'True Peak',
                    value: mockAnalysis.technicalData.truePeakDbtp,
                    target: mockRefData.true_peak_target,
                    expected: 'Reduzir limitação para -0.8 dBTP'
                },
                {
                    metric: 'Dynamic Range',
                    value: mockAnalysis.technicalData.dynamicRange,
                    target: mockRefData.dr_target,
                    expected: 'DIMINUIR 4.4 dB (mais compressão)'
                },
                {
                    metric: 'Correlação Estéreo',
                    value: mockAnalysis.technicalData.stereoCorrelation,
                    target: mockRefData.stereo_target,
                    expected: 'AUMENTAR 0.49 (mais estéreo)'
                }
            ];
            
            log('🔍 Problemas Identificados:');
            problems.forEach(problem => {
                const diff = (problem.value - problem.target).toFixed(2);
                log(`${problem.metric}: ${problem.value} → ${problem.target} (Δ${diff})`);
                log(`  Esperado: ${problem.expected}\n`);
            });
            
            // Testar com sistema disponível
            if (typeof updateReferenceSuggestions === 'function') {
                log('🔧 Sugestões do Sistema:');
                const testAnalysis = JSON.parse(JSON.stringify(mockAnalysis));
                updateReferenceSuggestions(testAnalysis);
                
                testAnalysis.suggestions.forEach((sug, index) => {
                    log(`${index + 1}. Tipo: ${sug.type}`);
                    log(`   Mensagem: "${sug.message}"`);
                    log(`   Ação: "${sug.action}"`);
                    log('');
                });
                
                log(`\n✅ Total de sugestões geradas: ${testAnalysis.suggestions.length}`);
            }
        };

        // Auto-executar teste básico ao carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('🚀 Sistema carregado. Execute os testes usando os botões acima.\n');
                log('🎯 Verificação Rápida:');
                log('Enhanced Suggestion Engine: ' + (typeof EnhancedSuggestionEngine !== 'undefined' ? '✅' : '❌'));
                log('Suggestion Scorer: ' + (typeof SuggestionScorer !== 'undefined' ? '✅' : '❌'));
                log('Update Reference Suggestions: ' + (typeof updateReferenceSuggestions === 'function' ? '✅' : '❌'));
                log('Embedded Refs: ' + (typeof window.__EMBEDDED_REFS__ === 'object' ? '✅' : '❌'));
                log('');
            }, 1000);
        });
    </script>
</body>
</html>
