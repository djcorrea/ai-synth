<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Sistema de Upload de Imagens</title>
    <style>
        body {
            background: #0a0e1a;
            color: white;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .test-button {
            background: #0096ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0078cc;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success { background: rgba(0, 255, 0, 0.1); border: 1px solid rgba(0, 255, 0, 0.3); }
        .status.error { background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); }
        .status.info { background: rgba(0, 150, 255, 0.1); border: 1px solid rgba(0, 150, 255, 0.3); }
        input[type="file"] {
            margin: 10px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: white;
        }
    </style>
    <link rel="stylesheet" href="image-upload-styles.css">
</head>
<body>
    <div class="test-container">
        <h1>üñºÔ∏è Debug - Sistema de Upload de Imagens</h1>
        
        <div class="status info">
            <strong>Status do Sistema:</strong> <span id="systemStatus">Verificando...</span>
        </div>

        <h3>üß™ Testes Manuais</h3>
        
        <button class="test-button" onclick="testImageSystem()">Testar Sistema</button>
        <button class="test-button" onclick="simulateFileSelection()">Simular Sele√ß√£o de Arquivo</button>
        <button class="test-button" onclick="testEventListener()">Testar Event Listener</button>
        <button class="test-button" onclick="clearLog()">Limpar Log</button>
        
        <h3>üìÅ Upload Real</h3>
        <input type="file" id="realFileInput" accept="image/*" multiple onchange="testRealFileUpload(this.files)">
        
        <h3>üìä Estado Atual</h3>
        <div id="currentState" class="status info">
            <p><strong>Imagens selecionadas:</strong> <span id="imageCount">0</span></p>
            <p><strong>Sistema inicializado:</strong> <span id="systemInit">‚ùå</span></p>
            <p><strong>Container de preview:</strong> <span id="previewContainer">‚ùå</span></p>
            <p><strong>Event listeners:</strong> <span id="eventListeners">‚ùå</span></p>
        </div>

        <h3>üìù Log do Sistema</h3>
        <div id="debugLog" class="log"></div>
    </div>

    <script src="image-upload-system.js"></script>
    <script>
        let logElement;
        
        function log(message, type = 'info') {
            if (!logElement) logElement = document.getElementById('debugLog');
            
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#ffffff';
            entry.innerHTML = `[${timestamp}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[DEBUG] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        function updateStatus() {
            // Verificar se o sistema existe
            const systemExists = window.imagePreviewSystem ? '‚úÖ' : '‚ùå';
            document.getElementById('systemInit').textContent = systemExists;
            
            // Verificar container de preview
            const hasContainer = document.getElementById('image-preview-container') ? '‚úÖ' : '‚ùå';
            document.getElementById('previewContainer').textContent = hasContainer;
            
            // Verificar quantas imagens est√£o selecionadas
            const imageCount = window.imagePreviewSystem ? window.imagePreviewSystem.selectedImages.length : 0;
            document.getElementById('imageCount').textContent = imageCount;
            
            // Status geral
            const systemStatus = window.imagePreviewSystem && window.imagePreviewSystem.isInitialized ? 
                'Sistema funcionando ‚úÖ' : 'Sistema n√£o inicializado ‚ùå';
            document.getElementById('systemStatus').textContent = systemStatus;
        }

        function testImageSystem() {
            log('üß™ Iniciando teste do sistema de imagens...');
            
            if (!window.imagePreviewSystem) {
                log('‚ùå window.imagePreviewSystem n√£o encontrado!', 'error');
                return;
            }
            
            log('‚úÖ window.imagePreviewSystem encontrado', 'success');
            log(`Inicializado: ${window.imagePreviewSystem.isInitialized}`);
            log(`Imagens selecionadas: ${window.imagePreviewSystem.selectedImages.length}`);
            log(`M√°ximo de imagens: ${window.imagePreviewSystem.maxImages}`);
            
            // Testar m√©todo init
            try {
                window.imagePreviewSystem.init();
                log('‚úÖ M√©todo init() executado com sucesso', 'success');
            } catch (error) {
                log(`‚ùå Erro ao executar init(): ${error.message}`, 'error');
            }
            
            updateStatus();
        }

        function simulateFileSelection() {
            log('üé≠ Simulando sele√ß√£o de arquivo...');
            
            // Criar um arquivo fake para teste
            const fakeFile = new File(['fake content'], 'test-image.jpg', {
                type: 'image/jpeg',
                lastModified: Date.now()
            });
            
            // Disparar evento personalizado
            try {
                const event = new CustomEvent('chat:add-photos', {
                    detail: [fakeFile]
                });
                window.dispatchEvent(event);
                log('‚úÖ Evento chat:add-photos disparado', 'success');
            } catch (error) {
                log(`‚ùå Erro ao disparar evento: ${error.message}`, 'error');
            }
            
            updateStatus();
        }

        function testEventListener() {
            log('üéß Testando event listeners...');
            
            // Verificar se o event listener est√° configurado
            const listeners = getEventListeners ? getEventListeners(window) : 'N√£o dispon√≠vel';
            log(`Event listeners: ${JSON.stringify(listeners, null, 2)}`);
            
            // Testar evento diretamente
            try {
                if (window.imagePreviewSystem && window.imagePreviewSystem.handleFileSelection) {
                    const fakeFile = new File(['test'], 'test.jpg', { type: 'image/jpeg' });
                    window.imagePreviewSystem.handleFileSelection([fakeFile]);
                    log('‚úÖ handleFileSelection chamado diretamente', 'success');
                } else {
                    log('‚ùå handleFileSelection n√£o encontrado', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro no teste direto: ${error.message}`, 'error');
            }
            
            updateStatus();
        }

        function testRealFileUpload(files) {
            log(`üìÅ Upload real iniciado: ${files.length} arquivo(s)`);
            
            if (files.length === 0) {
                log('‚ùå Nenhum arquivo selecionado', 'error');
                return;
            }
            
            Array.from(files).forEach((file, index) => {
                log(`Arquivo ${index + 1}: ${file.name} (${file.type}, ${(file.size/1024/1024).toFixed(2)}MB)`);
            });
            
            try {
                // Disparar evento para o sistema de imagens
                const event = new CustomEvent('chat:add-photos', {
                    detail: files
                });
                window.dispatchEvent(event);
                log('‚úÖ Evento disparado para sistema de imagens', 'success');
            } catch (error) {
                log(`‚ùå Erro ao processar upload: ${error.message}`, 'error');
            }
            
            updateStatus();
        }

        // Interceptar logs do console para o debug
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (args[0] && args[0].includes && (args[0].includes('üñºÔ∏è') || args[0].includes('‚úÖ') || args[0].includes('‚ùå'))) {
                log(args.join(' '));
            }
        };

        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            log(args.join(' '), 'error');
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Debug page carregada');
            setTimeout(() => {
                testImageSystem();
                updateStatus();
            }, 1000);
        });

        // Atualizar status periodicamente
        setInterval(updateStatus, 2000);
    </script>
</body>
</html>
