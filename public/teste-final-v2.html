<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final Scoring V2</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #000; 
            color: #00ff00; 
            padding: 20px; 
            margin: 0;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .section {
            border: 2px solid #00ff00;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0,255,0,0.05);
        }
        .button {
            background: #002200;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
        }
        .button:hover { 
            background: #004400; 
            box-shadow: 0 0 15px rgba(0,255,0,0.5);
        }
        .result {
            background: rgba(0,255,0,0.1);
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .success { border-color: #00ff00; background: rgba(0,255,0,0.2); }
        .error { border-color: #ff0000; background: rgba(255,0,0,0.1); color: #ff6666; }
        .warning { border-color: #ffff00; background: rgba(255,255,0,0.1); color: #ffff88; }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <h1>üß™ TESTE FINAL DO SCORING V2</h1>
            <p>Valida√ß√£o completa do sistema de scoring melhorado</p>
            
            <div class="button" onclick="runCompleteTest()">üöÄ EXECUTAR TESTE COMPLETO</div>
            <div class="button" onclick="loadSystemManually()">üì¶ CARREGAR SISTEMA MANUALMENTE</div>
            <div class="button" onclick="testWithRealData()">üéµ TESTE COM DADOS REAIS</div>
        </div>

        <div class="section">
            <h2>üìä RESULTADOS DOS TESTES</h2>
            <div id="results"></div>
        </div>

        <div class="section">
            <h2>üéõÔ∏è CONTROLES</h2>
            <div class="button" onclick="enableV2()">üß™ Habilitar V2</div>
            <div class="button" onclick="disableV2()">üõ°Ô∏è Desabilitar V2</div>
            <div class="button" onclick="clearResults()">üßπ Limpar</div>
        </div>
    </div>

    <!-- Auto carregador -->
    <script src="auto-scoring-loader.js?v=20250823"></script>

    <script>
        function addResult(message, type = 'result') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }

        async function loadSystemManually() {
            addResult('üöÄ Iniciando carregamento manual do sistema...', 'result');
            
            try {
                // Verificar se auto-carregador est√° presente
                if (typeof window.ensureScoring === 'function') {
                    addResult('‚úÖ Auto-carregador detectado', 'success');
                    
                    const loaded = await window.ensureScoring();
                    if (loaded) {
                        addResult('‚úÖ Sistema carregado com sucesso via auto-carregador!', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Auto-carregador falhou, sistema em modo fallback', 'warning');
                    }
                } else {
                    addResult('‚ùå Auto-carregador n√£o encontrado', 'error');
                }
                
                // Verificar status do sistema
                const status = {
                    ScoringV1: !!window.ScoringV1,
                    ScoringV2: !!window.ScoringV2,
                    ScoringIntegration: !!window.ScoringIntegration,
                    computeMixScore: !!window.computeMixScore,
                    ScoringLoader: !!window.ScoringLoader
                };
                
                addResult(`üìä Status do sistema: ${JSON.stringify(status, null, 2)}`, 'result');
                
                if (status.ScoringIntegration) {
                    addResult('üéâ Sistema de integra√ß√£o V2 dispon√≠vel!', 'success');
                } else if (status.ScoringV1) {
                    addResult('‚ö†Ô∏è Apenas V1 dispon√≠vel (modo fallback)', 'warning');
                } else {
                    addResult('‚ùå Nenhum sistema de scoring dispon√≠vel', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Erro no carregamento: ${error.message}`, 'error');
            }
        }

        async function runCompleteTest() {
            addResult('üß™ INICIANDO TESTE COMPLETO...', 'result');
            
            try {
                // 1. Carregar sistema
                await loadSystemManually();
                
                // 2. Verificar disponibilidade
                if (!window.ScoringIntegration) {
                    addResult('‚ùå ScoringIntegration n√£o dispon√≠vel para teste', 'error');
                    return;
                }
                
                // 3. Dados de teste t√≠picos de funk mandela
                const testData = {
                    lufsIntegrated: -12.5,
                    truePeakDbtp: -0.8,
                    dynamicRange: 6.2,
                    lra: 4.5,
                    stereoCorrelation: 0.75,
                    dcOffset: 0.0001,
                    clippingPercent: 0,
                    bandEnergies: {
                        sub_bass: { rms_db: -8.2 },
                        bass: { rms_db: -6.8 },
                        low_mid: { rms_db: -7.5 },
                        mid: { rms_db: -9.1 },
                        high_mid: { rms_db: -12.3 },
                        treble: { rms_db: -15.6 }
                    }
                };
                
                const reference = { genre: 'funk_mandela' };
                
                // 4. Teste V1 (baseline)
                addResult('üìä Testando Scoring V1 (baseline)...', 'result');
                window.SCORING_V2_TEST = false;
                
                const v1Result = await window.ScoringIntegration.computeMixScore(testData, reference);
                addResult(`   V1: ${v1Result.scorePct}% (${v1Result.method}) - ${v1Result.classification}`, 'result');
                
                // 5. Teste V2 (melhorado)
                addResult('üìä Testando Scoring V2 (melhorado)...', 'result');
                window.SCORING_V2_TEST = true;
                
                const v2Result = await window.ScoringIntegration.computeMixScore(testData, reference);
                addResult(`   V2: ${v2Result.scorePct}% (${v2Result.method}) - ${v2Result.classification}`, 'result');
                
                // 6. An√°lise dos resultados
                const improvement = v2Result.scorePct - v1Result.scorePct;
                const improvementPct = v1Result.scorePct > 0 ? (improvement / v1Result.scorePct * 100) : 0;
                
                addResult('üéØ AN√ÅLISE DOS RESULTADOS:', 'result');
                addResult(`   Melhoria absoluta: ${improvement > 0 ? '+' : ''}${improvement.toFixed(1)} pontos`, 'result');
                addResult(`   Melhoria relativa: ${improvementPct > 0 ? '+' : ''}${improvementPct.toFixed(1)}%`, 'result');
                
                // 7. Verificar se V2 est√° realmente funcionando
                if (v2Result.method && v2Result.method.includes('v2')) {
                    addResult('‚úÖ SUCESSO: Scoring V2 est√° funcionando corretamente!', 'success');
                    
                    if (improvement > 0) {
                        addResult('üéâ EXCELENTE: V2 melhorou o score como esperado!', 'success');
                    } else if (improvement === 0) {
                        addResult('‚ö†Ô∏è NEUTRO: V2 manteve o mesmo score (pode ser normal)', 'warning');
                    } else {
                        addResult('‚ö†Ô∏è V2 reduziu o score - verifique par√¢metros', 'warning');
                    }
                    
                    // Informa√ß√µes t√©cnicas do V2
                    if (v2Result.scoringVersion) {
                        addResult(`   Vers√£o V2: ${v2Result.scoringVersion}`, 'result');
                    }
                    if (v2Result.processingTime) {
                        addResult(`   Tempo de processamento: ${v2Result.processingTime}ms`, 'result');
                    }
                    
                } else {
                    addResult('‚ùå PROBLEMA: V2 n√£o est√° sendo usado (caiu no fallback V1)', 'error');
                    addResult(`   M√©todo atual: ${v2Result.method}`, 'error');
                }
                
                addResult('üèÅ TESTE COMPLETO FINALIZADO!', 'success');
                
            } catch (error) {
                addResult(`‚ùå ERRO NO TESTE COMPLETO: ${error.message}`, 'error');
                addResult(`   Stack: ${error.stack}`, 'error');
            }
        }

        async function testWithRealData() {
            addResult('üéµ TESTE COM DADOS REAL√çSTICOS...', 'result');
            
            try {
                if (!window.ScoringIntegration) {
                    addResult('‚ùå Sistema n√£o carregado - execute "CARREGAR SISTEMA" primeiro', 'error');
                    return;
                }
                
                // Dados variados para diferentes cen√°rios
                const scenarios = [
                    {
                        name: 'Funk Mandela - Qualidade Alta',
                        data: {
                            lufsIntegrated: -11.8,
                            truePeakDbtp: -0.5,
                            dynamicRange: 7.2,
                            stereoCorrelation: 0.8,
                            bandEnergies: {
                                sub_bass: { rms_db: -7.5 },
                                bass: { rms_db: -6.2 },
                                low_mid: { rms_db: -7.8 },
                                mid: { rms_db: -9.5 },
                                high_mid: { rms_db: -12.1 },
                                treble: { rms_db: -14.8 }
                            }
                        },
                        reference: { genre: 'funk_mandela' }
                    },
                    {
                        name: 'Eletr√¥nico - Mixagem T√≠pica',
                        data: {
                            lufsIntegrated: -8.5,
                            truePeakDbtp: -0.2,
                            dynamicRange: 5.8,
                            stereoCorrelation: 0.65,
                            bandEnergies: {
                                sub_bass: { rms_db: -6.8 },
                                bass: { rms_db: -5.5 },
                                low_mid: { rms_db: -8.2 },
                                mid: { rms_db: -7.9 },
                                high_mid: { rms_db: -10.5 },
                                treble: { rms_db: -12.3 }
                            }
                        },
                        reference: { genre: 'eletronico' }
                    }
                ];
                
                window.SCORING_V2_TEST = true; // Usar V2 para teste
                
                for (const scenario of scenarios) {
                    addResult(`\nüéß Testando: ${scenario.name}`, 'result');
                    
                    const result = await window.ScoringIntegration.computeMixScore(scenario.data, scenario.reference);
                    
                    addResult(`   Score: ${result.scorePct}%`, 'result');
                    addResult(`   Classifica√ß√£o: ${result.classification}`, 'result');
                    addResult(`   M√©todo: ${result.method}`, 'result');
                    
                    if (result.method.includes('v2')) {
                        addResult(`   ‚úÖ V2 usado com sucesso`, 'success');
                    } else {
                        addResult(`   ‚ö†Ô∏è Fallback para V1`, 'warning');
                    }
                }
                
                addResult('üéµ TESTE COM DADOS REAIS CONCLU√çDO!', 'success');
                
            } catch (error) {
                addResult(`‚ùå ERRO NO TESTE COM DADOS REAIS: ${error.message}`, 'error');
            }
        }

        function enableV2() {
            window.SCORING_V2_TEST = true;
            addResult('üß™ Modo V2 habilitado para pr√≥ximos testes', 'success');
        }

        function disableV2() {
            window.SCORING_V2_TEST = false;
            addResult('üõ°Ô∏è Modo V2 desabilitado (voltando para V1)', 'result');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Auto-inicializar quando p√°gina carregar
        window.addEventListener('load', () => {
            addResult('üåü Sistema de teste carregado! Execute "CARREGAR SISTEMA" primeiro.', 'success');
            
            // Tentar carregamento autom√°tico
            setTimeout(async () => {
                if (typeof window.ensureScoring === 'function') {
                    addResult('üîÑ Tentando carregamento autom√°tico...', 'result');
                    try {
                        await window.ensureScoring();
                        addResult('‚úÖ Carregamento autom√°tico bem-sucedido!', 'success');
                    } catch (error) {
                        addResult('‚ö†Ô∏è Carregamento autom√°tico falhou - use carregamento manual', 'warning');
                    }
                }
            }, 1000);
        });
    </script>
</body>
</html>
