<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Urgente - Sub-Scores Corrigidos</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .metric { background: #3a3a3a; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .score { font-size: 24px; font-weight: bold; }
        .good { color: #4CAF50; }
        .warning { color: #FF9800; }
        .bad { color: #F44336; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; margin: 10px; font-size: 16px; }
        button:hover { background: #0056b3; }
        pre { background: #1a1a1a; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .urgent { border: 3px solid #ff4444; background: #331111; }
    </style>
</head>
<body>
    <div class="container">
        <div class="section urgent">
            <h1>üö® TESTE URGENTE - Verificar Sub-Scores Corrigidos</h1>
            <p><strong>PROBLEMA:</strong> Sub-scores ainda mostrando 100/100 quando deveriam ser baixos</p>
            <p><strong>CORRE√á√ÉO:</strong> Substitu√≠do audio-analyzer-v2.js pelo temp-v2.js corrigido</p>
            
            <button onclick="testarCorrecao()">üî• TESTAR AGORA - Cache Bypass</button>
            <button onclick="window.location.reload(true)">üîÑ For√ßar Reload</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Carregar o AudioAnalyzerV2 corrigido com cache bypass
        function loadCorrectedAnalyzer() {
            return new Promise((resolve, reject) => {
                const timestamp = Date.now();
                const script = document.createElement('script');
                script.src = `audio-analyzer-v2.js?v=CORRECTED-${timestamp}`;
                script.onload = () => {
                    console.log('üî• AudioAnalyzerV2 corrigido carregado!');
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function testarCorrecao() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="section"><h2>üîÑ Carregando analyzer corrigido...</h2></div>';
            
            try {
                // Carregar com cache bypass
                await loadCorrectedAnalyzer();
                
                // Verificar se tem o m√©todo corrigido
                if (!window.AudioAnalyzerV2) {
                    throw new Error('AudioAnalyzerV2 n√£o encontrado');
                }
                
                const analyzer = new window.AudioAnalyzerV2();
                console.log('üéØ Analyzer instanciado:', analyzer);
                
                // Verificar se tem o m√©todo calculateQualityScores
                if (typeof analyzer.calculateQualityScores !== 'function') {
                    throw new Error('M√©todo calculateQualityScores n√£o encontrado - ainda √© a vers√£o antiga');
                }
                
                // Simular dados do caso problem√°tico
                const metrics = {
                    core: { 
                        dynamicRange: 12.5, 
                        spectralCentroid: 2200, 
                        clippingPercentage: 0.001, 
                        dcOffset: 0.002, 
                        peak: 0.0 
                    },
                    loudness: { lufs_integrated: -0.5 },
                    truePeak: { 
                        exceeds_minus1dbtp: true,
                        dbtp: 0.0 
                    },
                    stereo: { 
                        monoCompatibility: 'good', 
                        width: 1.2, 
                        balance: 0.05 
                    }
                };
                
                // Testar o c√°lculo corrigido
                const result = analyzer.calculateQualityScores(metrics);
                
                console.log('üéâ Resultado do teste:', result);
                
                // Verificar se os scores est√£o corretos
                const loudnessOK = result.breakdown.loudness <= 20;
                const technicalOK = result.breakdown.technical <= 50;
                
                const status = loudnessOK && technicalOK ? 'SUCESSO' : 'FALHA';
                const statusClass = loudnessOK && technicalOK ? 'good' : 'bad';
                
                results.innerHTML = `
                    <div class="section">
                        <h2 class="${statusClass}">üéØ RESULTADO DO TESTE: ${status}</h2>
                        
                        <div class="metric">
                            <h3>Loudness Score</h3>
                            <div class="score ${result.breakdown.loudness <= 20 ? 'good' : 'bad'}">
                                ${result.breakdown.loudness}/100
                            </div>
                            <p>${result.breakdown.loudness <= 20 ? '‚úÖ CORRETO' : '‚ùå AINDA INCORRETO'} (esperado ‚â§ 20)</p>
                        </div>
                        
                        <div class="metric">
                            <h3>Technical Score</h3>
                            <div class="score ${result.breakdown.technical <= 50 ? 'good' : 'bad'}">
                                ${result.breakdown.technical}/100
                            </div>
                            <p>${result.breakdown.technical <= 50 ? '‚úÖ CORRETO' : '‚ùå AINDA INCORRETO'} (esperado ‚â§ 50)</p>
                        </div>
                        
                        <div class="metric">
                            <h3>Overall Score</h3>
                            <div class="score">${result.overall}/100</div>
                        </div>
                        
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                        
                        ${loudnessOK && technicalOK ? 
                            '<div class="section good"><h3>üéâ CORRE√á√ÉO CONFIRMADA!</h3><p>Os sub-scores agora est√£o precisos. Recarregue a interface principal.</p></div>' :
                            '<div class="section bad"><h3>‚ö†Ô∏è AINDA H√Å PROBLEMAS</h3><p>Os sub-scores n√£o est√£o corretos. Necess√°rio investiga√ß√£o adicional.</p></div>'
                        }
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
                results.innerHTML = `
                    <div class="section bad">
                        <h2>‚ùå ERRO NO TESTE</h2>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p>Poss√≠vel causa: Cache n√£o foi limpo ou arquivo n√£o foi substitu√≠do corretamente.</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        // Teste autom√°tico ao carregar
        window.onload = () => {
            console.log('üî• P√°gina de teste carregada - Execute o teste');
        };
    </script>
</body>
</html>
