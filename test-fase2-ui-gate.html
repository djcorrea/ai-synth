<!DOCTYPE html>
<html>
<head>
    <title>üîí TEST FASE 2 - UI GATE</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #00ff00; padding: 20px; }
        .log { padding: 5px; margin: 2px 0; border-left: 3px solid #333; }
        .error { border-color: #ff0000; color: #ff6666; }
        .success { border-color: #00ff00; }
        .info { border-color: #0066ff; color: #6666ff; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; }
        button { background: #333; color: #fff; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
        button:hover { background: #555; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.pass { background: #0a3d0a; color: #4ade80; }
        .status.fail { background: #3d0a0a; color: #f87171; }
    </style>
</head>
<body>
    <h1>üîí TESTE FASE 2 - UI GATE</h1>
    <p>Testar se o sistema de UI Gate impede renderiza√ß√£o de an√°lises canceladas</p>
    
    <div class="test-section">
        <h2>üéØ Controles de Teste</h2>
        <button onclick="testBasicUIGate()">1. Testar UI Gate B√°sico</button>
        <button onclick="testRaceCondition()">2. Testar Race Condition</button>
        <button onclick="testMultipleAnalyses()">3. Testar M√∫ltiplas An√°lises</button>
        <button onclick="clearLogs()">Limpar Logs</button>
    </div>
    
    <div class="test-section">
        <h2>üìä Resultados dos Testes</h2>
        <div id="testResults"></div>
    </div>
    
    <div class="test-section">
        <h2>üìù Console Logs</h2>
        <div id="logs"></div>
    </div>
    
    <script>
        const logsDiv = document.getElementById('logs');
        const resultsDiv = document.getElementById('testResults');
        
        function log(msg, type = 'info') {
            console.log(msg);
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function addTestResult(testName, passed, details) {
            const div = document.createElement('div');
            div.className = `status ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <strong>${testName}</strong>: ${passed ? '‚úÖ PASSOU' : '‚ùå FALHOU'}<br>
                <small>${details}</small>
            `;
            resultsDiv.appendChild(div);
        }
        
        function clearLogs() {
            logsDiv.innerHTML = '';
            resultsDiv.innerHTML = '';
        }
        
        // Mock das fun√ß√µes necess√°rias para o teste
        function setupMockEnvironment() {
            // Mock da fun√ß√£o displayModalResults original
            window._originalDisplayModalResults = window.displayModalResults;
            
            let renderAttempts = [];
            window.displayModalResults = function(analysis) {
                const analysisRunId = analysis?.runId || analysis?.metadata?.runId;
                const currentRunId = window.__CURRENT_ANALYSIS_RUN_ID__;
                
                renderAttempts.push({
                    timestamp: Date.now(),
                    analysisRunId,
                    currentRunId,
                    blocked: analysisRunId && currentRunId && analysisRunId !== currentRunId
                });
                
                log(`üé® displayModalResults chamado - runId: ${analysisRunId}, atual: ${currentRunId}`, 'info');
                
                // UI Gate Logic
                if (analysisRunId && currentRunId && analysisRunId !== currentRunId) {
                    log(`üö´ [UI_GATE] Renderiza√ß√£o bloqueada - an√°lise obsoleta`, 'error');
                    return;
                }
                
                log(`‚úÖ [UI_GATE] Renderiza√ß√£o permitida`, 'success');
                // Simular renderiza√ß√£o
            };
            
            window._getRenderAttempts = () => renderAttempts;
            window._clearRenderAttempts = () => { renderAttempts = []; };
        }
        
        async function testBasicUIGate() {
            log('üß™ Iniciando Teste 1: UI Gate B√°sico', 'info');
            setupMockEnvironment();
            window._clearRenderAttempts();
            
            try {
                // Simular an√°lise 1 (atual)
                window.__CURRENT_ANALYSIS_RUN_ID__ = 'test-001';
                
                // Tentar renderizar an√°lise atual (deve passar)
                window.displayModalResults({ runId: 'test-001' });
                
                // Tentar renderizar an√°lise antiga (deve ser bloqueada)
                window.displayModalResults({ runId: 'test-000-old' });
                
                const attempts = window._getRenderAttempts();
                const currentAllowed = attempts.find(a => a.analysisRunId === 'test-001' && !a.blocked);
                const oldBlocked = attempts.find(a => a.analysisRunId === 'test-000-old' && a.blocked);
                
                const passed = currentAllowed && oldBlocked;
                addTestResult('UI Gate B√°sico', passed, 
                    `An√°lise atual: ${currentAllowed ? 'permitida' : 'bloqueada'}, ` +
                    `An√°lise antiga: ${oldBlocked ? 'bloqueada' : 'permitida'}`
                );
                
                log(`üìä Teste 1 ${passed ? 'PASSOU' : 'FALHOU'}`, passed ? 'success' : 'error');
                
            } catch (error) {
                log(`‚ùå Erro no Teste 1: ${error.message}`, 'error');
                addTestResult('UI Gate B√°sico', false, `Erro: ${error.message}`);
            }
        }
        
        async function testRaceCondition() {
            log('üß™ Iniciando Teste 2: Race Condition', 'info');
            setupMockEnvironment();
            window._clearRenderAttempts();
            
            try {
                // Simular race condition - duas an√°lises r√°pidas
                window.__CURRENT_ANALYSIS_RUN_ID__ = 'race-001';
                
                // An√°lise 1 (vai ser superada)
                setTimeout(() => {
                    window.displayModalResults({ runId: 'race-000' });
                }, 10);
                
                // An√°lise 2 (atual)
                setTimeout(() => {
                    window.displayModalResults({ runId: 'race-001' });
                }, 20);
                
                // Verificar ap√≥s ambas tentarem renderizar
                setTimeout(() => {
                    const attempts = window._getRenderAttempts();
                    const oldBlocked = attempts.find(a => a.analysisRunId === 'race-000' && a.blocked);
                    const currentAllowed = attempts.find(a => a.analysisRunId === 'race-001' && !a.blocked);
                    
                    const passed = oldBlocked && currentAllowed;
                    addTestResult('Race Condition', passed,
                        `An√°lise superada: ${oldBlocked ? 'bloqueada' : 'permitida'}, ` +
                        `An√°lise atual: ${currentAllowed ? 'permitida' : 'bloqueada'}`
                    );
                    
                    log(`üìä Teste 2 ${passed ? 'PASSOU' : 'FALHOU'}`, passed ? 'success' : 'error');
                }, 50);
                
            } catch (error) {
                log(`‚ùå Erro no Teste 2: ${error.message}`, 'error');
                addTestResult('Race Condition', false, `Erro: ${error.message}`);
            }
        }
        
        async function testMultipleAnalyses() {
            log('üß™ Iniciando Teste 3: M√∫ltiplas An√°lises', 'info');
            setupMockEnvironment();
            window._clearRenderAttempts();
            
            try {
                // Simular sequ√™ncia de 3 an√°lises
                const runIds = ['multi-001', 'multi-002', 'multi-003'];
                
                for (let i = 0; i < runIds.length; i++) {
                    setTimeout(() => {
                        window.__CURRENT_ANALYSIS_RUN_ID__ = runIds[i];
                        
                        // Tentar renderizar todas as an√°lises anteriores
                        for (let j = 0; j <= i; j++) {
                            setTimeout(() => {
                                window.displayModalResults({ runId: runIds[j] });
                            }, j * 5);
                        }
                    }, i * 30);
                }
                
                // Verificar resultado final
                setTimeout(() => {
                    const attempts = window._getRenderAttempts();
                    const allowedCount = attempts.filter(a => !a.blocked).length;
                    const blockedCount = attempts.filter(a => a.blocked).length;
                    
                    // Deve permitir apenas as an√°lises "atuais" no momento
                    const passed = blockedCount > allowedCount;
                    addTestResult('M√∫ltiplas An√°lises', passed,
                        `Permitidas: ${allowedCount}, Bloqueadas: ${blockedCount}`
                    );
                    
                    log(`üìä Teste 3 ${passed ? 'PASSOU' : 'FALHOU'}`, passed ? 'success' : 'error');
                }, 200);
                
            } catch (error) {
                log(`‚ùå Erro no Teste 3: ${error.message}`, 'error');
                addTestResult('M√∫ltiplas An√°lises', false, `Erro: ${error.message}`);
            }
        }
        
        // Setup inicial
        window.addEventListener('load', function() {
            log('üîí Sistema de Teste UI Gate carregado', 'success');
            log('üìã Testes dispon√≠veis: UI Gate B√°sico, Race Condition, M√∫ltiplas An√°lises', 'info');
        });
    </script>
</body>
</html>
