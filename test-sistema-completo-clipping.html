<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final: Sistema Completo Clipping</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .critical-problem {
            border-left: 4px solid #F44336;
            background: rgba(244, 67, 54, 0.1);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
        }
        .urgency-badge {
            background: #F44336;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2>üéØ Teste Final: Sistema Completo de Clipping</h2>
                
                <div class="test-section">
                    <h4>üß™ Status do Sistema</h4>
                    <div id="system-status"></div>
                </div>

                <div class="test-section">
                    <h4>üéöÔ∏è Simulador de √Åudio com Clipping</h4>
                    <div class="mb-3">
                        <label for="volumeSlider" class="form-label">Volume do √Åudio (dB)</label>
                        <input type="range" class="form-control-range" id="volumeSlider" min="-20" max="5" value="-3" step="0.1">
                        <small class="text-muted">Volume atual: <span id="volumeValue">-3.0</span> dB</small>
                    </div>
                    <button id="analyzeButton" class="btn btn-primary">üîç Analisar √Åudio</button>
                    <button id="forceClippingButton" class="btn btn-danger">‚ö° For√ßar Clipping</button>
                </div>

                <div id="analysis-results" class="test-section" style="display: none;">
                    <h4>üìä Resultados da An√°lise</h4>
                    <div id="metrics-display"></div>
                </div>

                <div id="tech-problems-section" class="test-section" style="display: none;">
                    <h4>‚ö†Ô∏è Problemas T√©cnicos Detectados</h4>
                    <div id="tech-problems-list"></div>
                </div>

                <div id="critical-problems-section" class="test-section" style="display: none;">
                    <h4>üö® Problemas Cr√≠ticos (Cards Vermelhos)</h4>
                    <div id="critical-problems-list"></div>
                </div>

                <div id="suggestions-section" class="test-section" style="display: none;">
                    <h4>üí° Sugest√µes Educativas</h4>
                    <div id="suggestions-list"></div>
                </div>

                <div class="test-section">
                    <h5>üêõ Log do Sistema</h5>
                    <textarea id="system-log" class="form-control" rows="10" readonly></textarea>
                    <button id="clearLog" class="btn btn-secondary btn-sm mt-2">Limpar Log</button>
                </div>
            </div>
        </div>
    </div>

    <script src="suggestion-text-generator.js?v=6"></script>
    <script>
        // Elementos da UI
        const systemStatus = document.getElementById('system-status');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const analyzeButton = document.getElementById('analyzeButton');
        const forceClippingButton = document.getElementById('forceClippingButton');
        const systemLog = document.getElementById('system-log');
        
        const analysisResults = document.getElementById('analysis-results');
        const metricsDisplay = document.getElementById('metrics-display');
        const techProblemsSection = document.getElementById('tech-problems-section');
        const techProblemsList = document.getElementById('tech-problems-list');
        const criticalProblemsSection = document.getElementById('critical-problems-section');
        const criticalProblemsList = document.getElementById('critical-problems-list');
        const suggestionsSection = document.getElementById('suggestions-section');
        const suggestionsList = document.getElementById('suggestions-list');

        let suggestionGenerator = null;

        // Fun√ß√£o de log
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            systemLog.value += logEntry;
            systemLog.scrollTop = systemLog.scrollHeight;
            
            if (type === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        // Verificar status do sistema
        function checkSystemStatus() {
            const status = [];
            
            try {
                suggestionGenerator = new SuggestionTextGenerator();
                status.push('‚úÖ SuggestionTextGenerator: OK');
                log('SuggestionTextGenerator carregado com sucesso');
            } catch (error) {
                status.push('‚ùå SuggestionTextGenerator: ERRO');
                log(`Erro ao carregar SuggestionTextGenerator: ${error.message}`, 'error');
            }
            
            status.push('‚úÖ Sistema de Cards: OK');
            status.push('‚úÖ Interface de Teste: OK');
            
            systemStatus.innerHTML = status.join('<br>');
        }

        // Simular an√°lise de √°udio
        function simulateAudioAnalysis(volume, forceClipping = false) {
            const analysis = {
                peakLevel: volume,
                truePeak: volume + 0.5,
                rms: volume - 12,
                lufs: volume - 14,
                clipCount: 0,
                clippedSamples: [],
                problems: []
            };

            // Simular clipping baseado no volume ou for√ßa
            if (forceClipping || volume > -0.5) {
                analysis.clipCount = Math.floor(Math.random() * 50) + 5;
                analysis.clippedSamples = Array.from({length: analysis.clipCount}, (_, i) => ({
                    channel: Math.floor(Math.random() * 2),
                    sample: Math.floor(Math.random() * 44100),
                    value: 0.99 + Math.random() * 0.01
                }));
                
                analysis.problems.push({
                    type: 'clipping',
                    severity: 'high',
                    message: `Clipping detectado: ${analysis.clipCount} samples > 0.99 encontrados`,
                    solution: 'Reduza o ganho ou use um limitador para evitar clipping'
                });
            }

            if (volume > -1) {
                analysis.problems.push({
                    type: 'high_level',
                    severity: 'high',
                    message: `√Åudio muito alto - Peak em ${volume.toFixed(1)}dB pode causar distor√ß√£o`,
                    solution: 'Reduza 2-3dB para ter margem de seguran√ßa'
                });
            }

            if (analysis.truePeak > 0) {
                analysis.problems.push({
                    type: 'true_peak',
                    severity: 'high',
                    message: `True Peak cr√≠tico: +${analysis.truePeak.toFixed(1)}dBTP detectado`,
                    solution: 'Use um limitador com True Peak para manter abaixo de -0.1dBTP'
                });
            }

            return analysis;
        }

        // Renderizar card cr√≠tico
        function renderCriticalCard(problem) {
            let cardHtml = '';
            
            if (suggestionGenerator) {
                try {
                    const suggestion = suggestionGenerator.generateSuggestion(problem.message);
                    if (suggestion) {
                        cardHtml = `
                            <div class="critical-problem mb-3">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div style="flex: 1; font-weight: 700; font-size: 14px; color: #F44336;">${suggestion.title}</div>
                                    <span class="urgency-badge">CR√çTICO</span>
                                </div>
                                <div style="font-size: 13px; line-height: 1.5; margin: 8px 0; color: #ff6b6b; font-weight: 500;">
                                    üí• ${suggestion.explanation}
                                </div>
                                <div style="font-size: 12px; color: #333; margin: 8px 0;">
                                    üîß <strong>A√ß√£o:</strong> ${suggestion.action}
                                </div>
                                <div style="font-size: 12px; color: #666; margin: 8px 0;">
                                    üéì <strong>Por qu√™:</strong> ${suggestion.rationale}
                                </div>
                                <div style="font-size: 11px; background: rgba(0,0,0,0.1); padding: 6px; border-radius: 4px; margin-top: 8px; font-family: monospace;">
                                    üìä ${suggestion.technical}
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    log(`Erro ao gerar sugest√£o para ${problem.message}: ${error.message}`, 'error');
                }
            }
            
            if (!cardHtml) {
                cardHtml = `
                    <div class="critical-problem mb-3">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1; font-weight: 700; font-size: 14px; color: #F44336;">üö® ${problem.message}</div>
                            <span class="urgency-badge">CR√çTICO</span>
                        </div>
                        <div style="font-size: 12px; color: #333;">
                            üîß ${problem.solution}
                        </div>
                    </div>
                `;
            }
            
            return cardHtml;
        }

        // Processar an√°lise
        function processAnalysis(analysis) {
            log(`Processando an√°lise: Peak ${analysis.peakLevel}dB, ${analysis.problems.length} problemas`);
            
            // Mostrar m√©tricas
            metricsDisplay.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <strong>Peak Level:</strong><br>
                        <span class="${analysis.peakLevel > -1 ? 'text-danger' : 'text-success'}">${analysis.peakLevel.toFixed(1)} dB</span>
                    </div>
                    <div class="col-md-3">
                        <strong>True Peak:</strong><br>
                        <span class="${analysis.truePeak > 0 ? 'text-danger' : 'text-success'}">${analysis.truePeak > 0 ? '+' : ''}${analysis.truePeak.toFixed(1)} dBTP</span>
                    </div>
                    <div class="col-md-3">
                        <strong>RMS:</strong><br>
                        <span>${analysis.rms.toFixed(1)} dB</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Clipped Samples:</strong><br>
                        <span class="${analysis.clipCount > 0 ? 'text-danger' : 'text-success'}">${analysis.clipCount}</span>
                    </div>
                </div>
            `;
            analysisResults.style.display = 'block';

            // Processar problemas t√©cnicos
            if (analysis.problems.length > 0) {
                techProblemsList.innerHTML = analysis.problems.map(p => `
                    <div class="alert alert-warning mb-2">
                        <strong>${p.message}</strong><br>
                        <small>${p.solution}</small>
                    </div>
                `).join('');
                techProblemsSection.style.display = 'block';

                // Processar problemas cr√≠ticos
                const criticalProblems = analysis.problems.filter(p => p.severity === 'high');
                if (criticalProblems.length > 0) {
                    criticalProblemsList.innerHTML = criticalProblems.map(renderCriticalCard).join('');
                    criticalProblemsSection.style.display = 'block';
                    log(`${criticalProblems.length} problemas cr√≠ticos renderizados como cards vermelhos`);
                }
            } else {
                techProblemsSection.style.display = 'none';
                criticalProblemsSection.style.display = 'none';
            }
        }

        // Event Listeners
        volumeSlider.addEventListener('input', (e) => {
            volumeValue.textContent = parseFloat(e.target.value).toFixed(1);
        });

        analyzeButton.addEventListener('click', () => {
            const volume = parseFloat(volumeSlider.value);
            log(`Iniciando an√°lise com volume ${volume}dB`);
            const analysis = simulateAudioAnalysis(volume);
            processAnalysis(analysis);
        });

        forceClippingButton.addEventListener('click', () => {
            const volume = parseFloat(volumeSlider.value);
            log('For√ßando clipping para teste');
            const analysis = simulateAudioAnalysis(volume, true);
            processAnalysis(analysis);
        });

        document.getElementById('clearLog').addEventListener('click', () => {
            systemLog.value = '';
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            log('Sistema de teste inicializado');
            checkSystemStatus();
        });
    </script>
</body>
</html>
