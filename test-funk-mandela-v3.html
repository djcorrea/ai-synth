<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Funk Mandela v3.0 - Padrões Fixos + Flexíveis</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #333; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
        .metric { padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        .metric.hard { border-color: #dc3545; background: #fff5f5; }
        .metric.soft { border-color: #28a745; background: #f8fff8; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎛️ Teste Funk Mandela v3.0 - Padrões Fixos + Flexíveis</h1>
        <p><strong>Objetivo:</strong> Validar implementação de constraints hard/soft e novos alvos</p>
        
        <div class="controls">
            <button class="btn-primary" onclick="loadNewReference()">Carregar Funk Mandela v3.0</button>
            <button class="btn-success" onclick="testHardConstraints()">Testar Hard Constraints</button>
            <button class="btn-success" onclick="testSoftConstraints()">Testar Soft Constraints</button>
            <button class="btn-danger" onclick="testMixedScenarios()">Cenários Mistos</button>
        </div>

        <div id="referenceStatus" class="test-section">
            <h3>📂 Status da Referência</h3>
            <div id="refInfo">Carregando...</div>
        </div>

        <div id="hardConstraintsTest" class="test-section">
            <h3>🔥 Hard Constraints (Obrigatórios)</h3>
            <div class="metrics">
                <div class="metric hard">
                    <strong>LUFS Target</strong><br>
                    -8 LUFS ±1
                </div>
                <div class="metric hard">
                    <strong>True Peak</strong><br>
                    -0.3 dBTP (stream)<br>
                    0.0 dBTP (baile)
                </div>
                <div class="metric hard">
                    <strong>Dynamic Range</strong><br>
                    8 ±1
                </div>
                <div class="metric hard">
                    <strong>Low End Mono</strong><br>
                    &lt; 100Hz
                </div>
                <div class="metric hard">
                    <strong>Vocal Presence</strong><br>
                    1kHz-4kHz ≥ 3dB
                </div>
            </div>
            <div id="hardResults"></div>
        </div>

        <div id="softConstraintsTest" class="test-section">
            <h3>🎨 Soft Constraints (Estéticos)</h3>
            <div class="metrics">
                <div class="metric soft">
                    <strong>Clipping</strong><br>
                    ≤ 2% samples
                </div>
                <div class="metric soft">
                    <strong>LRA Range</strong><br>
                    1.0 - 4.0 LU
                </div>
                <div class="metric soft">
                    <strong>Stereo Width</strong><br>
                    Tolerância ampla
                </div>
                <div class="metric soft">
                    <strong>Tonal Bands</strong><br>
                    Tolerâncias abertas
                </div>
            </div>
            <div id="softResults"></div>
        </div>

        <div id="mixedScenariosTest" class="test-section">
            <h3>🧪 Cenários de Teste</h3>
            <div id="scenarioResults"></div>
        </div>

        <div id="validationResults" class="test-section">
            <h3>✅ Resultados de Validação</h3>
            <div id="finalResults"></div>
        </div>
    </div>

    <script>
        // Dados de teste
        const testScenarios = {
            // Cenário 1: Todos hard OK, alguns soft com problema
            perfectHardImperfectSoft: {
                name: "Hard Perfeito, Soft com Problemas",
                data: {
                    lufsIntegrated: -8.0,           // ✅ Hard: perfeito
                    truePeakDbtp: -0.3,             // ✅ Hard: perfeito
                    dynamicRange: 8.0,              // ✅ Hard: perfeito
                    clippingPct: 0.03,              // ❌ Soft: 3% > 2%
                    lra: 5.0,                       // ❌ Soft: fora 1-4
                    stereoCorrelation: 0.4,         // ❌ Soft: muito amplo
                    bandEnergies: {
                        mid: { rms_db: -6.3 },      // ✅ Vocal: OK
                        presenca: { rms_db: -19.2 } // ✅ Vocal: OK
                    }
                },
                expectedScore: "> 85%", // Hard OK deve garantir score alto
                expectedClass: "Avançado"
            },

            // Cenário 2: Um hard falhando
            oneHardFailing: {
                name: "Um Hard Constraint Falhando",
                data: {
                    lufsIntegrated: -6.0,           // ❌ Hard: muito alto
                    truePeakDbtp: -0.3,             // ✅ Hard: OK
                    dynamicRange: 8.0,              // ✅ Hard: OK
                    clippingPct: 0.01,              // ✅ Soft: perfeito
                    lra: 2.5,                       // ✅ Soft: perfeito
                    stereoCorrelation: 0.22,        // ✅ Soft: perfeito
                    bandEnergies: {
                        mid: { rms_db: -6.3 },      // ✅ Vocal: OK
                        presenca: { rms_db: -19.2 } // ✅ Vocal: OK
                    }
                },
                expectedScore: "< 70%", // Hard falhando deve impactar significativamente
                expectedClass: "Intermediário"
            },

            // Cenário 3: Streaming vs Baile context
            streamingContext: {
                name: "Contexto Streaming (-0.3 dBTP)",
                data: {
                    lufsIntegrated: -8.0,
                    truePeakDbtp: -0.2,             // ❌ Para streaming
                    dynamicRange: 8.0,
                    context: "streaming"
                },
                expectedWarning: "True peak inadequado para streaming"
            },

            baileContext: {
                name: "Contexto Baile (0.0 dBTP OK)",
                data: {
                    lufsIntegrated: -8.0,
                    truePeakDbtp: -0.1,             // ✅ Para baile
                    dynamicRange: 8.0,
                    context: "baile"
                },
                expectedWarning: null
            }
        };

        async function loadNewReference() {
            const statusDiv = document.getElementById('refInfo');
            statusDiv.innerHTML = '🔄 Carregando Funk Mandela v3.0...';

            try {
                // Tentar carregar o JSON atualizado
                const response = await fetch('/refs/out/funk_mandela.json?v=' + Date.now(), {
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const funkRef = data.funk_mandela;

                if (funkRef.version !== 'v3.0') {
                    throw new Error(`Versão incorreta: ${funkRef.version} (esperado v3.0)`);
                }

                // Verificar novos campos
                const newFields = [
                    'tol_lufs_min', 'true_peak_streaming_max', 'lra_min', 'lra_max',
                    'low_end_mono_cutoff', 'clipping_sample_pct_max', 'vocal_band_min_delta'
                ];

                const missingFields = newFields.filter(field => !(field in funkRef));
                
                let html = `<div class="result pass">
                    ✅ <strong>Funk Mandela v3.0 carregado com sucesso!</strong><br>
                    📅 Gerado em: ${funkRef.generated_at}<br>
                    🎵 Tracks: ${funkRef.num_tracks}<br>
                    📊 Método: ${funkRef.aggregation_method}
                </div>`;

                if (missingFields.length === 0) {
                    html += `<div class="result pass">✅ Todos os novos campos presentes</div>`;
                } else {
                    html += `<div class="result warning">⚠️ Campos ausentes: ${missingFields.join(', ')}</div>`;
                }

                // Mostrar principais targets
                html += `<div style="margin-top: 15px;">
                    <strong>🎯 Principais Targets:</strong><br>
                    • LUFS: ${funkRef.lufs_target} ±${funkRef.tol_lufs}<br>
                    • True Peak: ${funkRef.true_peak_target} dBTP<br>
                    • DR: ${funkRef.dr_target} ±${funkRef.tol_dr}<br>
                    • LRA: ${funkRef.lra_min}-${funkRef.lra_max} LU<br>
                    • Clipping máx: ${funkRef.clipping_sample_pct_max * 100}%
                </div>`;

                statusDiv.innerHTML = html;
                
                // Salvar referência para testes
                window.FUNK_MANDELA_V3_REF = funkRef;
                
                return funkRef;

            } catch (error) {
                statusDiv.innerHTML = `<div class="result fail">
                    ❌ <strong>Erro ao carregar:</strong> ${error.message}
                </div>`;
                throw error;
            }
        }

        function testHardConstraints() {
            const resultsDiv = document.getElementById('hardResults');
            const ref = window.FUNK_MANDELA_V3_REF;
            
            if (!ref) {
                resultsDiv.innerHTML = '<div class="result fail">❌ Referência não carregada</div>';
                return;
            }

            let html = '<h4>🧪 Testando Hard Constraints:</h4>';

            // Teste 1: LUFS perfeito
            const lufsTest = testMetric(-8.0, ref.lufs_target, ref.tol_lufs, 'LUFS');
            html += `<div class="result ${lufsTest.status}">${lufsTest.message}</div>`;

            // Teste 2: True Peak streaming
            const tpStreamTest = testMetric(-0.3, ref.true_peak_streaming_max, 0.1, 'True Peak (streaming)');
            html += `<div class="result ${tpStreamTest.status}">${tpStreamTest.message}</div>`;

            // Teste 3: DR
            const drTest = testMetric(8.0, ref.dr_target, ref.tol_dr, 'Dynamic Range');
            html += `<div class="result ${drTest.status}">${drTest.message}</div>`;

            // Teste 4: Clipping limite
            const clippingTest = testMetric(0.02, ref.clipping_sample_pct_max, 0, 'Clipping % (hard limit)');
            html += `<div class="result ${clippingTest.status}">${clippingTest.message}</div>`;

            resultsDiv.innerHTML = html;
        }

        function testSoftConstraints() {
            const resultsDiv = document.getElementById('softResults');
            const ref = window.FUNK_MANDELA_V3_REF;
            
            if (!ref) {
                resultsDiv.innerHTML = '<div class="result fail">❌ Referência não carregada</div>';
                return;
            }

            let html = '<h4>🎨 Testando Soft Constraints:</h4>';

            // Teste 1: LRA fora da faixa (mas não crítico)
            const lraTest = {
                status: 'warning',
                message: `⚠️ LRA fora da faixa (5.0 LU, ideal: ${ref.lra_min}-${ref.lra_max}) - Soft constraint`
            };
            html += `<div class="result ${lraTest.status}">${lraTest.message}</div>`;

            // Teste 2: Stereo muito amplo (tolerado)
            const stereoTest = {
                status: 'warning',
                message: '⚠️ Stereo width amplo (0.4, target: 0.22) - Permitido em soft constraint'
            };
            html += `<div class="result ${stereoTest.status}">${stereoTest.message}</div>`;

            // Teste 3: Bandas com tolerância ampliada
            html += '<div class="result pass">✅ Bandas tonais com tolerâncias ampliadas conforme especificação</div>';

            resultsDiv.innerHTML = html;
        }

        function testMixedScenarios() {
            const resultsDiv = document.getElementById('scenarioResults');
            let html = '<h4>🧪 Cenários de Teste Complexos:</h4>';

            for (const [key, scenario] of Object.entries(testScenarios)) {
                const result = simulateScoring(scenario.data);
                const status = evaluateScenario(result, scenario);
                
                html += `<div class="result ${status}">
                    <strong>${scenario.name}</strong><br>
                    Score simulado: ${result.score}% (${result.classification})<br>
                    Esperado: ${scenario.expectedScore || 'N/A'}<br>
                    ${scenario.expectedWarning ? `⚠️ ${scenario.expectedWarning}` : ''}
                </div>`;
            }

            resultsDiv.innerHTML = html;
        }

        function testMetric(value, target, tolerance, name) {
            const diff = Math.abs(value - target);
            const withinTolerance = diff <= tolerance;
            
            return {
                status: withinTolerance ? 'pass' : 'fail',
                message: `${withinTolerance ? '✅' : '❌'} ${name}: ${value} (target: ${target}±${tolerance}, diff: ${diff.toFixed(2)})`
            };
        }

        function simulateScoring(data) {
            // Simulação simplificada do scoring
            let hardConstraintsPassed = 0;
            let hardConstraintsTotal = 0;
            let softIssues = 0;

            // Hard constraints
            if (Math.abs(data.lufsIntegrated - (-8)) <= 1) hardConstraintsPassed++;
            hardConstraintsTotal++;

            if (data.truePeakDbtp >= -0.3 || (data.context === 'baile' && data.truePeakDbtp >= 0)) hardConstraintsPassed++;
            hardConstraintsTotal++;

            if (Math.abs(data.dynamicRange - 8) <= 1) hardConstraintsPassed++;
            hardConstraintsTotal++;

            // Soft constraints (apenas contam como warnings)
            if (data.clippingPct > 0.02) softIssues++;
            if (data.lra < 1.0 || data.lra > 4.0) softIssues++;
            if (data.stereoCorrelation > 0.35) softIssues++;

            const hardScore = (hardConstraintsPassed / hardConstraintsTotal) * 100;
            const softPenalty = Math.min(softIssues * 5, 15); // Máximo 15% de penalidade soft
            
            const finalScore = Math.max(0, hardScore - softPenalty);
            
            let classification;
            if (finalScore >= 85) classification = 'Avançado';
            else if (finalScore >= 70) classification = 'Intermediário';
            else classification = 'Básico';

            return {
                score: Math.round(finalScore),
                classification,
                hardPassed: hardConstraintsPassed,
                hardTotal: hardConstraintsTotal,
                softIssues
            };
        }

        function evaluateScenario(result, scenario) {
            // Avaliar se resultado condiz com expectativa
            if (scenario.expectedScore) {
                if (scenario.expectedScore.includes('>')) {
                    const threshold = parseInt(scenario.expectedScore.replace(/[^0-9]/g, ''));
                    return result.score > threshold ? 'pass' : 'fail';
                } else if (scenario.expectedScore.includes('<')) {
                    const threshold = parseInt(scenario.expectedScore.replace(/[^0-9]/g, ''));
                    return result.score < threshold ? 'pass' : 'fail';
                }
            }
            
            if (scenario.expectedClass) {
                return result.classification === scenario.expectedClass ? 'pass' : 'warning';
            }
            
            return 'pass';
        }

        // Auto-carregar ao abrir página
        window.addEventListener('load', () => {
            loadNewReference().catch(console.error);
        });
    </script>
</body>
</html>
