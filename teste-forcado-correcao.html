<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste For√ßado - Corre√ß√£o de Bandas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .success { background: #2d5a27; }
        .warning { background: #5a4a27; }
        .error { background: #5a2727; }
        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #005a9e; }
        .btn.danger { background: #dc3545; }
        .btn.success { background: #28a745; }
        pre {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üöÄ Teste For√ßado - Corre√ß√£o de Bandas FabFilter</h1>
    
    <div class="test-section warning">
        <h3>‚ö†Ô∏è Importante</h3>
        <p>Este teste for√ßa a limpeza total de cache e aplica as corre√ß√µes de forma agressiva. Certifique-se de ter feito backup se necess√°rio.</p>
        <button class="btn danger" onclick="forceCleanAll()">üßπ Limpar TUDO (Cache + LocalStorage)</button>
        <button class="btn" onclick="reloadSystem()">üîÑ Recarregar Sistema</button>
    </div>
    
    <div class="test-section">
        <h3>üîß Teste de Corre√ß√£o For√ßada</h3>
        <button class="btn success" onclick="testForcedCorrection()">üéØ Testar Corre√ß√£o For√ßada</button>
        <button class="btn" onclick="simulateAnalysisWithValues()">üìä Simular com Valores Reais</button>
        <button class="btn" onclick="checkConsoleDebug()">üêõ Ver Debug no Console</button>
    </div>
    
    <div class="test-section" id="results">
        <h3>üìä Resultados</h3>
        <p>Execute o teste para ver os resultados...</p>
    </div>
    
    <div class="test-section" id="debug-output">
        <h3>üêõ Debug Output</h3>
        <pre id="debug-pre">Aguardando execu√ß√£o...</pre>
    </div>
    
    <script>
        let debugLog = [];
        
        // Interceptar console.log para capturar debug
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            if (args[0] && args[0].includes('üîß')) {
                debugLog.push(args.join(' '));
                updateDebugOutput();
            }
        };
        
        function updateDebugOutput() {
            const pre = document.getElementById('debug-pre');
            pre.textContent = debugLog.slice(-20).join('\n') || 'Nenhum debug capturado ainda...';
        }
        
        function forceCleanAll() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>üßπ Limpando TUDO...</h3>';
            
            // Limpar todos os caches poss√≠veis
            try {
                // Cache do sistema
                if (window.__PROD_AI_ADV_CACHE__) {
                    window.__PROD_AI_ADV_CACHE__ = {};
                }
                
                // LocalStorage
                localStorage.clear();
                
                // SessionStorage
                sessionStorage.clear();
                
                // Cache do navegador
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                
                // Vari√°veis globais do sistema
                window.__activeRefData = null;
                window.__refDataCache = {};
                window.PROD_AI_REF_GENRE = null;
                
                // For√ßar garbage collection se poss√≠vel
                if (window.gc) window.gc();
                
                results.innerHTML = `
                    <h3>üßπ Limpeza Completa</h3>
                    <div style="background: #2d5a27; padding: 15px; border-radius: 8px;">
                        <h4>‚úÖ Tudo foi limpo!</h4>
                        <ul>
                            <li>Cache do sistema: Limpo</li>
                            <li>LocalStorage: Limpo</li>
                            <li>SessionStorage: Limpo</li>
                            <li>Cache do navegador: Limpo</li>
                            <li>Vari√°veis globais: Resetadas</li>
                        </ul>
                        <p><strong>Pr√≥ximo passo:</strong> Recarregue a p√°gina ou o sistema para aplicar as corre√ß√µes.</p>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <h3>üßπ Limpeza</h3>
                    <div style="background: #5a2727; padding: 15px; border-radius: 8px;">
                        <h4>‚ùå Erro durante limpeza</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function reloadSystem() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>üîÑ Recarregando...</h3>';
            
            // Recarregar scripts do sistema
            const scripts = [
                'public/temp-v2.js',
                'public/audio-analyzer.js', 
                'public/audio-analyzer-integration.js'
            ];
            
            let loaded = 0;
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src + '?v=' + Date.now(); // Cache bust
                script.onload = () => {
                    loaded++;
                    if (loaded === scripts.length) {
                        results.innerHTML = `
                            <h3>üîÑ Sistema Recarregado</h3>
                            <div style="background: #2d5a27; padding: 15px; border-radius: 8px;">
                                <h4>‚úÖ Scripts recarregados com sucesso!</h4>
                                <p>Agora voc√™ pode testar a corre√ß√£o.</p>
                            </div>
                        `;
                    }
                };
                script.onerror = () => {
                    results.innerHTML = `
                        <h3>üîÑ Erro no Recarregamento</h3>
                        <div style="background: #5a2727; padding: 15px; border-radius: 8px;">
                            <h4>‚ùå Falha ao carregar ${src}</h4>
                        </div>
                    `;
                };
                document.head.appendChild(script);
            });
        }
        
        function testForcedCorrection() {
            debugLog = []; // Limpar log anterior
            const results = document.getElementById('results');
            results.innerHTML = '<h3>üéØ Testando Corre√ß√£o For√ßada...</h3>';
            
            // Dados simulados que imitam sua situa√ß√£o atual
            const mockAnalysis = {
                technicalData: {
                    bandEnergies: {
                        low_bass: { rms_db: 8.87, scale: 'original' },
                        upper_bass: { rms_db: 8.36, scale: 'original' },
                        low_mid: { rms_db: 13.15, scale: 'original' },
                        mid: { rms_db: 4.19, scale: 'original' },
                        high_mid: { rms_db: -2.96, scale: 'original' },
                        brilho: { rms_db: -3.72, scale: 'original' },
                        presenca: { rms_db: -19.40, scale: 'original' }
                    }
                }
            };
            
            console.log('üîß [TESTE] Iniciando teste com bandEnergies existentes...');
            console.log('üîß [TESTE] Valores antes da corre√ß√£o:', mockAnalysis.technicalData.bandEnergies);
            
            // Simular container e dados de refer√™ncia
            const tempContainer = document.createElement('div');
            tempContainer.id = 'referenceComparisons';
            document.body.appendChild(tempContainer);
            
            window.__activeRefData = {
                bands: {
                    low_bass: { target_db: 15.40, tol_db: 1.0 },
                    upper_bass: { target_db: 10.80, tol_db: 2.0 },
                    mid: { target_db: 3.30, tol_db: 2.0 }
                }
            };
            window.PROD_AI_REF_GENRE = 'FUNK_MANDELA';
            
            // For√ßar o debug
            window.DEBUG_ANALYZER = true;
            
            // Chamar fun√ß√£o de corre√ß√£o
            if (typeof window.renderReferenceComparisons === 'function') {
                window.renderReferenceComparisons(mockAnalysis);
                
                console.log('üîß [TESTE] Valores ap√≥s corre√ß√£o:', mockAnalysis.technicalData.bandEnergies);
                
                // Verificar se corre√ß√£o foi aplicada
                const lowBassAfter = mockAnalysis.technicalData.bandEnergies.low_bass.rms_db;
                const midAfter = mockAnalysis.technicalData.bandEnergies.mid.rms_db;
                const correctionApplied = mockAnalysis.technicalData._fabfilterCompensationApplied;
                
                results.innerHTML = `
                    <h3>üéØ Resultado do Teste</h3>
                    <div style="background: ${correctionApplied ? '#2d5a27' : '#5a2727'}; padding: 15px; border-radius: 8px;">
                        <h4>${correctionApplied ? '‚úÖ' : '‚ùå'} Corre√ß√£o ${correctionApplied ? 'APLICADA' : 'N√ÉO APLICADA'}</h4>
                        <table style="width: 100%; color: white;">
                            <tr><th>Banda</th><th>Antes</th><th>Depois</th><th>Mudan√ßa</th></tr>
                            <tr><td>low_bass</td><td>8.87 dB</td><td>${lowBassAfter.toFixed(2)} dB</td><td>${(lowBassAfter - 8.87).toFixed(2)} dB</td></tr>
                            <tr><td>mid</td><td>4.19 dB</td><td>${midAfter.toFixed(2)} dB</td><td>${(midAfter - 4.19).toFixed(2)} dB</td></tr>
                        </table>
                        <p><strong>Flag de corre√ß√£o:</strong> ${correctionApplied ? 'Ativada' : 'N√£o ativada'}</p>
                    </div>
                `;
            } else {
                results.innerHTML = `
                    <h3>üéØ Erro no Teste</h3>
                    <div style="background: #5a2727; padding: 15px; border-radius: 8px;">
                        <h4>‚ùå Fun√ß√£o renderReferenceComparisons n√£o encontrada</h4>
                        <p>Recarregue o sistema primeiro.</p>
                    </div>
                `;
            }
            
            // Limpar
            document.body.removeChild(tempContainer);
        }
        
        function simulateAnalysisWithValues() {
            // Simular exatamente os valores que voc√™ est√° vendo
            const realValues = {
                technicalData: {
                    bandEnergies: {
                        low_bass: { rms_db: 8.87, scale: 'original' },
                        upper_bass: { rms_db: 8.36, scale: 'original' },
                        low_mid: { rms_db: 13.15, scale: 'original' },
                        mid: { rms_db: 4.19, scale: 'original' },
                        high_mid: { rms_db: -2.96, scale: 'original' },
                        brilho: { rms_db: -3.72, scale: 'original' },
                        presenca: { rms_db: -19.40, scale: 'original' }
                    }
                }
            };
            
            console.log('üîß [SIMULA√á√ÉO] Testando com valores reais da sua tabela...');
            testForcedCorrection();
        }
        
        function checkConsoleDebug() {
            const results = document.getElementById('results');
            results.innerHTML = `
                <h3>üêõ Debug Console</h3>
                <div style="background: #333; padding: 15px; border-radius: 8px;">
                    <h4>Instru√ß√µes:</h4>
                    <ol>
                        <li>Abra o Console do navegador (F12 ‚Üí Console)</li>
                        <li>Execute o teste de corre√ß√£o</li>
                        <li>Procure por mensagens que come√ßam com "üîß"</li>
                        <li>Verifique se aparecem as mensagens de debug da corre√ß√£o</li>
                    </ol>
                    <p><strong>Debug capturado:</strong> ${debugLog.length} mensagens</p>
                </div>
            `;
            updateDebugOutput();
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            updateDebugOutput();
        });
    </script>
</body>
</html>
