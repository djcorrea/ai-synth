<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Pipeline - Teste A/B</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #111;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
        }
        .test-section {
            background: #1a1a1a;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #00ff00;
            border-radius: 4px;
        }
        .test-section.disabled {
            border-left-color: #ff4444;
            opacity: 0.7;
        }
        .result {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 12px;
            white-space: pre-wrap;
        }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #555;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #444;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background: #1a4d1a; }
        .status.error { background: #4d1a1a; }
        .status.warning { background: #4d4d1a; }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .test-result {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Diagn√≥stico Pipeline - Teste A/B</h1>
        <p>Este teste compara o comportamento COM e SEM a corre√ß√£o da ordem do pipeline</p>

        <div class="test-section">
            <h3>üìã Status Atual</h3>
            <div id="status" class="status">Verificando configura√ß√£o...</div>
            <button onclick="checkStatus()">üîç Verificar Status</button>
        </div>

        <div class="test-section">
            <h3>üéµ Teste com Arquivo</h3>
            <input type="file" id="audioFile" accept="audio/*">
            <br><br>
            <button onclick="runTestWithCorrection()" id="testWith">‚úÖ Testar COM Corre√ß√£o</button>
            <button onclick="runTestWithoutCorrection()" id="testWithout">‚ùå Testar SEM Corre√ß√£o</button>
            <button onclick="runComparison()" id="comparison">‚öñÔ∏è Compara√ß√£o A/B</button>
        </div>

        <div class="comparison">
            <div class="test-result">
                <h4>COM Corre√ß√£o do Pipeline</h4>
                <div id="resultWith" class="result">Aguardando teste...</div>
            </div>
            <div class="test-result">
                <h4>SEM Corre√ß√£o do Pipeline</h4>
                <div id="resultWithout" class="result">Aguardando teste...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìä An√°lise de Diferen√ßas</h3>
            <div id="analysis" class="result">Execute os testes para ver a an√°lise...</div>
            <button onclick="analyzeResults()">üî¨ Analisar Diferen√ßas</button>
        </div>

        <div class="test-section">
            <h3>üè• Diagn√≥stico Completo</h3>
            <div id="diagnosis" class="result">Clique em 'Diagnosticar' ap√≥s executar os testes</div>
            <button onclick="runFullDiagnosis()">ü©∫ Diagnosticar Sistema</button>
        </div>
    </div>

    <script>
        let testResults = {
            withCorrection: null,
            withoutCorrection: null
        };

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            element.textContent += `${prefix} [${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollTop + 1000;
        }

        function checkStatus() {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status';
            statusDiv.textContent = 'Verificando...';

            // Verificar se o pipeline order correction est√° dispon√≠vel
            if (typeof window.PipelineOrderCorrection !== 'undefined') {
                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Pipeline Order Correction ATIVO e funcionando';
                log('status', 'Pipeline Order Correction detectado: ' + typeof window.PipelineOrderCorrection, 'success');
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Pipeline Order Correction N√ÉO detectado';
                log('status', 'Pipeline Order Correction n√£o encontrado', 'error');
            }

            // Verificar AudioAnalyzer
            if (typeof window.AudioAnalyzer !== 'undefined') {
                log('status', 'AudioAnalyzer dispon√≠vel: ' + typeof window.AudioAnalyzer, 'success');
            } else {
                log('status', 'AudioAnalyzer N√ÉO dispon√≠vel', 'error');
            }

            // Verificar flags
            try {
                const config = window.PipelineOrderCorrection?.getCurrentConfig?.();
                if (config) {
                    log('status', 'Configura√ß√£o atual: ' + JSON.stringify(config, null, 2), 'success');
                }
            } catch (e) {
                log('status', 'Erro ao verificar configura√ß√£o: ' + e.message, 'error');
            }
        }

        async function runTestWithCorrection() {
            const file = document.getElementById('audioFile').files[0];
            if (!file) {
                alert('Selecione um arquivo de √°udio primeiro');
                return;
            }

            log('resultWith', 'Iniciando teste COM corre√ß√£o do pipeline...', 'info');
            
            try {
                // Garantir que a corre√ß√£o est√° ativa
                if (window.PipelineOrderCorrection?.configureValidationThreshold) {
                    window.PipelineOrderCorrection.configureValidationThreshold({
                        threshold: 0.75,
                        minimumBands: 2,
                        adaptive: true
                    });
                    log('resultWith', 'Corre√ß√£o configurada: threshold=75%, minimumBands=2', 'success');
                }

                // Executar an√°lise
                const startTime = Date.now();
                const result = await analyzeAudioFile(file, true);
                const endTime = Date.now();

                testResults.withCorrection = {
                    ...result,
                    executionTime: endTime - startTime,
                    timestamp: new Date().toISOString()
                };

                log('resultWith', `An√°lise conclu√≠da em ${endTime - startTime}ms`, 'success');
                log('resultWith', `Score: ${result.score}`, 'info');
                log('resultWith', `Bandas v√°lidas: ${result.validBands}/${result.totalBands}`, 'info');
                log('resultWith', `Pipeline stages: ${result.pipelineStages}`, 'info');

            } catch (error) {
                log('resultWith', 'Erro na an√°lise: ' + error.message, 'error');
            }
        }

        async function runTestWithoutCorrection() {
            const file = document.getElementById('audioFile').files[0];
            if (!file) {
                alert('Selecione um arquivo de √°udio primeiro');
                return;
            }

            log('resultWithout', 'Iniciando teste SEM corre√ß√£o do pipeline...', 'info');
            
            try {
                // Desativar temporariamente a corre√ß√£o
                const originalFlag = window.PIPELINE_ORDER_CORRECTION_ENABLED;
                window.PIPELINE_ORDER_CORRECTION_ENABLED = false;
                
                log('resultWithout', 'Corre√ß√£o temporariamente desativada', 'warning');

                // Executar an√°lise
                const startTime = Date.now();
                const result = await analyzeAudioFile(file, false);
                const endTime = Date.now();

                // Restaurar flag
                window.PIPELINE_ORDER_CORRECTION_ENABLED = originalFlag;

                testResults.withoutCorrection = {
                    ...result,
                    executionTime: endTime - startTime,
                    timestamp: new Date().toISOString()
                };

                log('resultWithout', `An√°lise conclu√≠da em ${endTime - startTime}ms`, 'success');
                log('resultWithout', `Score: ${result.score}`, 'info');
                log('resultWithout', `Bandas v√°lidas: ${result.validBands}/${result.totalBands}`, 'info');
                log('resultWithout', `Pipeline stages: ${result.pipelineStages}`, 'info');
                log('resultWithout', 'Flag de corre√ß√£o restaurada', 'success');

            } catch (error) {
                log('resultWithout', 'Erro na an√°lise: ' + error.message, 'error');
                // Garantir que a flag seja restaurada mesmo em caso de erro
                window.PIPELINE_ORDER_CORRECTION_ENABLED = true;
            }
        }

        async function runComparison() {
            if (!testResults.withCorrection || !testResults.withoutCorrection) {
                alert('Execute primeiro os testes COM e SEM corre√ß√£o');
                return;
            }

            analyzeResults();
        }

        function analyzeResults() {
            if (!testResults.withCorrection || !testResults.withoutCorrection) {
                log('analysis', 'Execute ambos os testes primeiro', 'warning');
                return;
            }

            const with_ = testResults.withCorrection;
            const without = testResults.withoutCorrection;

            log('analysis', '=== AN√ÅLISE COMPARATIVA ===', 'info');
            log('analysis', `Score COM corre√ß√£o: ${with_.score}`, 'info');
            log('analysis', `Score SEM corre√ß√£o: ${without.score}`, 'info');
            log('analysis', `Diferen√ßa no score: ${(with_.score - without.score).toFixed(2)}`, with_.score !== without.score ? 'warning' : 'info');
            
            log('analysis', `Tempo COM corre√ß√£o: ${with_.executionTime}ms`, 'info');
            log('analysis', `Tempo SEM corre√ß√£o: ${without.executionTime}ms`, 'info');
            log('analysis', `Diferen√ßa no tempo: ${with_.executionTime - without.executionTime}ms`, 'info');

            log('analysis', `Bandas COM corre√ß√£o: ${with_.validBands}/${with_.totalBands}`, 'info');
            log('analysis', `Bandas SEM corre√ß√£o: ${without.validBands}/${without.totalBands}`, 'info');

            // An√°lise de consist√™ncia
            if (with_.score === without.score) {
                log('analysis', '‚úÖ SCORES ID√äNTICOS - Sistema determin√≠stico funcionando', 'success');
                log('analysis', 'üìã Isso confirma que a corre√ß√£o mant√©m consist√™ncia', 'success');
            } else {
                log('analysis', '‚ö†Ô∏è SCORES DIFERENTES - Poss√≠vel impacto da corre√ß√£o', 'warning');
                log('analysis', 'üîç Isso pode indicar que a corre√ß√£o est√° realmente impactando', 'warning');
            }
        }

        async function runFullDiagnosis() {
            log('diagnosis', 'ü©∫ Iniciando diagn√≥stico completo do sistema...', 'info');
            
            // Verificar componentes
            const components = [
                'window.AudioAnalyzer',
                'window.PipelineOrderCorrection',
                'window.PIPELINE_ORDER_CORRECTION_ENABLED',
                'window.AudioAnalyzerV2'
            ];

            components.forEach(comp => {
                try {
                    const value = eval(comp);
                    log('diagnosis', `${comp}: ${typeof value} ${value ? '‚úÖ' : '‚ùå'}`, value ? 'success' : 'error');
                } catch (e) {
                    log('diagnosis', `${comp}: ERRO - ${e.message}`, 'error');
                }
            });

            // Verificar configura√ß√£o atual
            try {
                if (window.PipelineOrderCorrection?.getCurrentConfig) {
                    const config = window.PipelineOrderCorrection.getCurrentConfig();
                    log('diagnosis', 'Configura√ß√£o pipeline: ' + JSON.stringify(config, null, 2), 'success');
                }
            } catch (e) {
                log('diagnosis', 'Erro ao verificar configura√ß√£o: ' + e.message, 'error');
            }

            // Verificar logs do console
            log('diagnosis', '=== RECOMENDA√á√ïES ===', 'info');
            if (testResults.withCorrection && testResults.withoutCorrection) {
                if (testResults.withCorrection.score === testResults.withoutCorrection.score) {
                    log('diagnosis', '‚úÖ Sistema funcionando corretamente - scores consistentes', 'success');
                    log('diagnosis', 'üìã A corre√ß√£o est√° ativa e mantendo determinismo', 'success');
                    log('diagnosis', 'üéØ Para ver diferen√ßas, teste com arquivos problem√°ticos', 'info');
                } else {
                    log('diagnosis', '‚ö†Ô∏è Diferen√ßas detectadas - corre√ß√£o impactando resultados', 'warning');
                    log('diagnosis', 'üîç Analise os logs detalhados para entender o impacto', 'warning');
                }
            } else {
                log('diagnosis', '‚ö†Ô∏è Execute os testes A/B para diagn√≥stico completo', 'warning');
            }
        }

        async function analyzeAudioFile(file, withCorrection) {
            return new Promise((resolve, reject) => {
                try {
                    // Simular an√°lise capturando logs do console
                    const originalLog = console.log;
                    const logs = [];
                    
                    console.log = (...args) => {
                        logs.push(args.join(' '));
                        originalLog.apply(console, args);
                    };

                    // Usar o AudioAnalyzer real
                    if (typeof window.AudioAnalyzer === 'undefined') {
                        throw new Error('AudioAnalyzer n√£o dispon√≠vel');
                    }

                    const analyzer = new window.AudioAnalyzer();
                    
                    analyzer.analyzeFile(file)
                        .then(result => {
                            console.log = originalLog;
                            
                            // Extrair informa√ß√µes dos logs
                            const pipelineLogs = logs.filter(log => 
                                log.includes('PIPELINE') || 
                                log.includes('spectral_bands') || 
                                log.includes('scoring')
                            );

                            const bandLogs = logs.filter(log => 
                                log.includes('bands') || 
                                log.includes('VALIDATION')
                            );

                            resolve({
                                score: result.qualityOverall || result.score || 0,
                                validBands: extractValidBands(bandLogs),
                                totalBands: extractTotalBands(bandLogs),
                                pipelineStages: pipelineLogs.length,
                                logs: pipelineLogs,
                                bandLogs: bandLogs,
                                fullResult: result
                            });
                        })
                        .catch(error => {
                            console.log = originalLog;
                            reject(error);
                        });

                } catch (error) {
                    reject(error);
                }
            });
        }

        function extractValidBands(logs) {
            for (const log of logs) {
                const match = log.match(/(\d+)\/(\d+) bands/);
                if (match) {
                    return parseInt(match[1]);
                }
            }
            return 0;
        }

        function extractTotalBands(logs) {
            for (const log of logs) {
                const match = log.match(/(\d+)\/(\d+) bands/);
                if (match) {
                    return parseInt(match[2]);
                }
            }
            return 0;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
        });
    </script>
</body>
</html>
