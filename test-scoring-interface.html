<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Novo Sistema Scoring</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .score-display {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .score-reference { background: #1b5e20; }
        .score-advanced { background: #1565c0; }
        .score-intermediate { background: #f57900; }
        .score-basic { background: #b71c1c; }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0052a3;
        }
        .metrics-display {
            font-family: monospace;
            font-size: 12px;
            background: #111;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üß™ Teste do Novo Sistema de Scoring</h1>
    <p>Este teste valida o novo sistema de scoring com pesos iguais e valores decimais.</p>

    <div class="test-section">
        <h3>üéØ Testes Autom√°ticos</h3>
        <button onclick="testPerfectMix()">Mix Perfeito</button>
        <button onclick="testSlightlyOffMix()">Mix Levemente Fora</button>
        <button onclick="testProblematicMix()">Mix Problem√°tico</button>
        <button onclick="testCustomMix()">Mix Customizado</button>
        
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h3>‚öñÔ∏è Demonstra√ß√£o de Pesos Iguais</h3>
        <div id="weightsDemo"></div>
    </div>

    <script src="lib/audio/features/scoring.js"></script>
    <script>
        // Fun√ß√£o para simular m√©tricas de teste
        function createTestMetrics(scenario) {
            const scenarios = {
                perfect: {
                    lufsIntegrated: -14.0,
                    truePeakDbtp: -1.0,
                    dr: 10.0,
                    lra: 7.0,
                    crestFactor: 10.0,
                    stereoCorrelation: 0.3,
                    stereoWidth: 0.6,
                    balanceLR: 0.0,
                    centroid: 2500,
                    spectralFlatness: 0.25,
                    rolloff85: 8000,
                    dcOffset: 0.0,
                    clippingPct: 0.0
                },
                slightly_off: {
                    lufsIntegrated: -12.5,
                    truePeakDbtp: -0.5,
                    dr: 8.0,
                    lra: 5.0,
                    crestFactor: 8.0,
                    stereoCorrelation: 0.1,
                    stereoWidth: 0.4,
                    balanceLR: 0.05,
                    centroid: 3000,
                    spectralFlatness: 0.3,
                    rolloff85: 9000,
                    dcOffset: 0.01,
                    clippingPct: 0.1
                },
                problematic: {
                    lufsIntegrated: -8.0,
                    truePeakDbtp: 0.5,
                    dr: 4.0,
                    lra: 2.0,
                    crestFactor: 4.0,
                    stereoCorrelation: -0.5,
                    stereoWidth: 0.1,
                    balanceLR: 0.3,
                    centroid: 5000,
                    spectralFlatness: 0.5,
                    rolloff85: 12000,
                    dcOffset: 0.05,
                    clippingPct: 2.0
                },
                custom: {
                    lufsIntegrated: -16.0,
                    truePeakDbtp: -2.0,
                    dr: 12.0,
                    lra: 8.0,
                    crestFactor: 11.0,
                    stereoCorrelation: 0.4,
                    stereoWidth: 0.7,
                    balanceLR: -0.02,
                    centroid: 2200,
                    spectralFlatness: 0.22,
                    rolloff85: 7500,
                    dcOffset: 0.005,
                    clippingPct: 0.02
                }
            };
            return scenarios[scenario] || scenarios.perfect;
        }

        function createTestReference() {
            return {
                lufs_target: -14,
                tol_lufs: 3.0,
                dr_target: 10,
                tol_dr: 5.0,
                lra_target: 7,
                tol_lra: 5.0,
                true_peak_target: -1,
                tol_true_peak: 2.5,
                stereo_target: 0.3,
                tol_stereo: 0.7
            };
        }

        function displayTestResult(scenario, metrics, score, classification) {
            const resultDiv = document.getElementById('testResults');
            const scoreClass = classification.toLowerCase().replace(' ', '-');
            
            resultDiv.innerHTML += `
                <div class="test-result">
                    <h4>${scenario.toUpperCase()}</h4>
                    <div class="score-display score-${scoreClass.includes('refer√™ncia') ? 'reference' : scoreClass.includes('avan√ßado') ? 'advanced' : scoreClass.includes('intermedi√°rio') ? 'intermediate' : 'basic'}">
                        Score: ${score}% - ${classification}
                    </div>
                    <div class="metrics-display">
                        ${Object.entries(metrics).map(([key, value]) => 
                            `${key}: ${typeof value === 'number' ? value.toFixed(2) : value}`
                        ).join('<br>')}
                    </div>
                </div>
            `;
        }

        function testScenario(scenario) {
            console.log(`üß™ Testando cen√°rio: ${scenario}`);
            
            const metrics = createTestMetrics(scenario);
            const reference = createTestReference();
            
            // Simular an√°lise completa
            const analysisData = {
                metrics: metrics,
                reference: reference,
                runId: `test-${Date.now()}`
            };
            
            try {
                // Usar fun√ß√£o do scoring.js se dispon√≠vel
                if (typeof window !== 'undefined' && window.AudioFeatures && window.AudioFeatures.scoring) {
                    const result = window.AudioFeatures.scoring._computeMixScoreInternal(analysisData);
                    displayTestResult(scenario, metrics, result.score, result.classification);
                    console.log(`‚úÖ ${scenario}: ${result.score}% (${result.classification})`);
                } else {
                    console.log(`‚ö†Ô∏è Sistema de scoring n√£o dispon√≠vel - usando c√°lculo manual`);
                    // Fallback para c√°lculo manual
                    const manualScore = calculateManualScore(metrics);
                    const classification = getClassification(manualScore);
                    displayTestResult(scenario, metrics, manualScore, classification);
                    console.log(`‚úÖ ${scenario}: ${manualScore}% (${classification})`);
                }
            } catch (error) {
                console.error(`‚ùå Erro no teste ${scenario}:`, error);
                const manualScore = calculateManualScore(metrics);
                const classification = getClassification(manualScore);
                displayTestResult(scenario, metrics, manualScore, classification);
            }
        }

        function calculateManualScore(metrics) {
            // Implementa√ß√£o do novo sistema equal_weight_v3
            const targets = {
                lufsIntegrated: -14, truePeakDbtp: -1, dr: 10, lra: 7, crestFactor: 10,
                stereoCorrelation: 0.3, stereoWidth: 0.6, balanceLR: 0, centroid: 2500,
                spectralFlatness: 0.25, rolloff85: 8000, dcOffset: 0, clippingPct: 0
            };
            
            const tolerances = {
                lufsIntegrated: 3.0, truePeakDbtp: 2.5, dr: 5.0, lra: 5.0, crestFactor: 5.0,
                stereoCorrelation: 0.7, stereoWidth: 0.3, balanceLR: 0.2, centroid: 1500,
                spectralFlatness: 0.2, rolloff85: 3000, dcOffset: 0.03, clippingPct: 0.5
            };
            
            let totalScore = 0;
            let metricCount = 0;
            
            for (const [key, value] of Object.entries(metrics)) {
                if (targets[key] !== undefined && tolerances[key] !== undefined) {
                    const target = targets[key];
                    const tolerance = tolerances[key];
                    const deviation = Math.abs(value - target);
                    const deviationRatio = deviation / tolerance;
                    
                    let metricScore = 100;
                    
                    if (deviationRatio > 0) {
                        if (deviationRatio <= 1) {
                            metricScore = 100;
                        } else if (deviationRatio <= 2) {
                            metricScore = 100 - (deviationRatio - 1) * 25;
                        } else if (deviationRatio <= 3) {
                            metricScore = 75 - (deviationRatio - 2) * 20;
                        } else {
                            metricScore = Math.max(30, 55 - (deviationRatio - 3) * 15);
                        }
                    }
                    
                    totalScore += metricScore;
                    metricCount++;
                }
            }
            
            const finalScore = metricCount > 0 ? totalScore / metricCount : 0;
            return parseFloat(finalScore.toFixed(1));
        }

        function getClassification(score) {
            if (score >= 85) return 'Refer√™ncia Mundial';
            if (score >= 70) return 'Avan√ßado';
            if (score >= 55) return 'Intermedi√°rio';
            return 'B√°sico';
        }

        function testPerfectMix() {
            document.getElementById('testResults').innerHTML = '';
            testScenario('perfect');
        }

        function testSlightlyOffMix() {
            document.getElementById('testResults').innerHTML = '';
            testScenario('slightly_off');
        }

        function testProblematicMix() {
            document.getElementById('testResults').innerHTML = '';
            testScenario('problematic');
        }

        function testCustomMix() {
            document.getElementById('testResults').innerHTML = '';
            testScenario('custom');
        }

        // Demonstra√ß√£o dos pesos iguais
        function showWeightsDemo() {
            const metrics = createTestMetrics('perfect');
            const metricKeys = Object.keys(metrics);
            const equalWeight = 100 / metricKeys.length;
            
            document.getElementById('weightsDemo').innerHTML = `
                <h4>üìä Distribui√ß√£o de Pesos</h4>
                <p><strong>Total de m√©tricas:</strong> ${metricKeys.length}</p>
                <p><strong>Peso por m√©trica:</strong> ${equalWeight.toFixed(2)}%</p>
                <p><strong>Soma total:</strong> ${(equalWeight * metricKeys.length).toFixed(1)}%</p>
                <div class="metrics-display">
                    ${metricKeys.map((key, index) => 
                        `${index + 1}. ${key}: ${equalWeight.toFixed(2)}%`
                    ).join('<br>')}
                </div>
                <p><strong>‚úÖ Confirmado:</strong> Cada m√©trica tem exatamente o mesmo peso no c√°lculo final!</p>
            `;
        }

        // Inicializar demonstra√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            showWeightsDemo();
            console.log('üß™ P√°gina de teste carregada. Use os bot√µes para testar diferentes cen√°rios.');
        });
    </script>
</body>
</html>
