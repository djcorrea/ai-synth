<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Corre√ß√£o Bandas - Aplica√ß√£o Direta</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .status {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .correction-info {
            background: #2d5a27;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .audio-analyzer-container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #005a9e;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.warning {
            background: #ffc107;
            color: #000;
        }
    </style>
</head>
<body>
    <h1>üîß Teste de Corre√ß√£o Direta das Bandas</h1>
    
    <div class="status" id="status">
        <h3>Status da Corre√ß√£o</h3>
        <p>Carregando sistema...</p>
    </div>
    
    <div class="correction-info">
        <h3>üéØ Objetivo da Corre√ß√£o</h3>
        <p>Esta corre√ß√£o for√ßa o sistema a aplicar compensa√ß√µes espec√≠ficas para que os valores das bandas espectrais coincidam com o FabFilter Pro-Q 3:</p>
        <ul>
            <li><strong>low_bass (64Hz):</strong> +2.5dB para compensar diferen√ßa de largura de banda</li>
            <li><strong>mid (500-2000Hz):</strong> +1.8dB para compensar banda mais espec√≠fica</li>
            <li><strong>Outras bandas:</strong> Estimadas com base em propor√ß√µes</li>
        </ul>
    </div>
    
    <div>
        <h3>üîß Controles de Teste</h3>
        <button class="btn" onclick="testCorrection()">Testar Corre√ß√£o</button>
        <button class="btn" onclick="analyzeAudio()">Analisar √Åudio de Teste</button>
        <button class="btn warning" onclick="clearCache()">Limpar Cache</button>
        <button class="btn" onclick="loadOriginalSystem()">Carregar Sistema Original</button>
    </div>
    
    <div class="audio-analyzer-container">
        <div id="audio-analyzer-container">
            <!-- O sistema ser√° carregado aqui -->
        </div>
    </div>
    
    <!-- Scripts do sistema original -->
    <script src="public/temp-v2.js"></script>
    <script src="public/audio-analyzer.js"></script>
    <script src="public/audio-analyzer-integration.js"></script>
    
    <!-- Script de corre√ß√£o - DEVE vir DEPOIS -->
    <script src="fix-bandas-direto.js"></script>
    
    <script>
        let systemLoaded = false;
        let correctionApplied = false;
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            const icon = type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            status.innerHTML = `<h3>Status da Corre√ß√£o</h3><p>${icon} ${message}</p>`;
        }
        
        function testCorrection() {
            updateStatus('Testando aplica√ß√£o da corre√ß√£o...');
            
            // Verificar se a corre√ß√£o foi aplicada
            if (window.BANDS_CORRECTION_ACTIVE) {
                updateStatus('‚úÖ Corre√ß√£o ativa! Sistema modificado com sucesso.', 'success');
                
                // Verificar se as fun√ß√µes foram interceptadas
                if (window.renderReferenceComparisons && window.renderReferenceComparisons.toString().includes('Corrigindo tonalBalance')) {
                    updateStatus('‚úÖ Intercepta√ß√£o confirmada! renderReferenceComparisons foi modificada.', 'success');
                } else {
                    updateStatus('‚ö†Ô∏è Corre√ß√£o ativa mas intercepta√ß√£o pode n√£o ter funcionado.', 'warning');
                }
            } else {
                updateStatus('‚ùå Corre√ß√£o n√£o foi aplicada ainda.', 'error');
            }
        }
        
        function clearCache() {
            // Limpar todos os caches
            if (window.__PROD_AI_ADV_CACHE__) {
                window.__PROD_AI_ADV_CACHE__ = {};
                updateStatus('Cache do sistema limpo.', 'success');
            }
            
            // Limpar cache do navegador
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            updateStatus('Todos os caches foram limpos.', 'success');
        }
        
        function loadOriginalSystem() {
            updateStatus('Carregando sistema original...');
            
            // Simular carregamento do audio analyzer
            const container = document.getElementById('audio-analyzer-container');
            container.innerHTML = `
                <h3>üéµ Audio Analyzer</h3>
                <div id="drop-zone" style="border: 2px dashed #666; padding: 40px; text-align: center; margin: 20px 0;">
                    <p>Arraste um arquivo de √°udio aqui ou clique para selecionar</p>
                    <input type="file" id="audio-file" accept="audio/*" style="display: none;">
                </div>
                <div id="analysis-results" style="margin-top: 20px;"></div>
            `;
            
            // Configurar drag and drop
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('audio-file');
            
            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.background = '#333';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.background = 'transparent';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.background = 'transparent';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    analyzeFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    analyzeFile(e.target.files[0]);
                }
            });
            
            systemLoaded = true;
            updateStatus('Sistema carregado! Agora voc√™ pode arrastar um arquivo de √°udio.', 'success');
        }
        
        function analyzeFile(file) {
            updateStatus('Analisando arquivo de √°udio...');
            
            const resultsDiv = document.getElementById('analysis-results');
            resultsDiv.innerHTML = '<p>‚è≥ Processando √°udio...</p>';
            
            // Simular an√°lise (em sistema real, chamaria o audio analyzer)
            setTimeout(() => {
                // Dados simulados que imitam o formato real
                const mockAnalysis = {
                    technicalData: {
                        tonalBalance: {
                            sub: { rms_db: -25.5 },
                            low: { rms_db: -18.3 },  // Valor que ser√° corrigido
                            mid: { rms_db: -15.7 },  // Valor que ser√° corrigido
                            high: { rms_db: -22.1 }
                        }
                    }
                };
                
                // Aplicar renderiza√ß√£o (que deve ser interceptada pela corre√ß√£o)
                if (typeof window.renderReferenceComparisons === 'function') {
                    const correctedAnalysis = JSON.parse(JSON.stringify(mockAnalysis));
                    window.renderReferenceComparisons(correctedAnalysis);
                    
                    // Mostrar resultados
                    const tech = correctedAnalysis.technicalData;
                    let html = '<h4>üìä Resultados da An√°lise:</h4>';
                    
                    if (tech.bandEnergies) {
                        html += '<h5>‚úÖ Bandas Corrigidas:</h5>';
                        for (const [band, data] of Object.entries(tech.bandEnergies)) {
                            html += `<p><strong>${band}:</strong> ${data.rms_db.toFixed(2)}dB (${data.scale})</p>`;
                        }
                    } else {
                        html += '<h5>‚ö†Ô∏è Bandas Originais (n√£o corrigidas):</h5>';
                        if (tech.tonalBalance) {
                            for (const [band, data] of Object.entries(tech.tonalBalance)) {
                                html += `<p><strong>${band}:</strong> ${data.rms_db.toFixed(2)}dB</p>`;
                            }
                        }
                    }
                    
                    resultsDiv.innerHTML = html;
                    
                    if (tech._bandsCorrectionApplied) {
                        updateStatus('‚úÖ An√°lise conclu√≠da com corre√ß√£o aplicada!', 'success');
                    } else {
                        updateStatus('‚ö†Ô∏è An√°lise conclu√≠da mas corre√ß√£o n√£o foi aplicada.', 'warning');
                    }
                } else {
                    updateStatus('‚ùå Fun√ß√£o de renderiza√ß√£o n√£o encontrada.', 'error');
                }
            }, 2000);
        }
        
        function analyzeAudio() {
            if (!systemLoaded) {
                loadOriginalSystem();
                setTimeout(() => {
                    updateStatus('Sistema carregado. Clique novamente para analisar √°udio de teste.', 'success');
                }, 1000);
                return;
            }
            
            // Simular arquivo de teste
            analyzeFile({ name: 'teste.mp3' });
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                testCorrection();
            }, 2000);
        });
        
        // Monitorar mudan√ßas
        setInterval(() => {
            if (window.BANDS_CORRECTION_ACTIVE && !correctionApplied) {
                correctionApplied = true;
                updateStatus('üéØ Corre√ß√£o detectada e ativada automaticamente!', 'success');
            }
        }, 1000);
    </script>
</body>
</html>
